<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MantraOS</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PWA Manifest & Themeing -->
  <meta name="theme-color" content="#667eea">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.svg">


  <script>
    // Custom Tailwind theme configuration
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Poppins', 'sans-serif'],
            'serif': ['Playfair Display', 'serif'],
          },
          colors: {
            'deep-purple': '#667eea',
            'gold': '#f6d365',
            'teal': '#4facfe',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-in-up': 'slideInUp 0.5s ease-in-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideInUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            }
          }
        }
      }
    }
  </script>
  
  <style>
    /* Basic styles for glassmorphism, theme transitions, and UI elements */
    :root {
      --font-family: 'Poppins', sans-serif;
    }
    html {
        font-family: var(--font-family);
    }
    body {
      transition: background 0.5s ease-in-out;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark .glass-card {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .theme-gradient-1 { background-image: linear-gradient(to top right, #667eea, #764ba2); }
    .theme-gradient-2 { background-image: linear-gradient(to top right, #f6d365, #fda085); }
    .theme-gradient-3 { background-image: linear-gradient(to top right, #4facfe, #00f2fe); }
    .theme-gradient-4 { background-image: linear-gradient(to top right, #434343, #000000); }

    /* Page transition styles */
    .page-enter {
        opacity: 0;
        transform: translateX(100%);
    }
    .page-enter-active {
        opacity: 1;
        transform: translateX(0);
        transition: opacity 300ms, transform 300ms;
    }
    .page-exit {
        opacity: 1;
        transform: translateX(0);
    }
    .page-exit-active {
        opacity: 0;
        transform: translateX(-100%);
        transition: opacity 300ms, transform 300ms;
    }
    
    /* Simple CSS bar chart for progress */
    .bar-chart-bar {
        transition: height 0.3s ease-out;
    }
  </style>

</head>
<body class="antialiased">
  <div id="root"></div>

  <script type="module">
    // --- ICONS (Lucide via esm.sh as self-contained functions) ---
    const createIcon = (iconName, svgContent) => (props = {}) => {
        const { size = 24, color = 'currentColor', className = '' } = props;
        const element = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        element.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        element.setAttribute('width', size);
        element.setAttribute('height', size);
        element.setAttribute('viewBox', '0 0 24 24');
        element.setAttribute('fill', 'none');
        element.setAttribute('stroke', color);
        element.setAttribute('stroke-width', '2');
        element.setAttribute('stroke-linecap', 'round');
        element.setAttribute('stroke-linejoin', 'round');
        if(className) element.setAttribute('class', className);
        element.innerHTML = svgContent;
        return element.outerHTML;
    };

    const ICONS = {
        Zap: createIcon('Zap', '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>'),
        Layers: createIcon('Layers', '<polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline>'),
        Check: createIcon('Check', '<polyline points="20 6 9 17 4 12"></polyline>'),
        Edit: createIcon('Edit', '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>'),
        CheckCircle: createIcon('CheckCircle', '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'),
        PlusCircle: createIcon('PlusCircle', '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line>'),
        Home: createIcon('Home', '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>'),
        Library: createIcon('Library', '<path d="m16 6 4 14"></path><path d="M12 6v14"></path><path d="M8 8v12"></path><path d="M4 4v16"></path>'),
        BarChart2: createIcon('BarChart2', '<line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line>'),
        Settings: createIcon('Settings', '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle>'),
        Plus: createIcon('Plus', '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>'),
        Trash2: createIcon('Trash2', '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>'),
        Award: createIcon('Award', '<circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>'),
        Bell: createIcon('Bell', '<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path>'),
        Smile: createIcon('Smile', '<circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>'),
        ArrowLeft: createIcon('ArrowLeft', '<line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline>'),
        ArrowRight: createIcon('ArrowRight', '<line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>'),
        Search: createIcon('Search', '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>'),
        Download: createIcon('Download', '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>'),
        Upload: createIcon('Upload', '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>'),
    };

    // --- CONSTANTS ---
    const CATEGORIES = ['Money', 'Health', 'Relationships', 'Career', 'Confidence'];
    const PRIORITIES = { Low: 'bg-sky-500', Medium: 'bg-yellow-500', High: 'bg-rose-500' };
    const PRIORITY_LEVELS = ['Low', 'Medium', 'High'];
    const CURATED_MANTRAS = [
      { id: 'm1', text: 'Money flows to me easily, frequently, and abundantly.', category: 'Money' }, { id: 'm2', text: 'I am a magnet for financial prosperity and wealth.', category: 'Money' }, { id: 'm3', text: 'Wealth constantly circulates in my life.', category: 'Money' }, { id: 'm4', text: 'I am worthy of building and receiving massive wealth.', category: 'Money' }, { id: 'm5', text: 'My income is constantly increasing.', category: 'Money' },
      { id: 'h1', text: 'My body is a magnificent vessel of health and vitality.', category: 'Health' }, { id: 'h2', text: 'I choose vibrant health and boundless energy.', category: 'Health' }, { id: 'h3', text: 'My body heals itself quickly and easily.', category: 'Health' }, { id: 'h4', text: 'I nourish my body with healthy food and positive thoughts.', category: 'Health' }, { id: 'h5', text: 'Every cell in my body is alive with energy.', category: 'Health' },
      { id: 'r1', text: 'I attract loving, supportive, and harmonious relationships.', category: 'Relationships' }, { id: 'r2', text: 'I communicate with clarity, honesty, and compassion.', category: 'Relationships' }, { id: 'r3', text: 'I give and receive love effortlessly and unconditionally.', category: 'Relationships' }, { id: 'r4', text: 'I am surrounded by people who love and respect me.', category: 'Relationships' }, { id: 'r5', text: 'My heart is open to meaningful connections.', category: 'Relationships' },
      { id: 'cr1', text: 'Amazing career opportunities find their way to me.', category: 'Career' }, { id: 'cr2', text: 'My work makes a positive impact and inspires others.', category: 'Career' }, { id: 'cr3', text: 'I am valued and respected for my unique talents.', category: 'Career' }, { id: 'cr4', text: 'I am confident in my abilities and excel in my profession.', category: 'Career' }, { id: 'cr5', text: 'I am on the perfect path for my career success.', category: 'Career' },
      { id: 'c1', text: 'I am enough, just as I am.', category: 'Confidence' }, { id: 'c2', text: 'My voice is valuable and my opinion matters.', category: 'Confidence' }, { id: 'c3', text: 'I embrace challenges as opportunities to grow stronger.', category: 'Confidence' }, { id: 'c4', text: 'I am confident, capable, and in control of my life.', category: 'Confidence' }, { id: 'c5', text: 'I release all self-doubt and welcome self-love.', category: 'Confidence' },
    ];
    const THEME_OPTIONS = [
        { id: 'theme-gradient-1', name: 'Cosmic Cobalt', gradient: 'linear-gradient(to top right, #667eea, #764ba2)' }, { id: 'theme-gradient-2', name: 'Sunset Flare', gradient: 'linear-gradient(to top right, #f6d365, #fda085)' }, { id: 'theme-gradient-3', name: 'Aqua Marine', gradient: 'linear-gradient(to top right, #4facfe, #00f2fe)' }, { id: 'theme-gradient-4', name: 'Midnight Onyx', gradient: 'linear-gradient(to top right, #434343, #000000)' },
    ];
    const FONT_OPTIONS = [ { id: 'font-sans', name: 'Poppins (Modern)'}, { id: 'font-serif', name: 'Playfair (Elegant)'},];
    const INITIAL_ACHIEVEMENTS = [
        { id: 'first_view', title: 'First Step', description: 'View your first mantra.', unlocked: false }, { id: '7_day_streak', title: 'Consistent Mind', description: 'View mantras for 7 days in a row.', unlocked: false }, { id: '3_mantras', title: 'Trio of Power', description: 'Select at least 3 mantras.', unlocked: false }, { id: 'custom_mantra', title: 'Your Own Voice', description: 'Create your first custom mantra.', unlocked: false }, { id: '100_views', title: 'Mantra Master', description: 'View mantras 100 times in total.', unlocked: false },
    ];

    // --- STATE MANAGEMENT ---
    let deferredInstallPrompt = null;
    let calendarViewDate = new Date(); // For stateful calendar navigation
    let myMantrasSortOrder = 'date-desc'; // For sorting 'My Mantras' view

    const defaultSettings = {
        theme: 'theme-gradient-1', font: 'font-sans', isDarkMode: false,
        notifications: {
            mantras: {
                enabled: false,
                morning: { enabled: true, time: '08:00' },
                afternoon: { enabled: true, time: '13:00' },
                evening: { enabled: false, time: '19:00' }
            },
            affirmation: { enabled: false, time: '09:00' }
        },
    };

    let state = {
      userMantras: [],
      userAffirmations: [],
      settings: JSON.parse(JSON.stringify(defaultSettings)), // Deep copy
      progress: {},
      isOnboardingComplete: false,
      achievements: INITIAL_ACHIEVEMENTS,
      currentMantraIndex: 0,
      onboardingTempMantras: [],
      dailyAffirmation: null,
    };

    const storageKeys = {
        mantras: 'mantraos_user_mantras',
        affirmations: 'mantraos_user_affirmations',
        settings: 'mantraos_settings',
        progress: 'mantraos_progress',
        onboarding: 'mantraos_onboarding_complete',
        achievements: 'mantraos_achievements',
        dailyAffirmation: 'mantraos_daily_affirmation',
        onboardingTempMantras: 'mantraos_onboarding_temp_mantras',
    };

    function saveState() {
        try {
            localStorage.setItem(storageKeys.mantras, JSON.stringify(state.userMantras));
            localStorage.setItem(storageKeys.affirmations, JSON.stringify(state.userAffirmations));
            localStorage.setItem(storageKeys.settings, JSON.stringify(state.settings));
            localStorage.setItem(storageKeys.progress, JSON.stringify(state.progress));
            localStorage.setItem(storageKeys.onboarding, JSON.stringify(state.isOnboardingComplete));
            localStorage.setItem(storageKeys.achievements, JSON.stringify(state.achievements));
            localStorage.setItem(storageKeys.dailyAffirmation, JSON.stringify(state.dailyAffirmation));
            localStorage.setItem(storageKeys.onboardingTempMantras, JSON.stringify(state.onboardingTempMantras));
        } catch (error) {
            console.error("Failed to save state to localStorage:", error);
        }
    }

    function loadState() {
        try {
            // Mantra loading with migration for priority and creation date
            const loadedMantras = JSON.parse(localStorage.getItem(storageKeys.mantras)) || [];
            state.userMantras = loadedMantras.map((m, index) => ({ 
                ...m, 
                priority: m.priority || 'Medium',
                // Stagger timestamps for old data to provide a default sort order
                createdAt: m.createdAt || (Date.now() - (loadedMantras.length - index) * 60000)
            }));


            state.userAffirmations = JSON.parse(localStorage.getItem(storageKeys.affirmations)) || [];
            
            // Settings loading with migration for old notification structure
            let loadedSettings = JSON.parse(localStorage.getItem(storageKeys.settings)) || {};

            if (loadedSettings.notifications && typeof loadedSettings.notifications.enabled === 'boolean') {
                const oldNotifs = loadedSettings.notifications;
                loadedSettings.notifications = {
                    mantras: {
                        enabled: oldNotifs.enabled,
                        morning: { enabled: !!oldNotifs.morning, time: '08:00' },
                        afternoon: { enabled: !!oldNotifs.afternoon, time: '13:00' },
                        evening: { enabled: !!oldNotifs.evening, time: '19:00' },
                    },
                    affirmation: { enabled: false, time: '09:00' }
                };
            }

            // Deep merge to ensure new settings keys are added
            const deepMerge = (target, source) => {
                const output = { ...target };
                if (target && typeof target === 'object' && source && typeof source === 'object') {
                    Object.keys(source).forEach(key => {
                        if (source[key] && typeof source[key] === 'object') {
                            if (!(key in target))
                                Object.assign(output, { [key]: source[key] });
                            else
                                output[key] = deepMerge(target[key], source[key]);
                        } else {
                            Object.assign(output, { [key]: source[key] });
                        }
                    });
                }
                return output;
            };
            
            state.settings = deepMerge(defaultSettings, loadedSettings);

            state.progress = JSON.parse(localStorage.getItem(storageKeys.progress)) || {};
            state.isOnboardingComplete = JSON.parse(localStorage.getItem(storageKeys.onboarding)) || false;
            state.achievements = JSON.parse(localStorage.getItem(storageKeys.achievements)) || INITIAL_ACHIEVEMENTS;
            state.dailyAffirmation = JSON.parse(localStorage.getItem(storageKeys.dailyAffirmation)) || null;
            state.onboardingTempMantras = JSON.parse(localStorage.getItem(storageKeys.onboardingTempMantras)) || [];
            
        } catch (error) {
            console.error("Failed to load state from localStorage:", error);
        }
    }

    // --- DOM & UTILS ---
    const root = document.getElementById('root');
    const hapticFeedback = () => navigator.vibrate && navigator.vibrate(50);

    // --- APP LOGIC ---
    const addMantra = (mantra) => {
        if (!state.userMantras.find(m => m.id === mantra.id)) {
            // Ensure every added mantra has a creation timestamp.
            const mantraToAdd = { ...mantra, createdAt: mantra.createdAt || Date.now() };
            state.userMantras.push(mantraToAdd);
            saveState();
        }
    };
    const removeMantra = (mantraId) => {
        state.userMantras = state.userMantras.filter(m => m.id !== mantraId);
        saveState();
    };
    const addAffirmation = (text) => {
        const newAffirmation = { id: `affirm-${Date.now()}`, text };
        state.userAffirmations.push(newAffirmation);
        saveState();
    };
    const removeAffirmation = (affirmationId) => {
        state.userAffirmations = state.userAffirmations.filter(a => a.id !== affirmationId);
        saveState();
    };
    const unlockAchievement = (id) => {
        const achievement = state.achievements.find(a => a.id === id);
        if (achievement && !achievement.unlocked) {
            achievement.unlocked = true;
            saveState();
            // Optionally show a notification
        }
    };
    const recordMantraView = (mantraId) => {
        if (!mantraId) return;
        const d = new Date();
        const today = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

        if (!state.progress[mantraId]) {
            state.progress[mantraId] = { views: 0, lastViewed: '' };
        }
        state.progress[mantraId].views += 1;
        state.progress[mantraId].lastViewed = today;
        unlockAchievement('first_view');
        const totalViews = getTotalViews();
        if (totalViews >= 100) unlockAchievement('100_views');
        if (getStreak() >= 7) unlockAchievement('7_day_streak');
        saveState();
    };
    const getTotalViews = () => Object.values(state.progress).reduce((total, p) => total + p.views, 0);
    const getStreak = () => {
        const dates = [...new Set(Object.values(state.progress).map(p => p.lastViewed).filter(d => d))].sort();
        if (dates.length === 0) return 0;
        
        let streak = 0;
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);

        const formatDate = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        
        const todayStr = formatDate(today);
        const yesterdayStr = formatDate(yesterday);
        
        const parseDate = (str) => {
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
        };

        if (dates[dates.length - 1] === todayStr || dates[dates.length - 1] === yesterdayStr) {
            streak = 1;
            for (let i = dates.length - 1; i > 0; i--) {
                const currentDate = parseDate(dates[i]);
                const prevDate = parseDate(dates[i - 1]);
                const diff = (currentDate.getTime() - prevDate.getTime()) / (1000 * 3600 * 24);
                if (diff === 1) {
                    streak++;
                } else {
                    break;
                }
            }
        }
        return streak;
    };
    const getLongestStreak = () => {
        const dates = [...new Set(Object.values(state.progress).map(p => p.lastViewed).filter(d => d))].sort();
        if (dates.length <= 1) return dates.length;

        let longestStreak = 1;
        let currentStreak = 1;
        
        const parseDate = (str) => {
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
        };

        for (let i = 1; i < dates.length; i++) {
            const currentDate = parseDate(dates[i]);
            const prevDate = parseDate(dates[i - 1]);
            const diff = (currentDate.getTime() - prevDate.getTime()) / (1000 * 3600 * 24);

            if (diff === 1) {
                currentStreak++;
            } else {
                currentStreak = 1;
            }
            longestStreak = Math.max(longestStreak, currentStreak);
        }
        return longestStreak;
    };
    const applySettings = () => {
        document.body.className = '';
        document.body.classList.add(state.settings.theme, 'antialiased', 'text-white', 'transition-colors', 'duration-500');
        document.documentElement.classList.toggle('dark', state.settings.isDarkMode);
        document.documentElement.style.setProperty('--font-family', state.settings.font === 'font-sans' ? "'Poppins', sans-serif" : "'Playfair Display', serif");
    };
    const exportUserData = () => {
        try {
            const backupData = {
                userMantras: state.userMantras,
                userAffirmations: state.userAffirmations,
                settings: state.settings,
                progress: state.progress,
                isOnboardingComplete: state.isOnboardingComplete,
                achievements: state.achievements,
                dailyAffirmation: state.dailyAffirmation,
            };
            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().slice(0, 10);
            link.download = `mantraos_backup_${timestamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Data exported successfully!');
        } catch (error) {
            console.error('Failed to export data:', error);
            alert('An error occurred while exporting your data.');
        }
    };


    // --- TEMPLATING / RENDERING ---
    const renderButton = (text, { variant = 'primary', additionalClasses = '', attributes = '' } = {}) => {
      const baseClasses = 'px-6 py-3 font-semibold rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-transparent disabled:opacity-50 disabled:cursor-not-allowed';
      const variantClasses = {
        primary: 'bg-white text-deep-purple hover:bg-opacity-90 focus:ring-white',
        secondary: 'bg-white/20 text-white hover:bg-white/30 focus:ring-white',
        ghost: 'bg-transparent text-white hover:bg-white/10 focus:ring-white',
      };
      return `<button class="${baseClasses} ${variantClasses[variant]} ${additionalClasses}" ${attributes}>${text}</button>`;
    }
    
    const renderModal = (title, content, onclose) => {
        const modalHTML = `
            <div id="app-modal" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 animate-fade-in">
                <div class="glass-card w-full max-w-sm rounded-2xl p-6 text-center animate-slide-in-up">
                    <h2 class="text-2xl font-serif mb-4">${title}</h2>
                    <div class="text-white/80 mb-6">${content}</div>
                    ${renderButton('Got it!', { attributes: 'data-action="close-modal"' })}
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        const closeModal = () => {
            document.getElementById('app-modal')?.remove();
            if (onclose) onclose();
        };

        const modalElement = document.getElementById('app-modal');
        modalElement.querySelector('[data-action="close-modal"]').addEventListener('click', closeModal);
        modalElement.addEventListener('click', (e) => { if(e.target === modalElement) closeModal(); });
    };

    const renderConfirmationModal = (title, content, onConfirm, options = {}) => {
        const { confirmText = 'Confirm', confirmVariant = 'primary' } = options;
        const modalId = 'app-confirmation-modal';
        document.getElementById(modalId)?.remove();

        const confirmButtonClasses = {
            primary: '',
            destructive: '!bg-rose-600 hover:!bg-rose-700 focus:ring-rose-500 !text-white'
        };
        const titleClasses = {
            primary: '',
            destructive: 'text-rose-400'
        };

        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 animate-fade-in">
                <div class="glass-card w-full max-w-sm rounded-2xl p-6 text-center animate-slide-in-up">
                    <h2 class="text-2xl font-serif mb-4 ${titleClasses[confirmVariant] || ''}">${title}</h2>
                    <div class="text-white/80 mb-6">${content}</div>
                    <div class="flex gap-4 justify-center">
                        ${renderButton('Cancel', { variant: 'secondary', additionalClasses: 'flex-1', attributes: 'data-action="close-confirm-modal"' })}
                        ${renderButton(confirmText, { variant: 'primary', additionalClasses: `flex-1 ${confirmButtonClasses[confirmVariant] || ''}`, attributes: 'data-action="confirm-modal-action"' })}
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        const modalElement = document.getElementById(modalId);
        
        const closeModal = () => modalElement?.remove();
        const confirmAction = () => {
            if (onConfirm) onConfirm();
            closeModal();
        };

        modalElement.querySelector('[data-action="close-confirm-modal"]').addEventListener('click', closeModal);
        modalElement.querySelector('[data-action="confirm-modal-action"]').addEventListener('click', confirmAction);
        modalElement.addEventListener('click', (e) => { if(e.target === modalElement) closeModal(); });
    };

    const renderPage = (content, { showBackButton = false } = {}) => {
        const isAppView = !window.location.hash.includes('onboarding');
        const backButtonHtml = showBackButton ? `
            <div class="mb-4">
                <button data-action="go-back" class="inline-flex items-center gap-2 p-2 pr-4 rounded-full bg-white/10 hover:bg-white/20 transition-colors" aria-label="Go back">
                    ${ICONS.ArrowLeft({ size: 20 })}
                    <span class="text-sm">Back</span>
                </button>
            </div>
        ` : '';

        const mainAppLayout = `
            <div class="relative min-h-screen ${isAppView ? 'pb-24' : ''}">
                <main class="p-4 md:p-6">${backButtonHtml}${content}</main>
                ${isAppView ? renderBottomNav() : ''}
            </div>
        `;
        root.innerHTML = mainAppLayout;
    };
    
    // --- ONBOARDING VIEWS ---
    const renderOnboarding = (step) => {
        let content = '';
        const backButton = (path) => `
            <div class="absolute top-4 left-4">
                <button data-action="nav" data-path="${path}" class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition-colors" aria-label="Go back">
                    ${ICONS.ArrowLeft({ size: 24 })}
                </button>
            </div>
        `;
        switch(step) {
            case 'welcome':
                content = `
                    <div class="text-center flex flex-col items-center animate-fade-in">
                        ${ICONS.Zap({ size: 64, className: "mb-4 text-gold" })}
                        <h1 class="text-4xl font-serif mb-4">Welcome to MantraOS</h1>
                        <p class="text-lg text-white/80 mb-8">Your personal space to cultivate positivity, focus, and inner strength.</p>
                        ${renderButton('Begin Your Journey', { attributes: 'data-action="nav" data-path="/onboarding/categories"'})}
                    </div>`;
                break;
            case 'categories':
                 content = `
                    ${backButton('/onboarding/welcome')}
                    <div class="text-center animate-fade-in">
                        ${ICONS.Layers({ size: 48, className: "mx-auto mb-4 text-teal" })}
                        <h2 class="text-3xl font-serif mb-4">Focus Your Intentions</h2>
                        <p class="text-white/80 mb-6">We'll start by selecting from key life areas to personalize your experience.</p>
                        <div class="flex flex-wrap justify-center gap-2 mb-8">${CATEGORIES.map(cat => `<span class="bg-white/20 px-3 py-1 rounded-full text-sm">${cat}</span>`).join('')}</div>
                        ${renderButton('Choose My Mantras', { attributes: 'data-action="nav" data-path="/onboarding/mantras"'})}
                    </div>`;
                break;
            case 'mantras':
                const selectionCount = state.onboardingTempMantras.length;
                const isNextDisabled = selectionCount < 3;
                let feedbackText;
                let feedbackColorClass = 'text-white/60'; // Default color

                if (selectionCount < 3) {
                    const remaining = 3 - selectionCount;
                    feedbackText = `Please select ${remaining} more mantra${remaining > 1 ? 's' : ''}.`;
                    feedbackColorClass = 'text-yellow-300';
                } else if (selectionCount >= 3 && selectionCount < 5) {
                    feedbackText = `Great! You can select up to ${5 - selectionCount} more or continue.`;
                    feedbackColorClass = 'text-teal-300';
                } else if (selectionCount === 5) {
                    feedbackText = `Maximum selected. You're ready to proceed!`;
                    feedbackColorClass = 'text-teal-300';
                } else {
                    // This case is currently unreachable due to the click handler logic
                    // but we'll leave it for robustness.
                    feedbackText = 'Select between 3 and 5 mantras.';
                    feedbackColorClass = 'text-red-400';
                }

                content = `
                    ${backButton('/onboarding/categories')}
                    <div class="text-center w-full max-w-md mx-auto animate-fade-in" id="mantra-selection-view">
                        <h2 class="text-3xl font-serif mb-2">Select 3-5 Core Mantras</h2>
                        <p class="text-white/80 mb-6">Choose affirmations that resonate with you.</p>
                        <div class="flex flex-wrap justify-center gap-2 mb-4">
                            ${CATEGORIES.map(cat => `<button class="px-3 py-1 text-sm rounded-full transition-colors bg-white/20 text-white" data-action="filter-mantras" data-category="${cat}">${cat}</button>`).join('')}
                        </div>
                        <div class="h-64 overflow-y-auto pr-2 space-y-3 mb-6" id="mantra-list"></div>
                        ${renderButton(`Next (${selectionCount} selected)`, { attributes: `data-action="nav" data-path="/onboarding/custom" ${isNextDisabled ? 'disabled' : ''}`})}
                        <p class="text-sm mt-2 font-medium transition-colors ${feedbackColorClass}">${feedbackText}</p>
                    </div>`;
                break;
            case 'custom':
                 content = `
                    ${backButton('/onboarding/mantras')}
                    <div class="text-center max-w-md mx-auto animate-fade-in">
                        ${ICONS.Edit({ size: 48, className: "mx-auto mb-4 text-gold" })}
                        <h2 class="text-3xl font-serif mb-4">Add Your Own Voice</h2>
                        <p class="text-white/80 mb-6">Create mantras that are uniquely meaningful to you.</p>
                        <div class="space-y-4 mb-8">
                            <textarea id="custom-mantra-text" placeholder="e.g., I am a creative powerhouse." class="w-full h-24 p-3 bg-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white"></textarea>
                            <select id="custom-mantra-category" class="w-full p-3 bg-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white">
                                ${CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                            <select id="custom-mantra-priority" class="w-full p-3 bg-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white">
                                <option value="Medium">Medium Priority</option>
                                <option value="High">High Priority</option>
                                <option value="Low">Low Priority</option>
                            </select>
                            ${renderButton('Add Custom Mantra', { variant: 'secondary', attributes: 'data-action="add-custom-onboarding"'})}
                        </div>
                        ${renderButton('Continue', { attributes: 'data-action="nav" data-path="/onboarding/final"'})}
                    </div>`;
                break;
            case 'final':
                content = `
                    ${backButton('/onboarding/custom')}
                    <div class="text-center animate-fade-in">
                        ${ICONS.CheckCircle({ size: 64, className: "mx-auto mb-4 text-teal" })}
                        <h2 class="text-4xl font-serif mb-4">You're All Set!</h2>
                        <p class="text-lg text-white/80 mb-8">Your personalized MantraOS is ready. Begin your journey.</p>
                        ${renderButton('Enter MantraOS', { additionalClasses: 'animate-pulse', attributes: 'data-action="finish-onboarding"'})}
                    </div>`;
                break;
        }
        root.innerHTML = `<div class="min-h-screen w-full flex flex-col items-center justify-center p-4 theme-gradient-1 text-white relative">${content}</div>`;
        if (step === 'mantras') renderMantraSelectionList(CATEGORIES[0]);
    };

    function renderMantraSelectionList(category) {
        const container = document.getElementById('mantra-list');
        if (!container) return;
        const mantras = CURATED_MANTRAS.filter(m => m.category === category);
        container.innerHTML = mantras.map(mantra => {
            const isSelected = state.onboardingTempMantras.some(m => m.id === mantra.id);
            return `
                <div class="glass-card text-left p-4 cursor-pointer border-2 ${isSelected ? 'border-teal' : 'border-transparent'}" data-action="toggle-onboarding-mantra" data-mantra-id='${mantra.id}'>
                    <div class="flex items-center justify-between">
                        <p class="pointer-events-none">"${mantra.text}"</p>
                        ${isSelected ? ICONS.Check({ className: 'text-teal pointer-events-none', size: 20 }) : ''}
                    </div>
                </div>`;
        }).join('');
        // Highlight active category button
        document.querySelectorAll('[data-action="filter-mantras"]').forEach(btn => {
            btn.classList.toggle('bg-white', btn.dataset.category === category);
            btn.classList.toggle('text-deep-purple', btn.dataset.category === category);
            btn.classList.toggle('font-semibold', btn.dataset.category === category);
            btn.classList.toggle('bg-white/20', btn.dataset.category !== category);
        });
    }

    // --- MAIN APP VIEWS ---
    const renderBottomNav = () => {
        const navItems = [
          { path: '/dashboard', label: 'Home', icon: ICONS.Home },
          { path: '/affirmations', label: 'Affirm', icon: ICONS.Smile },
          { path: '/library', label: 'Library', icon: ICONS.Library },
          { path: '/progress', label: 'Progress', icon: ICONS.BarChart2 },
          { path: '/settings', label: 'Settings', icon: ICONS.Settings },
        ];
        const currentPath = window.location.hash.slice(1) || '/dashboard';
        return `
            <nav class="fixed bottom-0 left-0 right-0 h-20 glass-card rounded-t-3xl shadow-lg z-50">
                <div class="flex justify-around items-center h-full max-w-lg mx-auto">
                ${navItems.map(({ path, label, icon }) => {
                    const isActive = currentPath.startsWith(path);
                    return `
                    <a href="#${path}" aria-label="${label}" class="flex flex-col items-center justify-center w-16 h-16 rounded-2xl transition-all duration-300 ${isActive ? 'bg-white/20 scale-110' : 'text-white/70 hover:bg-white/10'}">
                        ${icon({ size: 24 })}
                        <span class="text-xs mt-1">${label}</span>
                    </a>`
                }).join('')}
                </div>
            </nav>
        `;
    };

    const renderDashboard = () => {
        // --- Daily Affirmation Logic ---
        const checkAndShowAffirmation = () => {
            const { affirmation } = state.settings.notifications;
            if (!affirmation.enabled || state.userAffirmations.length === 0) return;

            const today = new Date().toISOString().split('T')[0];
            
            if (!state.dailyAffirmation || state.dailyAffirmation.date !== today) {
                const randomAffirmation = state.userAffirmations[Math.floor(Math.random() * state.userAffirmations.length)];
                state.dailyAffirmation = { text: randomAffirmation.text, date: today, seen: false };
                saveState();
            }
            
            if (state.dailyAffirmation && !state.dailyAffirmation.seen) {
                const [hour, minute] = affirmation.time.split(':');
                const scheduledTime = new Date();
                scheduledTime.setHours(hour, minute, 0, 0);
                
                if (new Date() >= scheduledTime) {
                    renderModal('Your Daily Affirmation', `<p class="text-xl italic">"${state.dailyAffirmation.text}"</p>`, () => {
                        state.dailyAffirmation.seen = true;
                        saveState();
                        renderDashboard(); // Re-render to show affirmation on dash
                    });
                }
            }
        };
        checkAndShowAffirmation();

        let showAffirmationOnDash = false;
        if (state.dailyAffirmation) {
            const { affirmation } = state.settings.notifications;
            if (affirmation.enabled) {
                if (state.dailyAffirmation.seen) showAffirmationOnDash = true;
            } else {
                showAffirmationOnDash = true;
            }
        }
        
        const dailyAffirmationHtml = (showAffirmationOnDash && state.dailyAffirmation) ? `
            <div class="my-4 text-center animate-slide-in-up">
                <p class="text-sm font-semibold uppercase tracking-wider text-white/70 mb-1">Your Daily Affirmation</p>
                <p class="text-lg italic font-sans">"${state.dailyAffirmation.text}"</p>
            </div>
        ` : '';
        // --- End Affirmation Logic ---
        
        let content;
        if (state.userMantras.length === 0) {
            content = `
                <div class="flex flex-col items-center justify-center h-[calc(100vh-10rem)] text-center animate-fade-in">
                    ${dailyAffirmationHtml}
                    <h2 class="text-2xl font-serif mb-4">Your mantra space is empty.</h2>
                    <p class="mb-6 text-white/80">Add some mantras from the library to get started!</p>
                    <a href="#/library">${renderButton(`${ICONS.PlusCircle({className: 'inline-block mr-2', size: 20})} Go to Library`)}</a>
                </div>
            `;
        } else {
            const currentMantra = state.userMantras[state.currentMantraIndex];
            recordMantraView(currentMantra.id);
            
            const streak = getStreak();
            const streakIcon = streak > 0 ? ICONS.Zap({ size: 16, className: 'inline-block text-gold -mt-1 mr-1' }) : '';
            const priorityColor = PRIORITIES[currentMantra?.priority] || PRIORITIES['Medium'];
            
            content = `
                <div class="flex flex-col h-[calc(100vh-8rem)] justify-between">
                  <div class="flex justify-around text-center glass-card p-3 rounded-full animate-fade-in">
                    <div><p class="text-sm text-white/70">Total Views</p><p class="font-bold text-lg">${getTotalViews()}</p></div>
                    <div><p class="text-sm text-white/70">Current Streak</p><p class="font-bold text-lg">${streakIcon}${streak} days</p></div>
                    <div><p class="text-sm text-white/70">Views Today</p><p class="font-bold text-lg">${state.progress[currentMantra?.id]?.views || 0}</p></div>
                  </div>
                  
                  ${dailyAffirmationHtml}

                  <div id="swipe-area" class="flex-grow flex items-center justify-center relative overflow-hidden">
                    <p id="mantra-text" class="text-4xl md:text-6xl font-serif text-center leading-tight animate-fade-in">"${currentMantra?.text}"</p>
                  </div>
                  <div class="text-center animate-fade-in">
                    <p class="bg-white/20 inline-flex items-center px-3 py-1 rounded-full text-sm mb-4">
                        <span class="w-2.5 h-2.5 ${priorityColor} rounded-full mr-2"></span>
                        ${currentMantra?.category}
                    </p>
                    <div class="flex justify-center mt-4 space-x-2" id="dot-indicators">
                        ${state.userMantras.map((_, index) => `<button data-action="set-mantra-index" data-index="${index}" class="w-2 h-2 rounded-full transition-colors ${state.currentMantraIndex === index ? 'bg-white' : 'bg-white/30'}"></button>`).join('')}
                    </div>
                  </div>
                </div>`;
        }
        renderPage(content);
        if (state.userMantras.length > 0) {
            setupSwipeListeners();
        }
    };

    const renderAffirmations = () => {
        let content;
        if (state.userAffirmations.length === 0) {
            content = `
                <div class="flex flex-col items-center justify-center h-[calc(100vh-10rem)] text-center animate-fade-in">
                    <h2 class="text-2xl font-serif mb-4">No affirmations yet.</h2>
                    <p class="mb-6 text-white/80">Visit the library to add your first daily affirmation.</p>
                    <a href="#/library">${renderButton(`${ICONS.PlusCircle({className: 'inline-block mr-2', size: 20})} Add Affirmation`)}</a>
                </div>
            `;
        } else {
            const randomAffirmation = state.userAffirmations[Math.floor(Math.random() * state.userAffirmations.length)];
            content = `
                <div class="flex flex-col h-[calc(100vh-12rem)] items-center justify-center text-center animate-fade-in">
                    <h1 class="text-2xl font-serif mb-8 text-white/80">Today's Affirmation</h1>
                    <p class="text-4xl md:text-5xl font-serif leading-tight">"${randomAffirmation.text}"</p>
                </div>
            `;
        }
        renderPage(content, { showBackButton: true });
    };

    const renderLibrary = () => {
        const content = `
            <div class="animate-fade-in" id="library-view">
                <h1 class="text-4xl font-serif text-center mb-6">Library</h1>
                <div class="flex justify-center mb-6 border-b-2 border-white/20">
                    <button data-action="library-tab" data-tab="curated" class="px-4 py-2 transition-colors text-white border-b-2 border-teal">Discover</button>
                    <button data-action="library-tab" data-tab="my-mantras" class="px-4 py-2 transition-colors text-white/60 border-b-2 border-transparent">My Mantras (${state.userMantras.length})</button>
                    <button data-action="library-tab" data-tab="my-affirmations" class="px-4 py-2 transition-colors text-white/60 border-b-2 border-transparent">My Affirmations (${state.userAffirmations.length})</button>
                </div>
                <div id="library-content"></div>
            </div>`;
        renderPage(content, { showBackButton: true });
        renderLibraryContent('curated');
    };
    
    const renderLibraryContent = (tab, options = {}) => {
        const { category = CATEGORIES[0], searchTerm = '', priorityFilter = 'All' } = options;
        const container = document.getElementById('library-content');
        if (!container) return;
        
        let content = '';
        if (tab === 'curated') {
            let mantras = CURATED_MANTRAS.filter(m => m.category === category);
            if (searchTerm.trim()) {
                mantras = mantras.filter(m => m.text.toLowerCase().includes(searchTerm.trim().toLowerCase()));
            }

            content = `
                <div class="relative mb-4">
                    <input type="search" id="mantra-search-input" value="${searchTerm}" placeholder="Search in ${category}..." class="w-full bg-white/10 rounded-full py-2 pl-10 pr-4 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-white/50">
                        ${ICONS.Search({ size: 20 })}
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-2 mb-4">
                    ${CATEGORIES.map(cat => `<button data-action="library-filter" data-category="${cat}" class="px-3 py-1 text-sm rounded-full transition-colors ${category === cat ? 'bg-white text-deep-purple font-semibold' : 'bg-white/20 text-white'}">${cat}</button>`).join('')}
                </div>
                <div class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                ${mantras.length > 0 ? mantras.map(mantra => {
                    const isAdded = state.userMantras.some(m => m.id === mantra.id);
                    return `
                    <div class="glass-card p-4 flex justify-between items-center">
                        <p class="flex-grow">"${mantra.text}"</p>
                        <button data-action="toggle-library-mantra" data-mantra-id='${mantra.id}' class="ml-4 p-2 rounded-full transition-colors ${isAdded ? 'bg-teal text-white' : 'bg-white/20 hover:bg-white/30'}" aria-label="${isAdded ? 'Remove' : 'Add'}">
                            ${isAdded ? ICONS.Check({ size: 16 }) : ICONS.Plus({ size: 16 })}
                        </button>
                    </div>`;
                }).join('') : `<div class="text-center p-8"><p class="text-white/80">No mantras found for your search.</p></div>`}
                </div>
            `;
        } else if (tab === 'my-mantras') {
            if (state.userMantras.length === 0) {
                content = `<div class="text-center p-8"><p class="text-white/80">You haven't added any mantras yet. Explore the 'Discover' tab!</p></div>`;
            } else {
                const priorityButtons = ['All', ...PRIORITY_LEVELS].map(p => {
                    const isActive = priorityFilter === p;
                    return `<button data-action="library-priority-filter" data-priority="${p}" class="px-3 py-1 text-sm rounded-full transition-colors ${isActive ? 'bg-white text-deep-purple font-semibold' : 'bg-white/20 text-white'}">${p}</button>`;
                }).join('');

                const filteredMantras = priorityFilter === 'All'
                    ? state.userMantras
                    : state.userMantras.filter(m => m.priority === priorityFilter);

                const priorityValues = { 'High': 3, 'Medium': 2, 'Low': 1 };
                const sortedMantras = [...filteredMantras].sort((a, b) => {
                    switch (myMantrasSortOrder) {
                        case 'date-asc':
                            return (a.createdAt || 0) - (b.createdAt || 0);
                        case 'priority-desc':
                            return (priorityValues[b.priority] || 0) - (priorityValues[a.priority] || 0);
                        case 'priority-asc':
                            return (priorityValues[a.priority] || 0) - (priorityValues[b.priority] || 0);
                        case 'date-desc':
                        default:
                            return (b.createdAt || 0) - (a.createdAt || 0);
                    }
                });

                content = `
                    <div class="flex flex-wrap justify-center gap-2 mb-4">
                        ${priorityButtons}
                    </div>
                    <div class="flex justify-center items-center mb-4">
                        <label for="mantra-sort-select" class="text-sm text-white/70 mr-2">Sort by:</label>
                        <select id="mantra-sort-select" data-action="set-mantra-sort" class="bg-white/10 rounded-md py-1 px-2 text-white focus:outline-none focus:ring-2 focus:ring-white">
                            <option value="date-desc" ${myMantrasSortOrder === 'date-desc' ? 'selected' : ''}>Newest First</option>
                            <option value="date-asc" ${myMantrasSortOrder === 'date-asc' ? 'selected' : ''}>Oldest First</option>
                            <option value="priority-desc" ${myMantrasSortOrder === 'priority-desc' ? 'selected' : ''}>Priority (High to Low)</option>
                            <option value="priority-asc" ${myMantrasSortOrder === 'priority-asc' ? 'selected' : ''}>Priority (Low to High)</option>
                        </select>
                    </div>
                    <div class="space-y-3 max-h-[55vh] overflow-y-auto pr-2">
                    ${sortedMantras.length > 0 ? sortedMantras.map(mantra => {
                        const priorityColor = PRIORITIES[mantra.priority] || PRIORITIES['Medium'];
                        return `
                        <div class="glass-card p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <p class="pr-4 flex-grow">"${mantra.text}"</p>
                                <button data-action="toggle-library-mantra" data-mantra-id='${mantra.id}' class="ml-4 p-2 rounded-full bg-white/20 hover:bg-white/30 flex-shrink-0" aria-label="Remove">
                                    ${ICONS.Trash2({ size: 16 })}
                                </button>
                            </div>
                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-white/10">
                                 <div class="flex items-center gap-2">
                                    <span class="text-xs bg-white/10 px-2 py-0.5 rounded-full">${mantra.category}</span>
                                    <span class="text-xs px-2 py-0.5 rounded-full ${priorityColor} font-semibold text-white">${mantra.priority}</span>
                                 </div>
                                <div class="flex items-center gap-2">
                                    ${PRIORITY_LEVELS.map(p => `
                                        <button data-action="set-mantra-priority" data-mantra-id="${mantra.id}" data-priority="${p}" class="px-2 py-0.5 text-xs rounded-full transition-colors ${mantra.priority === p ? 'bg-white text-deep-purple font-bold' : 'bg-white/20 hover:bg-white/30'}">${p}</button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        `}).join('') : `<div class="text-center p-8"><p class="text-white/80">No mantras found with this priority.</p></div>`}
                    </div>`;
            }
             content += `
                <div class="mt-6 border-t border-white/20 pt-4">
                    <h3 class="text-lg font-semibold text-center mb-3">Create Your Own Mantra</h3>
                    <div class="space-y-3">
                        <textarea id="new-custom-mantra-text" class="w-full p-3 bg-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white resize-none" placeholder="e.g., I am resilient and strong." maxlength="150" rows="3"></textarea>
                        <div id="new-mantra-char-count" class="text-right text-xs text-white/60">0/150</div>
                        <select id="new-custom-mantra-category" class="w-full p-3 bg-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white">
                            ${CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>
                        <select id="new-custom-mantra-priority" class="w-full p-3 bg-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white">
                            <option value="Medium">Medium Priority</option>
                            <option value="High">High Priority</option>
                            <option value="Low">Low Priority</option>
                        </select>
                        ${renderButton('Add Custom Mantra', { variant: 'secondary', attributes: 'data-action="add-new-custom-mantra" id="add-custom-mantra-btn" disabled' })}
                    </div>
                </div>
            `;
        } else if (tab === 'my-affirmations') {
             if (state.userAffirmations.length === 0) {
                content = `
                    <div class="text-center p-8">
                        <p class="text-white/80 mb-4">Add your personal affirmations to see them here.</p>
                    </div>
                `;
            } else {
                content = `<div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">${state.userAffirmations.map(affirmation => `
                    <div class="glass-card p-4 flex justify-between items-center">
                        <p>"${affirmation.text}"</p>
                        <button data-action="remove-affirmation" data-affirmation-id='${affirmation.id}' class="ml-4 p-2 rounded-full bg-white/20 hover:bg-white/30" aria-label="Remove">
                           ${ICONS.Trash2({ size: 16 })}
                        </button>
                    </div>`).join('')}</div>`;
            }
            content += `
                <div class="mt-6 border-t border-white/20 pt-4">
                    <h3 class="text-lg font-semibold text-center mb-3">Add a New Affirmation</h3>
                    <div class="space-y-2">
                        <textarea id="new-affirmation-input" class="w-full p-3 bg-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white resize-none" placeholder="e.g., I am confident and capable." maxlength="150" rows="3"></textarea>
                        <div class="flex justify-between items-center">
                            <span id="char-count" class="text-xs text-white/60">0/150</span>
                            ${renderButton('Add Affirmation', { variant: 'secondary', attributes: 'data-action="add-new-affirmation" id="add-affirmation-btn" disabled' })}
                        </div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = content;
        
        // Update active tab style
        document.querySelectorAll('[data-action="library-tab"]').forEach(btn => {
            const isSelected = btn.dataset.tab === tab;
            btn.classList.toggle('border-teal', isSelected);
            btn.classList.toggle('text-white', isSelected);
            btn.classList.toggle('border-transparent', !isSelected);
            btn.classList.toggle('text-white/60', !isSelected);
        });
    };

    const renderProgress = () => {
        const totalViews = getTotalViews();
        const streak = getStreak();
        const longestStreak = getLongestStreak();
        const mostViewedMantra = Object.entries(state.progress).sort(([,a],[,b]) => b.views - a.views)[0];
        let mostViewedText = 'No views yet.';
        if (mostViewedMantra) {
            const mantra = state.userMantras.find(m => m.id === mostViewedMantra[0]) || CURATED_MANTRAS.find(m => m.id === mostViewedMantra[0]);
            if (mantra) mostViewedText = `"${mantra.text}" (${mostViewedMantra[1].views} views)`;
        }

        const content = `
            <div class="animate-fade-in">
                <h1 class="text-4xl font-serif text-center mb-6">Your Progress</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="glass-card p-4 rounded-xl text-center"><p class="text-sm text-white/70">Total Views</p><p class="text-2xl font-bold">${totalViews}</p></div>
                    <div class="glass-card p-4 rounded-xl text-center"><p class="text-sm text-white/70">Current Streak</p><p class="text-2xl font-bold">${streak} Days</p></div>
                    <div class="glass-card p-4 rounded-xl text-center"><p class="text-sm text-white/70">Longest Streak</p><p class="text-2xl font-bold">${longestStreak} Days</p></div>
                </div>
                <div class="glass-card p-4 rounded-xl mb-6"><p class="text-sm text-white/70">Most Frequent Mantra</p><p class="font-semibold">${mostViewedText}</p></div>

                <div class="glass-card p-4 rounded-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-center">Achievements (${state.achievements.filter(a=>a.unlocked).length}/${state.achievements.length})</h2>
                    <div class="space-y-3">
                    ${state.achievements.map(a => `
                        <div class="flex items-center gap-4 ${a.unlocked ? '' : 'opacity-50'}">
                            <div class="p-2 rounded-full ${a.unlocked ? 'bg-gold' : 'bg-white/20'}">${ICONS.Award({ color: a.unlocked ? '#fff' : 'currentColor' })}</div>
                            <div>
                                <p class="font-semibold">${a.title}</p>
                                <p class="text-sm text-white/70">${a.description}</p>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>

                <div class="glass-card p-4 rounded-xl">
                    <div id="calendar-container"></div>
                </div>
            </div>
        `;
        renderPage(content, { showBackButton: true });

        // --- Interactive Calendar Rendering ---
        const calendarContainer = document.getElementById('calendar-container');
        
        const renderCalendar = () => {
            const year = calendarViewDate.getFullYear();
            const month = calendarViewDate.getMonth();

            const viewedDates = new Set(Object.values(state.progress).map(p => p.lastViewed));
            const today = new Date();
            const formatDate = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            const todayStr = formatDate(today);

            const date = new Date(year, month);
            const monthName = date.toLocaleString('default', { month: 'long' });
            const yearNum = date.getFullYear();

            const firstDayOfMonth = new Date(year, month, 1);
            const startingDayOfWeek = firstDayOfMonth.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const daysOfWeekHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(day => 
                `<div class="text-center text-xs text-white/60 font-semibold">${day}</div>`
            ).join('');

            let calendarCells = Array.from({ length: startingDayOfWeek }, () => '<div></div>').join('');

            for (let day = 1; day <= daysInMonth; day++) {
                const cellDate = new Date(year, month, day);
                const dateStr = formatDate(cellDate);
                const isToday = (dateStr === todayStr);
                const wasViewed = viewedDates.has(dateStr);
                
                let cellClasses = 'w-8 h-8 flex items-center justify-center rounded-full text-xs transition-colors ';
                if (isToday) cellClasses += 'ring-2 ring-white ';
                if (wasViewed) cellClasses += 'bg-teal ';
                else cellClasses += 'bg-white/10 ';
                
                calendarCells += `<div class="${cellClasses}">${day}</div>`;
            }

            calendarContainer.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button data-action="prev-month" class="p-2 rounded-full hover:bg-white/20 transition-colors">${ICONS.ArrowLeft({size: 20})}</button>
                    <div class="text-center">
                         <h2 class="text-xl font-semibold text-center">${monthName} ${yearNum}</h2>
                         <button data-action="calendar-today" class="text-xs text-teal hover:underline">Go to Today</button>
                    </div>
                    <button data-action="next-month" class="p-2 rounded-full hover:bg-white/20 transition-colors">${ICONS.ArrowRight({size: 20})}</button>
                </div>
                <div class="grid grid-cols-7 gap-y-2 place-items-center mt-2">
                    ${daysOfWeekHeaders}
                    ${calendarCells}
                </div>
            `;
        };
        
        const updateCalendar = (offset) => {
            calendarViewDate.setMonth(calendarViewDate.getMonth() + offset);
            renderCalendar();
        };

        calendarContainer.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;

            if (action === 'prev-month') updateCalendar(-1);
            if (action === 'next-month') updateCalendar(1);
            if (action === 'calendar-today') {
                calendarViewDate = new Date();
                renderCalendar();
            }
        });

        renderCalendar();
    };

    const renderSettings = () => {
        const s = state.settings;
        const n = s.notifications;

        const renderTimeSlot = (period) => {
            const setting = n.mantras[period]; // { enabled: bool, time: 'HH:mm' }
            return `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="notif-${period}-enabled" data-action="set-notification-prop" data-type="mantras" data-period="${period}" data-prop="enabled" ${setting.enabled ? 'checked' : ''} class="accent-teal h-5 w-5 rounded">
                        <label for="notif-${period}-enabled" class="capitalize">${period}</label>
                    </div>
                    <input type="time" value="${setting.time}" data-action="set-notification-prop" data-type="mantras" data-period="${period}" data-prop="time" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm w-24" ${!setting.enabled ? 'disabled' : ''}>
                </div>`;
        };
        
        const content = `
            <div class="animate-fade-in max-w-lg mx-auto">
                <h1 class="text-4xl font-serif text-center mb-6">Settings</h1>
                
                <div class="glass-card p-4 rounded-xl mb-4">
                    <h2 class="text-lg font-semibold mb-3">Theme</h2>
                    <div class="grid grid-cols-2 gap-3">
                        ${THEME_OPTIONS.map(theme => `
                            <button data-action="set-theme" data-theme="${theme.id}" class="w-full h-16 rounded-lg border-2 ${s.theme === theme.id ? 'border-white' : 'border-transparent'}" style="background-image: ${theme.gradient};">
                                <span class="sr-only">${theme.name}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div class="glass-card p-4 rounded-xl mb-4">
                    <h2 class="text-lg font-semibold mb-3">Font Style</h2>
                     <div class="flex gap-3">
                        ${FONT_OPTIONS.map(font => `<button data-action="set-font" data-font="${font.id}" class="flex-1 p-3 rounded-lg text-center ${s.font === font.id ? 'bg-white text-deep-purple' : 'bg-white/20'}">${font.name}</button>`).join('')}
                    </div>
                </div>
                
                <div class="glass-card p-4 rounded-xl mb-4 flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Dark Mode</h2>
                    <button data-action="toggle-dark-mode" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${s.isDarkMode ? 'bg-teal' : 'bg-white/20'}">
                        <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${s.isDarkMode ? 'translate-x-6' : 'translate-x-0'}"></span>
                    </button>
                </div>

                <div class="glass-card p-4 rounded-xl mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold flex items-center gap-2">${ICONS.Bell({size: 20})} Mantra Reminders</h2>
                        <button data-action="set-notification-prop" data-type="mantras" data-prop="enabled" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${n.mantras.enabled ? 'bg-teal' : 'bg-white/20'}">
                            <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${n.mantras.enabled ? 'translate-x-6' : 'translate-x-0'}"></span>
                        </button>
                    </div>
                    ${n.mantras.enabled ? `
                    <div class="text-sm space-y-3 pt-2 border-t border-white/20">
                        ${renderTimeSlot('morning')}
                        ${renderTimeSlot('afternoon')}
                        ${renderTimeSlot('evening')}
                    </div>` : '<p class="text-sm text-white/70">Enable to get motivational mantra reminders.</p>'}
                </div>

                <div class="glass-card p-4 rounded-xl mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold flex items-center gap-2">${ICONS.Smile({size: 20})} Daily Affirmation Reminder</h2>
                        <button data-action="set-notification-prop" data-type="affirmation" data-prop="enabled" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${n.affirmation.enabled ? 'bg-teal' : 'bg-white/20'}">
                            <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${n.affirmation.enabled ? 'translate-x-6' : 'translate-x-0'}"></span>
                        </button>
                    </div>
                    ${n.affirmation.enabled ? `
                    <div class="text-sm pt-2 border-t border-white/20">
                        <div class="flex justify-between items-center">
                            <label for="notif-affirmation-time">Reminder time</label>
                            <input type="time" id="notif-affirmation-time" value="${n.affirmation.time}" data-action="set-notification-prop" data-type="affirmation" data-prop="time" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm w-24">
                        </div>
                    </div>` : '<p class="text-sm text-white/70">Enable to get a daily affirmation reminder.</p>'}
                </div>

                 ${deferredInstallPrompt ? `
                    <div class="mt-6 text-center">
                        ${renderButton('Install App', { attributes: 'data-action="install-pwa"'})}
                    </div>` : ''}

                 <div class="glass-card p-4 rounded-xl mb-4">
                    <h2 class="text-lg font-semibold mb-3">Data Management</h2>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button data-action="export-data" class="flex-1 p-3 rounded-lg bg-white/20 text-white hover:bg-white/30 transition-colors flex items-center justify-center gap-2">
                            ${ICONS.Download({size: 20})} Export Data
                        </button>
                        <button data-action="import-data" class="flex-1 p-3 rounded-lg bg-white/20 text-white hover:bg-white/30 transition-colors flex items-center justify-center gap-2">
                            ${ICONS.Upload({size: 20})} Import Data
                        </button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                </div>

                 <div class="mt-6 text-center">
                     <button data-action="reset-app" class="text-red-400 hover:text-red-300 transition-colors">Reset Application Data</button>
                 </div>
            </div>
        `;
        renderPage(content, { showBackButton: true });
    };
    
    // --- SWIPE LOGIC ---
    function setupSwipeListeners() {
        const swipeArea = document.getElementById('swipe-area');
        if (!swipeArea) return;
        let startX = 0;
        let isSwiping = false;

        const handleSwipe = (diff) => {
            if (Math.abs(diff) > 50) { // Threshold
                let newIndex = state.currentMantraIndex;
                if (diff > 0) { // Swipe Right
                    newIndex = (state.currentMantraIndex - 1 + state.userMantras.length) % state.userMantras.length;
                } else { // Swipe Left
                    newIndex = (state.currentMantraIndex + 1) % state.userMantras.length;
                }
                if (newIndex !== state.currentMantraIndex) {
                    state.currentMantraIndex = newIndex;
                    hapticFeedback();
                    // Animate text out, then render, then animate in
                    const mantraText = document.getElementById('mantra-text');
                    mantraText.style.opacity = '0';
                    setTimeout(() => {
                        renderDashboard(); // Re-render to update text and dots
                    }, 150);
                }
            }
        };
        
        swipeArea.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isSwiping = true;
        }, { passive: true });
        
        swipeArea.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            const currentX = e.touches[0].clientX;
            const diff = currentX - startX;
            const mantraText = document.getElementById('mantra-text');
            if (!mantraText) return;
            mantraText.style.transform = `translateX(${diff}px)`;
            mantraText.style.opacity = `${1 - Math.abs(diff) / (window.innerWidth / 2)}`;
        }, { passive: true });

        swipeArea.addEventListener('touchend', (e) => {
            if (!isSwiping) return;
            isSwiping = false;
            const endX = e.changedTouches[0].clientX;
            handleSwipe(endX - startX);
            // Reset style if not swiped enough
            const mantraText = document.getElementById('mantra-text');
            if (mantraText) {
              mantraText.style.transform = 'translateX(0)';
              mantraText.style.opacity = '1';
            }
        });
    }


    // --- ROUTER ---
    const router = () => {
        const path = window.location.hash.slice(1) || '/';
        
        if (!state.isOnboardingComplete && !path.startsWith('/onboarding')) {
            window.location.hash = '/onboarding/welcome';
            return;
        }

        if (path.startsWith('/onboarding')) {
            const step = path.split('/')[2] || 'welcome';
            renderOnboarding(step);
        } else {
            applySettings();
            switch (path) {
                case '/library': renderLibrary(); break;
                case '/progress': renderProgress(); break;
                case '/settings': renderSettings(); break;
                case '/affirmations': renderAffirmations(); break;
                case '/dashboard': renderDashboard(); break;
                default:
                    window.location.hash = '/dashboard';
            }
        }
    };
    
    // --- EVENT LISTENERS ---
    document.addEventListener('input', e => {
        const target = e.target;
        const action = target.dataset.action;

        if (action === 'set-notification-prop' && target.type === 'time') {
            const type = target.dataset.type;
            const period = target.dataset.period;
            const prop = target.dataset.prop;
            const value = target.value;
            
            if (type === 'affirmation') {
                state.settings.notifications.affirmation[prop] = value;
            } else if (type === 'mantras' && period) {
                state.settings.notifications.mantras[period][prop] = value;
            }
            saveState();
        } else if (target.id === 'new-affirmation-input') {
            const charCount = document.getElementById('char-count');
            const addBtn = document.getElementById('add-affirmation-btn');
            if (charCount && addBtn) {
                const count = target.value.length;
                charCount.textContent = `${count}/150`;
                addBtn.disabled = target.value.trim().length === 0;
            }
        } else if (target.id === 'new-custom-mantra-text') {
            const charCountEl = document.getElementById('new-mantra-char-count');
            const addBtn = document.getElementById('add-custom-mantra-btn');
            if (charCountEl && addBtn) {
                const count = target.value.length;
                charCountEl.textContent = `${count}/150`;
                addBtn.disabled = target.value.trim().length === 0;
            }
        } else if (target.id === 'mantra-search-input') {
            const searchTerm = target.value;
            const activeCategoryButton = document.querySelector('[data-action="library-filter"][class*="bg-white"]');
            const category = activeCategoryButton ? activeCategoryButton.dataset.category : CATEGORIES[0];
            renderLibraryContent('curated', { category, searchTerm });
        }
    });

    document.addEventListener('change', e => {
        const target = e.target;
        if (target.id === 'import-file-input' && target.files.length > 0) {
            const file = target.files[0];
            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    // Basic validation
                    const requiredKeys = ['userMantras', 'settings', 'progress', 'isOnboardingComplete'];
                    const hasRequiredKeys = requiredKeys.every(key => key in importedData);
                    
                    if (!hasRequiredKeys) {
                        throw new Error('Invalid or corrupted backup file.');
                    }

                    renderConfirmationModal(
                        'Confirm Import',
                        'Importing will overwrite all current data. Are you sure you want to continue?',
                        () => {
                            // Overwrite state with imported data, providing defaults for any missing keys
                            state.userMantras = importedData.userMantras || [];
                            state.userAffirmations = importedData.userAffirmations || [];
                            state.settings = { ...defaultSettings, ...importedData.settings }; // Merge to be safe
                            state.progress = importedData.progress || {};
                            state.isOnboardingComplete = importedData.isOnboardingComplete || false;
                            state.achievements = importedData.achievements || INITIAL_ACHIEVEMENTS;
                            state.dailyAffirmation = importedData.dailyAffirmation || null;
                            
                            saveState();
                            applySettings();
                            alert('Data imported successfully! The app will now reload.');
                            window.location.reload();
                        },
                        { confirmText: 'Import & Overwrite', confirmVariant: 'destructive' }
                    );
                } catch (error) {
                    console.error('Failed to import data:', error);
                    alert(`Import failed: ${error.message}`);
                } finally {
                    target.value = '';
                }
            };

            reader.onerror = () => {
                alert('Failed to read the selected file.');
                target.value = '';
            };

            reader.readAsText(file);
        }

        if (target.dataset.action === 'set-mantra-sort') {
            myMantrasSortOrder = target.value;
            const activeFilterBtn = document.querySelector('[data-action="library-priority-filter"][class*="bg-white"]');
            const priorityFilter = activeFilterBtn ? activeFilterBtn.dataset.priority : 'All';
            renderLibraryContent('my-mantras', { priorityFilter });
        }
    });

    document.addEventListener('click', e => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        
        const action = target.dataset.action;
        const mantraId = target.dataset.mantraId;
        
        hapticFeedback();

        switch (action) {
            case 'nav': window.location.hash = target.dataset.path; break;
            case 'go-back': window.history.back(); break;
            case 'filter-mantras': renderMantraSelectionList(target.dataset.category); break;
            case 'library-filter': {
                const searchTerm = document.getElementById('mantra-search-input')?.value || '';
                renderLibraryContent('curated', { category: target.dataset.category, searchTerm });
                break;
            }
            case 'library-priority-filter': {
                const activeTab = document.querySelector('[data-action="library-tab"][class*="border-teal"]').dataset.tab;
                renderLibraryContent(activeTab, { priorityFilter: target.dataset.priority });
                break;
            }
            case 'toggle-onboarding-mantra':
                const mantra = CURATED_MANTRAS.find(m => m.id === mantraId);
                if (state.onboardingTempMantras.some(m => m.id === mantraId)) {
                    state.onboardingTempMantras = state.onboardingTempMantras.filter(m => m.id !== mantraId);
                } else {
                    if (state.onboardingTempMantras.length >= 5) {
                        renderModal('Limit Reached', 'You can select a maximum of 5 mantras.');
                        return; // Exit without adding
                    }
                    state.onboardingTempMantras.push(mantra);
                }
                saveState();
                renderOnboarding('mantras'); // Re-render to update UI
                break;
            case 'add-custom-onboarding':
                const textEl = document.getElementById('custom-mantra-text');
                const catEl = document.getElementById('custom-mantra-category');
                const prioEl = document.getElementById('custom-mantra-priority');
                if (textEl.value.trim()) {
                    const newMantra = { 
                        id: `c-${Date.now()}`, 
                        text: textEl.value.trim(), 
                        category: catEl.value, 
                        priority: prioEl.value,
                        createdAt: Date.now() 
                    };
                    state.onboardingTempMantras.push(newMantra);
                    saveState();
                    textEl.value = '';
                    alert('Custom mantra added!');
                }
                break;
            case 'finish-onboarding':
                state.userMantras = state.onboardingTempMantras.map(m => ({ 
                    ...m, 
                    priority: m.priority || 'Medium',
                    createdAt: m.createdAt || Date.now()
                }));
                state.isOnboardingComplete = true;
                if (state.userMantras.length >= 3) unlockAchievement('3_mantras');
                if (state.userMantras.some(m => m.id.startsWith('c-'))) unlockAchievement('custom_mantra');
                state.onboardingTempMantras = [];
                saveState();
                window.location.hash = '/dashboard';
                break;
            case 'set-mantra-index': {
                 const newIndex = parseInt(target.dataset.index, 10);
                 if (newIndex === state.currentMantraIndex) break;

                 state.currentMantraIndex = newIndex;
                 const mantraText = document.getElementById('mantra-text');
                 if (mantraText) {
                     mantraText.style.opacity = '0';
                     setTimeout(() => {
                         renderDashboard();
                     }, 150);
                 } else {
                     renderDashboard();
                 }
                 break;
            }
            case 'library-tab': renderLibraryContent(target.dataset.tab); break;
            case 'toggle-library-mantra': {
                 const libMantra = CURATED_MANTRAS.find(m => m.id === mantraId) || state.userMantras.find(m => m.id === mantraId);
                 if (state.userMantras.some(m => m.id === mantraId)) {
                     removeMantra(mantraId);
                 } else {
                     addMantra({ ...libMantra, priority: 'Medium' });
                 }
                 const activeTab = document.querySelector('[data-action="library-tab"][class*="border-teal"]').dataset.tab;
                 if (activeTab === 'curated') {
                    const searchTerm = document.getElementById('mantra-search-input')?.value || '';
                    const activeCategory = document.querySelector('[data-action="library-filter"][class*="bg-white"]')?.dataset.category || CATEGORIES[0];
                    renderLibraryContent(activeTab, { searchTerm, category: activeCategory });
                 } else {
                    renderLibraryContent(activeTab);
                 }
                 break;
             }
            case 'set-mantra-priority': {
                const mantraToUpdateId = target.dataset.mantraId;
                const newPriority = target.dataset.priority;
                const mantraIndex = state.userMantras.findIndex(m => m.id === mantraToUpdateId);
                if (mantraIndex !== -1) {
                    state.userMantras[mantraIndex].priority = newPriority;
                    saveState();
                    const activeFilterBtn = document.querySelector('[data-action="library-priority-filter"][class*="bg-white"]');
                    const priorityFilter = activeFilterBtn ? activeFilterBtn.dataset.priority : 'All';
                    renderLibraryContent('my-mantras', { priorityFilter });
                }
                break;
            }
            case 'add-new-affirmation':
                const input = document.getElementById('new-affirmation-input');
                if (input && input.value.trim()) {
                    addAffirmation(input.value.trim());
                    renderLibraryContent('my-affirmations');
                }
                break;
            case 'remove-affirmation':
                removeAffirmation(target.dataset.affirmationId);
                renderLibraryContent('my-affirmations');
                break;
            case 'add-new-custom-mantra': {
                const textInput = document.getElementById('new-custom-mantra-text');
                const categoryInput = document.getElementById('new-custom-mantra-category');
                const priorityInput = document.getElementById('new-custom-mantra-priority');

                if (textInput && textInput.value.trim()) {
                    const newMantra = {
                        id: `c-${Date.now()}`,
                        text: textInput.value.trim(),
                        category: categoryInput.value,
                        priority: priorityInput.value,
                        createdAt: Date.now(),
                    };
                    addMantra(newMantra);
                    unlockAchievement('custom_mantra');
                    const activeFilterBtn = document.querySelector('[data-action="library-priority-filter"][class*="bg-white"]');
                    const priorityFilter = activeFilterBtn ? activeFilterBtn.dataset.priority : 'All';
                    renderLibraryContent('my-mantras', { priorityFilter });
                }
                break;
            }
            case 'set-theme':
                state.settings.theme = target.dataset.theme;
                saveState();
                applySettings();
                break;
            case 'set-font':
                state.settings.font = target.dataset.font;
                saveState();
                applySettings();
                break;
            case 'toggle-dark-mode':
                state.settings.isDarkMode = !state.settings.isDarkMode;
                saveState();
                applySettings();
                break;
            case 'set-notification-prop': {
                const type = target.dataset.type;
                const period = target.dataset.period;
                const prop = target.dataset.prop;
                const value = target.type === 'checkbox' ? target.checked : target.value;

                if (type === 'affirmation' && prop === 'enabled') {
                    state.settings.notifications.affirmation.enabled = !state.settings.notifications.affirmation.enabled;
                } else if (type === 'mantras') {
                    if (period && prop === 'enabled') {
                        state.settings.notifications.mantras[period].enabled = value;
                    } else if (prop === 'enabled') {
                        state.settings.notifications.mantras.enabled = !state.settings.notifications.mantras.enabled;
                    }
                }
                saveState();
                renderSettings();
                break;
            }
            case 'install-pwa':
                if (deferredInstallPrompt) {
                    deferredInstallPrompt.prompt();
                    deferredInstallPrompt.userChoice.then(() => {
                        deferredInstallPrompt = null;
                        renderSettings();
                    });
                }
                break;
            case 'export-data':
                exportUserData();
                break;
            case 'import-data':
                document.getElementById('import-file-input')?.click();
                break;
            case 'reset-app':
                renderConfirmationModal(
                    'Confirm Reset',
                    'Are you sure you want to delete all your data? This action is permanent and cannot be undone.',
                    () => {
                        Object.values(storageKeys).forEach(key => localStorage.removeItem(key));
                        state = { userMantras: [], userAffirmations: [], settings: JSON.parse(JSON.stringify(defaultSettings)), progress: {}, isOnboardingComplete: false, achievements: INITIAL_ACHIEVEMENTS, currentMantraIndex: 0, onboardingTempMantras: [], dailyAffirmation: null };
                        window.location.hash = '';
                        window.location.reload();
                    },
                    { confirmText: 'Reset', confirmVariant: 'destructive' }
                );
                break;
        }
    });

    // --- INITIALIZATION ---
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        if (window.location.hash.slice(1) === '/settings') {
            renderSettings();
        }
    });

    window.addEventListener('hashchange', router);
    document.addEventListener('DOMContentLoaded', () => {
        // ServiceWorker registration removed to prevent cross-origin errors in hosted environments.
        // Offline capability is handled via localStorage.
        loadState();
        router();
    });

  </script>
</body>
</html>