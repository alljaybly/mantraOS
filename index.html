<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MantraOS</title>
  
  <!-- Tailwind CDN used for hackathon simplicity; compile for production -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PWA Manifest & Themeing -->
  <meta name="theme-color" content="#667eea">
  <link rel="manifest" href="manifest.json">
  <!-- Ensure icon-192.svg exists or use icon-192.png as fallback -->
  <link rel="apple-touch-icon" href="/icon-192.png">


  <script>
    // Custom Tailwind theme configuration
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Poppins', 'sans-serif'],
            'serif': ['Playfair Display', 'serif'],
          },
          colors: {
            'deep-purple': '#667eea',
            'gold': '#f6d365',
            'teal': '#4facfe',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-in-up': 'slideInUp 0.5s ease-in-out',
            'toast-in': 'toastIn 0.3s ease-out forwards',
            'toast-out': 'toastOut 0.3s ease-in forwards',
            'confetti-fall': 'confettiFall 3s ease-out forwards',
            'slideshow-progress': 'slideshowProgress linear forwards',
            'float': 'float 8s ease-in-out infinite',
            'gradient-shift': 'gradientShift 20s ease infinite',
            'pulse-ring': 'pulseRing 2s ease-out infinite',
            'spin': 'spin 1s linear infinite',
            'particle-effect': 'particleEffect 1s ease-out forwards',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideInUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            toastIn: {
                '0%': { transform: 'translateY(100%)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            toastOut: {
                '0%': { transform: 'translateY(0)', opacity: '1' },
                '100%': { transform: 'translateY(100%)', opacity: '0' },
            },
            pulseRing: {
                '0%': { transform: 'scale(0.8)', opacity: '1' },
                '100%': { transform: 'scale(2.5)', opacity: '0' }
            },
            confettiFall: {
                '0%': { transform: 'translateY(-10vh) rotateZ(0deg)', opacity: 1 },
                '100%': { transform: 'translateY(110vh) rotateZ(360deg)', opacity: 0 },
            },
            slideshowProgress: {
                '0%': { width: '0%' },
                '100%': { width: '100%' },
            },
            float: {
              '0%, 100%': { transform: 'translateY(-5px)' },
              '50%': { transform: 'translateY(5px)' },
            },
            gradientShift: {
              '0%, 100%': { backgroundPosition: '0% 50%' },
              '50%': { backgroundPosition: '100% 50%' },
            },
            spin: {
              'from': { transform: 'rotate(0deg)' },
              'to': { transform: 'rotate(360deg)' },
            },
            particleEffect: {
                '0%': { transform: 'scale(0.5) translateY(0)', opacity: 0 },
                '20%': { opacity: 1 },
                '100%': { transform: 'scale(1.2) translateY(-80px)', opacity: 0 },
            },
          }
        }
      }
    }
  </script>
  
  <style>
    /* Basic styles for glassmorphism, theme transitions, and UI elements */
    :root {
      --font-family: 'Poppins', sans-serif;
    }
    html {
        font-family: var(--font-family);
    }
    body {
      transition: background 0.5s ease-in-out;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark .glass-card {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .theme-gradient-1 { background-image: linear-gradient(to top right, #667eea, #764ba2); }
    .theme-gradient-2 { background-image: linear-gradient(to top right, #f6d365, #fda085); }
    .theme-gradient-3 { background-image: linear-gradient(to top right, #4facfe, #00f2fe); }
    .theme-gradient-4 { background-image: linear-gradient(to top right, #434343, #000000); }

    /* Confetti styles */
    .confetti-piece {
        position: absolute;
        width: 8px;
        height: 16px;
        top: -20px;
        will-change: transform, opacity;
    }
    
    /* Transition particle styles */
    .transition-particle {
        position: absolute;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        pointer-events: none;
        will-change: transform, opacity;
    }

    /* Accessibility: Reduce motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-delay: -1ms !important;
        animation-duration: 1ms !important;
        animation-iteration-count: 1 !important;
        background-attachment: initial !important;
        scroll-behavior: auto !important;
        transition-duration: 0s !important;
        transition-delay: 0s !important;
      }
      .animate-float {
        animation: none !important;
      }
    }
  </style>

</head>
<body class="antialiased">
  <div id="root"></div>
  <div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[120] w-full max-w-sm px-4"></div>

  <script type="module">
    // --- ICONS (Lucide via esm.sh as self-contained functions) ---
    const createIcon = (iconName, svgContent) => (props = {}) => {
        const { size = 24, color = 'currentColor', className = '' } = props;
        const element = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        element.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        element.setAttribute('width', size);
        element.setAttribute('height', size);
        element.setAttribute('viewBox', '0 0 24 24');
        element.setAttribute('fill', 'none');
        element.setAttribute('stroke', color);
        element.setAttribute('stroke-width', '2');
        element.setAttribute('stroke-linecap', 'round');
        element.setAttribute('stroke-linejoin', 'round');
        if(className) element.setAttribute('class', className);
        element.innerHTML = svgContent;
        return element.outerHTML;
    };

    const ICONS = {
        Zap: createIcon('Zap', '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>'),
        Layers: createIcon('Layers', '<polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline>'),
        Check: createIcon('Check', '<polyline points="20 6 9 17 4 12"></polyline>'),
        Edit: createIcon('Edit', '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>'),
        CheckCircle: createIcon('CheckCircle', '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'),
        XCircle: createIcon('XCircle', '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>'),
        PlusCircle: createIcon('PlusCircle', '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line>'),
        Home: createIcon('Home', '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>'),
        Library: createIcon('Library', '<path d="m16 6 4 14"></path><path d="M12 6v14"></path><path d="M8 8v12"></path><path d="M4 4v16"></path>'),
        BarChart2: createIcon('BarChart2', '<line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line>'),
        Settings: createIcon('Settings', '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle>'),
        Plus: createIcon('Plus', '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>'),
        Trash2: createIcon('Trash2', '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>'),
        Award: createIcon('Award', '<circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>'),
        Bell: createIcon('Bell', '<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path>'),
        Smile: createIcon('Smile', '<circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>'),
        ArrowLeft: createIcon('ArrowLeft', '<line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline>'),
        ArrowRight: createIcon('ArrowRight', '<line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>'),
        Search: createIcon('Search', '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>'),
        Download: createIcon('Download', '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>'),
        Upload: createIcon('Upload', '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>'),
        Microphone: createIcon('Microphone', '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line>'),
        MicOff: createIcon('MicOff', '<line x1="16" x2="16" y1="13" y2="22"></line><line x1="8" x2="8" y1="13" y2="17"></line><path d="M12 1v8"></path><path d="M20 10v2a8 8 0 0 1-16 0v-2"></path><line x1="1" x2="23" y1="1" y2="23"></line>'),
        Play: createIcon('Play', '<polygon points="5 3 19 12 5 21 5 3"></polygon>'),
        Pause: createIcon('Pause', '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>'),
        StopCircle: createIcon('StopCircle', '<circle cx="12" cy="12" r="10"></circle><rect x="9" y="9" width="6" height="6"></rect>'),
        Trophy: createIcon('Trophy', '<path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>'),
        Music4: createIcon('Music4', '<path d="M9 18V5l12-2v13"/><path d="m9 9 12-2"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>'),
        Timer: createIcon('Timer', '<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>'),
        Vibrate: createIcon('Vibrate', '<path d="m2 8 2.18-1.37a2 2 0 0 1 2.64 0L10 8"/><path d="m14 8 2.18-1.37a2 2 0 0 1 2.64 0L22 8"/><path d="M7 13h10"/><path d="M9 17h6"/><path d="M2 12H0"/><path d="M24 12h-2"/><path d="m5 21 2-4"/><path d="m19 21-2-4"/><path d="M19 5l-2 4"/><path d="m5 5 2 4"/>'),
        RotateCcw: createIcon('RotateCcw', '<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>'),
        RotateCw: createIcon('RotateCw', '<path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>'),
        Sparkles: createIcon('Sparkles', '<path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/>'),
        Languages: createIcon('Languages', '<path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/>'),
        Wand2: createIcon('Wand2', '<path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M11.8 17.8 13 19"/><path d="M19 11.8 17.8 13"/><path d="M13 11.8 11.8 13"/><path d="m21.1 12.3-1.1 1.1a4.9 4.9 0 0 1-7 7l-1.8-1.8a4.9 4.9 0 0 1 7-7l1.1-1.1Z"/><path d="M3 21a2.4 2.4 0 0 1 0-3.4l3.1-3.1"/>'),
        Cpu: createIcon('Cpu', '<rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M15 2v2"/><path d="M15 20v2"/><path d="M2 15h2"/><path d="M2 9h2"/><path d="M20 15h2"/><path d="M20 9h2"/><path d="M9 2v2"/><path d="M9 20v2"/>'),
    };

    // --- CHROME AI ---
    let aiTextSession = null;
    let aiTranslator = null;
    const isAnyAiFeatureEnabled = () => state.settings.aiFeatures.enabled && (state.aiStatus.supported || state.settings.demoMode.enabled);

    const checkAiStatus = async () => {
        console.log('[MantraOS AI Diagnostics] Starting AI feature check...');
        const status = {
            checked: true,
            supported: typeof window.ai !== 'undefined',
            text: false,
            translator: false,
            rewriter: false,
            proofreader: false,
            assistant: false
        };

        if (status.supported) {
            console.log('[MantraOS AI Diagnostics] window.ai object found.');
            try {
                await window.ai.createTextSession();
                status.text = true;
                console.log('[MantraOS AI Diagnostics] createTextSession: Available');
            } catch (e) { console.log('[MantraOS AI Diagnostics] createTextSession: Unavailable', e.message); }

            try {
                await window.ai.translator.create();
                status.translator = true;
                console.log('[MantraOS AI Diagnostics] translator.create: Available');
            } catch (e) { console.log('[MantraOS AI Diagnostics] translator.create: Unavailable', e.message); }

            try {
                await window.ai.rewriter.create();
                status.rewriter = true;
                console.log('[MantraOS AI Diagnostics] rewriter.create: Available');
            } catch (e) { console.log('[MantraOS AI Diagnostics] rewriter.create: Unavailable', e.message); }

            try {
                await window.ai.proofreader.create();
                status.proofreader = true;
                console.log('[MantraOS AI Diagnostics] proofreader.create: Available');
            } catch (e) { console.log('[MantraOS AI Diagnostics] proofreader.create: Unavailable', e.message); }

            try {
                if (window.ai.assistant && await window.ai.assistant.canPrompt({audio: true})) {
                    status.assistant = true;
                    console.log('[MantraOS AI Diagnostics] assistant.canPrompt({audio: true}): Available');
                } else {
                     console.log('[MantraOS AI Diagnostics] assistant.canPrompt({audio: true}): Unavailable');
                }
            } catch (e) { console.log('[MantraOS AI Diagnostics] assistant.canPrompt: Unavailable', e.message); }
        } else {
            console.log('[MantraOS AI Diagnostics] window.ai object not found. AI features are unavailable.');
            renderToast('AI features unavailable. Using demo mode.');
        }
        state.aiStatus = status;
        console.log('[MantraOS AI Diagnostics] Check complete. Final status:', state.aiStatus);
    };

    // --- CONSTANTS ---
    const CATEGORIES = ['Money', 'Health', 'Relationships', 'Career', 'Confidence', 'AI Generated'];
    const PRIORITIES = { Low: 'bg-sky-500', Medium: 'bg-yellow-500', High: 'bg-rose-500' };
    const PRIORITY_LEVELS = ['Low', 'Medium', 'High'];
    const CURATED_MANTRAS = [
      { id: 'm1', text: { original: 'Money flows to me easily, frequently, and abundantly.', translated: null }, category: 'Money' }, { id: 'm2', text: { original: 'I am a magnet for financial prosperity and wealth.', translated: null }, category: 'Money' }, { id: 'm3', text: { original: 'Wealth constantly circulates in my life.', translated: null }, category: 'Money' }, { id: 'm4', text: { original: 'I am worthy of building and receiving massive wealth.', translated: null }, category: 'Money' }, { id: 'm5', text: { original: 'My income is constantly increasing.', translated: null }, category: 'Money' },
      { id: 'h1', text: { original: 'My body is a magnificent vessel of health and vitality.', translated: null }, category: 'Health' }, { id: 'h2', text: { original: 'I choose vibrant health and boundless energy.', translated: null }, category: 'Health' }, { id: 'h3', text: { original: 'My body heals itself quickly and easily.', translated: null }, category: 'Health' }, { id: 'h4', text: { original: 'I nourish my body with healthy food and positive thoughts.', translated: null }, category: 'Health' }, { id: 'h5', text: { original: 'Every cell in my body is alive with energy.', translated: null }, category: 'Health' },
      { id: 'r1', text: { original: 'I attract loving, supportive, and harmonious relationships.', translated: null }, category: 'Relationships' }, { id: 'r2', text: { original: 'I communicate with clarity, honesty, and compassion.', translated: null }, category: 'Relationships' }, { id: 'r3', text: { original: 'I give and receive love effortlessly and unconditionally.', translated: null }, category: 'Relationships' }, { id: 'r4', text: { original: 'I am surrounded by people who love and respect me.', translated: null }, category: 'Relationships' }, { id: 'r5', text: { original: 'My heart is open to meaningful connections.', translated: null }, category: 'Relationships' },
      { id: 'cr1', text: { original: 'Amazing career opportunities find their way to me.', translated: null }, category: 'Career' }, { id: 'cr2', text: { original: 'My work makes a positive impact and inspires others.', translated: null }, category: 'Career' }, { id: 'cr3', text: { original: 'I am valued and respected for my unique talents.', translated: null }, category: 'Career' }, { id: 'cr4', text: { original: 'I am confident in my abilities and excel in my profession.', translated: null }, category: 'Career' }, { id: 'cr5', text: { original: 'I am on the perfect path for my career success.', translated: null }, category: 'Career' },
      { id: 'c1', text: { original: 'I am enough, just as I am.', translated: null }, category: 'Confidence' }, { id: 'c2', text: { original: 'My voice is valuable and my opinion matters.', translated: null }, category: 'Confidence' }, { id: 'c3', text: { original: 'I embrace challenges as opportunities to grow stronger.', translated: null }, category: 'Confidence' }, { id: 'c4', text: { original: 'I am confident, capable, and in control of my life.', translated: null }, category: 'Confidence' }, { id: 'c5', text: { original: 'I release all self-doubt and welcome self-love.', translated: null }, category: 'Confidence' },
    ];
    const THEME_OPTIONS = [
        { id: 'theme-gradient-1', name: 'Cosmic Cobalt', gradient: 'linear-gradient(to top right, #667eea, #764ba2)' }, { id: 'theme-gradient-2', name: 'Sunset Flare', gradient: 'linear-gradient(to top right, #f6d365, #fda085)' }, { id: 'theme-gradient-3', name: 'Aqua Marine', gradient: 'linear-gradient(to top right, #4facfe, #00f2fe)' }, { id: 'theme-gradient-4', name: 'Midnight Onyx', gradient: 'linear-gradient(to top right, #434343, #000000)' },
    ];
    const FONT_OPTIONS = [ { id: 'font-sans', name: 'Poppins (Modern)'}, { id: 'font-serif', name: 'Playfair (Elegant)'},];
    const SUPPORTED_LANGUAGES = { 'en': 'English', 'es': 'Español', 'fr': 'Français', 'de': 'Deutsch', 'ja': '日本語' };
    const INITIAL_ACHIEVEMENTS = [
        { id: 'first_view', title: 'First Step', description: 'View your first mantra.', unlocked: false }, { id: '7_day_streak', title: 'Consistent Mind', description: 'View mantras for 7 days in a row.', unlocked: false }, { id: '3_mantras', title: 'Trio of Power', description: 'Select at least 3 mantras.', unlocked: false }, { id: 'custom_mantra', title: 'Your Own Voice', description: 'Create your first custom mantra.', unlocked: false }, { id: '100_views', title: 'Mantra Master', description: 'View mantras 100 times in total.', unlocked: false },
    ];
    const MAX_RECORDING_SECONDS = 30;
    const MAX_AI_RECORDING_SECONDS = 10;

    // --- AUDIO & BROWSER SUPPORT ---
    const isAudioSupported = !!(navigator.mediaDevices && window.MediaRecorder);
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingTimer = null;
    let recordingInterval = null;
    let currentlyRecordingMantraId = null;
    const audioPlayer = new Audio();
    let currentlyPlayingMantraId = null;
    let audioContext;

    // AI Audio Recording Globals
    let aiTopicRecorder = null;
    let aiTopicChunks = [];
    let aiTopicRecordingTimer = null;
    let aiTopicRecordingInterval = null;


    // --- STATE MANAGEMENT ---
    let deferredInstallPrompt = null;
    let calendarViewDate = new Date(); // For stateful calendar navigation
    let myMantrasSortOrder = 'date-desc'; // For sorting 'My Mantras' view
    let slideshowTimer = null;
    let undoHistory = [];
    let redoHistory = [];
    let toastTimeout = null;


    const defaultSettings = {
        theme: 'theme-gradient-1', font: 'font-sans', isDarkMode: false,
        notifications: {
            mantras: {
                enabled: false,
                morning: { enabled: true, time: '08:00' },
                afternoon: { enabled: true, time: '13:00' },
                evening: { enabled: false, time: '19:00' }
            },
            affirmation: { enabled: false, time: '09:00' }
        },
        voiceFeatures: { enabled: true },
        celebrationSounds: { enabled: true },
        haptics: { enabled: true },
        slideshow: { enabled: false, interval: 6 }, // interval in seconds
        aiFeatures: { enabled: true },
        demoMode: { enabled: false },
        language: 'auto',
        aiSettings: {
            creativity: 'balanced', // focused, balanced, creative
            tone: 'inspirational', // inspirational, assertive, gentle, calm
            length: 'medium' // short, medium, long
        },
    };

    let state = {
      userMantras: [],
      userAffirmations: [],
      settings: JSON.parse(JSON.stringify(defaultSettings)), // Deep copy
      progress: {},
      isOnboardingComplete: false,
      achievements: INITIAL_ACHIEVEMENTS,
      currentMantraIndex: 0,
      onboardingTempMantras: [],
      dailyAffirmation: null,
      audioRecordings: {},
      lastDailyGoalCelebrated: null, // YYYY-MM-DD
      lastStreakMilestoneCelebrated: 0, // e.g., 7, 14, 21
      aiStatus: {
          checked: false,
          supported: false,
          text: false,
          translator: false,
          rewriter: false,
          proofreader: false,
          assistant: false,
      },
    };

    const storageKeys = {
        mantras: 'mantraos_user_mantras',
        affirmations: 'mantraos_user_affirmations',
        settings: 'mantraos_settings',
        progress: 'mantraos_progress',
        onboarding: 'mantraos_onboarding_complete',
        achievements: 'mantraos_achievements',
        dailyAffirmation: 'mantraos_daily_affirmation',
        onboardingTempMantras: 'mantraos_onboarding_temp_mantras',
        audioRecordings: 'mantraos_audio_recordings',
        lastDailyGoal: 'mantraos_last_daily_goal',
        lastStreakMilestone: 'mantraos_last_streak_milestone',
    };

    function saveState() {
        try {
            localStorage.setItem(storageKeys.mantras, JSON.stringify(state.userMantras));
            localStorage.setItem(storageKeys.affirmations, JSON.stringify(state.userAffirmations));
            localStorage.setItem(storageKeys.settings, JSON.stringify(state.settings));
            localStorage.setItem(storageKeys.progress, JSON.stringify(state.progress));
            localStorage.setItem(storageKeys.onboarding, JSON.stringify(state.isOnboardingComplete));
            localStorage.setItem(storageKeys.achievements, JSON.stringify(state.achievements));
            localStorage.setItem(storageKeys.dailyAffirmation, JSON.stringify(state.dailyAffirmation));
            localStorage.setItem(storageKeys.onboardingTempMantras, JSON.stringify(state.onboardingTempMantras));
            localStorage.setItem(storageKeys.audioRecordings, JSON.stringify(state.audioRecordings));
            localStorage.setItem(storageKeys.lastDailyGoal, JSON.stringify(state.lastDailyGoalCelebrated));
            localStorage.setItem(storageKeys.lastStreakMilestone, JSON.stringify(state.lastStreakMilestoneCelebrated));
        } catch (error) {
            console.error("Failed to save state to localStorage:", error);
            if (error.name === 'QuotaExceededError') {
                 renderModal('Storage Full', 'Your device storage is full. Please clear some space, or delete some voice recordings from the settings menu.');
            }
        }
    }

    function loadState() {
        try {
            // Mantra loading with migration for priority, creation date, and text object structure
            const loadedMantras = JSON.parse(localStorage.getItem(storageKeys.mantras)) || [];
            state.userMantras = loadedMantras.map((m, index) => {
                const newMantra = { 
                    ...m, 
                    priority: m.priority || 'Medium',
                    createdAt: m.createdAt || (Date.now() - (loadedMantras.length - index) * 60000)
                };
                // Migration for new text object structure
                if (typeof newMantra.text === 'string') {
                    newMantra.text = { original: newMantra.text, translated: null };
                }
                return newMantra;
            });


            state.userAffirmations = JSON.parse(localStorage.getItem(storageKeys.affirmations)) || [];
            
            // Settings loading with migration for old notification structure
            let loadedSettings = JSON.parse(localStorage.getItem(storageKeys.settings)) || {};

            if (loadedSettings.notifications && typeof loadedSettings.notifications.enabled === 'boolean') {
                const oldNotifs = loadedSettings.notifications;
                loadedSettings.notifications = {
                    mantras: {
                        enabled: oldNotifs.enabled,
                        morning: { enabled: !!oldNotifs.morning, time: '08:00' },
                        afternoon: { enabled: !!oldNotifs.afternoon, time: '13:00' },
                        evening: { enabled: !!oldNotifs.evening, time: '19:00' },
                    },
                    affirmation: { enabled: false, time: '09:00' }
                };
            }

            // Deep merge to ensure new settings keys are added
            const deepMerge = (target, source) => {
                const output = { ...target };
                if (target && typeof target === 'object' && source && typeof source === 'object') {
                    Object.keys(source).forEach(key => {
                        if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                            if (!(key in target))
                                Object.assign(output, { [key]: source[key] });
                            else
                                output[key] = deepMerge(target[key], source[key]);
                        } else {
                            Object.assign(output, { [key]: source[key] });
                        }
                    });
                }
                return output;
            };
            
            state.settings = deepMerge(defaultSettings, loadedSettings);

            state.progress = JSON.parse(localStorage.getItem(storageKeys.progress)) || {};
            state.isOnboardingComplete = JSON.parse(localStorage.getItem(storageKeys.onboarding)) || false;
            state.achievements = JSON.parse(localStorage.getItem(storageKeys.achievements)) || INITIAL_ACHIEVEMENTS;
            state.dailyAffirmation = JSON.parse(localStorage.getItem(storageKeys.dailyAffirmation)) || null;
            state.onboardingTempMantras = JSON.parse(localStorage.getItem(storageKeys.onboardingTempMantras)) || [];
            state.audioRecordings = JSON.parse(localStorage.getItem(storageKeys.audioRecordings)) || {};
            state.lastDailyGoalCelebrated = JSON.parse(localStorage.getItem(storageKeys.lastDailyGoal)) || null;
            state.lastStreakMilestoneCelebrated = JSON.parse(localStorage.getItem(storageKeys.lastStreakMilestone)) || 0;
            
        } catch (error) {
            console.error("Failed to load state from localStorage:", error);
        }
    }

    // --- DOM & UTILS ---
    const root = document.getElementById('root');
    const hapticFeedback = () => {
        if (state.settings.haptics.enabled && navigator.vibrate) {
            navigator.vibrate(50);
        }
    };
    const getAudioStorageUsage = () => {
        const data = localStorage.getItem(storageKeys.audioRecordings) || '{}';
        const bytes = new Blob([data]).size;
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
    };
    const formatDate = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    const getNestedValue = (obj, path) => path.split('.').reduce((acc, part) => acc && acc[part], obj);
    const setNestedValue = (obj, path, value) => {
        const keys = path.split('.');
        const lastKey = keys.pop();
        const target = keys.reduce((acc, part) => acc[part] = acc[part] || {}, obj);
        target[lastKey] = value;
    };
    const getMantraText = (mantra) => {
        const targetLang = state.settings.language;
        if (targetLang !== 'en' && mantra.text.translated) {
            return mantra.text.translated;
        }
        return mantra.text.original;
    };


    // --- APP LOGIC ---
    const unlockAchievement = (id) => {
        const achievement = state.achievements.find(a => a.id === id);
        if (achievement && !achievement.unlocked) {
            achievement.unlocked = true;
            saveState();
        }
    };
    const recordMantraView = (mantraId) => {
        if (!mantraId) return;
        const today = formatDate(new Date());

        if (!state.progress[mantraId]) {
            state.progress[mantraId] = { views: 0, lastViewed: '' };
        }
        state.progress[mantraId].views += 1;
        state.progress[mantraId].lastViewed = today;
        unlockAchievement('first_view');
        const totalViews = getTotalViews();
        if (totalViews >= 100) unlockAchievement('100_views');
        if (getStreak() >= 7) unlockAchievement('7_day_streak');
        saveState();
        checkForCelebrations();
    };
    const getTotalViews = () => Object.values(state.progress).reduce((total, p) => total + p.views, 0);
    const getStreak = () => {
        const dates = [...new Set(Object.values(state.progress).map(p => p.lastViewed).filter(d => d))].sort();
        if (dates.length === 0) return 0;
        
        let streak = 0;
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        
        const todayStr = formatDate(today);
        const yesterdayStr = formatDate(yesterday);
        
        const parseDate = (str) => {
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
        };

        if (dates[dates.length - 1] === todayStr || dates[dates.length - 1] === yesterdayStr) {
            streak = 1;
            for (let i = dates.length - 1; i > 0; i--) {
                const currentDate = parseDate(dates[i]);
                const prevDate = parseDate(dates[i - 1]);
                const diff = (currentDate.getTime() - prevDate.getTime()) / (1000 * 3600 * 24);
                if (diff === 1) {
                    streak++;
                } else {
                    break;
                }
            }
        }
        return streak;
    };
    const getLongestStreak = () => {
        const dates = [...new Set(Object.values(state.progress).map(p => p.lastViewed).filter(d => d))].sort();
        if (dates.length <= 1) return dates.length;

        let longestStreak = 1;
        let currentStreak = 1;
        
        const parseDate = (str) => {
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
        };

        for (let i = 1; i < dates.length; i++) {
            const currentDate = parseDate(dates[i]);
            const prevDate = parseDate(dates[i - 1]);
            const diff = (currentDate.getTime() - prevDate.getTime()) / (1000 * 3600 * 24);

            if (diff === 1) {
                currentStreak++;
            } else {
                currentStreak = 1;
            }
            longestStreak = Math.max(longestStreak, currentStreak);
        }
        return longestStreak;
    };
    const applySettings = () => {
        document.body.className = '';
        document.body.classList.add(state.settings.theme, 'antialiased', 'text-white', 'transition-colors', 'duration-500', 'bg-[length:200%_200%]', 'animate-gradient-shift');
        document.documentElement.classList.toggle('dark', state.settings.isDarkMode);
        document.documentElement.style.setProperty('--font-family', state.settings.font === 'font-sans' ? "'Poppins', sans-serif" : "'Playfair Display', serif");
    };
    const exportUserData = () => {
        renderConfirmationModal(
            'Export Data?',
            'This will create a JSON backup of your mantras, settings, and progress.',
            () => {
                try {
                    const backupData = { ...state };
                    delete backupData.aiStatus; // Don't export runtime status
                    const jsonString = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    const timestamp = new Date().toISOString().slice(0, 10);
                    link.download = `mantraos_backup_${timestamp}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    renderToast('Data exported successfully!');
                } catch (error) {
                    console.error('Failed to export data:', error);
                    renderModal('Export Error', 'An error occurred while exporting your data.');
                }
            },
            { confirmText: 'Export' }
        );
    };
    
    // --- SLIDESHOW LOGIC ---
    const stopSlideshow = () => {
        clearTimeout(slideshowTimer);
        slideshowTimer = null;
    };

    const goToNextMantra = () => {
        const newIndex = (state.currentMantraIndex + 1) % state.userMantras.length;
        state.currentMantraIndex = newIndex;
        renderTransitionParticles();

        // Re-introducing a setTimeout to allow for a fade-out animation and to resolve
        // potential browser rendering issues, mirroring the working logic in handleSwipe.
        const mantraText = document.getElementById('mantra-text');
        if (mantraText) {
            mantraText.style.opacity = '0';
            setTimeout(renderDashboard, 150);
        } else {
            renderDashboard();
        }
    };

    const startSlideshow = () => {
        stopSlideshow(); // Ensure no multiple timers are running
        if (state.settings.slideshow.enabled && state.userMantras.length > 1) {
            slideshowTimer = setTimeout(goToNextMantra, state.settings.slideshow.interval * 1000);
        }
    };

    const resetSlideshowTimer = () => {
        stopSlideshow();
        startSlideshow();
    };

    // --- AUDIO LOGIC ---
    const playSound = (type) => {
        if (!state.settings.celebrationSounds.enabled) return;
        try {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const playNote = (freq, startTime, duration) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.value = freq;
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.5, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            };

            const now = audioContext.currentTime;
            if (type === 'daily') {
                playNote(880, now, 0.2); // A5 note
            } else if (type === 'streak') {
                playNote(523.25, now, 0.15); // C5
                playNote(659.25, now + 0.15, 0.15); // E5
                playNote(783.99, now + 0.3, 0.2); // G5
            }
        } catch (e) {
            console.error("Could not play sound:", e);
        }
    };

    const stopRecording = () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
        clearTimeout(recordingTimer);
        clearInterval(recordingInterval);
        recordingTimer = null;
        recordingInterval = null;
        startSlideshow(); // Resume slideshow after stopping recording
    };
    
    const startRecording = async (mantraId) => {
        if (currentlyRecordingMantraId) stopRecording();
        if (!audioPlayer.paused) stopPlayback();
        stopSlideshow();

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            currentlyRecordingMantraId = mantraId;
            audioChunks = [];
            
            // Re-render to show recording UI
            const currentPath = window.location.hash.slice(1);
            if(currentPath === '/dashboard') renderDashboard();
            else if(currentPath === '/library') renderLibraryContent('my-mantras');

            const options = {
                mimeType: 'audio/webm;codecs=opus',
                audioBitsPerSecond: 64000 // 64kbps, a good balance for voice
            };

            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                console.warn("Opus codec or specific bitrate not supported, falling back to default.", e);
                mediaRecorder = new MediaRecorder(stream); 
            }
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: options.mimeType });
                const reader = new FileReader();
                reader.onload = () => {
                    const oldRecording = state.audioRecordings[mantraId];
                    performAction({
                        type: 'SET_RECORDING',
                        payload: { mantraId, oldRecording, newRecording: reader.result }
                    });
                    currentlyRecordingMantraId = null;
                };
                reader.readAsDataURL(audioBlob);
                stream.getTracks().forEach(track => track.stop()); // Release microphone
            };

            mediaRecorder.start();

            // Auto-stop after max duration
            recordingTimer = setTimeout(stopRecording, MAX_RECORDING_SECONDS * 1000);
            
            // Timer UI update
            let secondsRemaining = MAX_RECORDING_SECONDS;
            const timerEl = document.getElementById(`audio-timer-${mantraId}`);
            if (timerEl) timerEl.textContent = `${secondsRemaining}s left`;

            recordingInterval = setInterval(() => {
                secondsRemaining--;
                const timerEl = document.getElementById(`audio-timer-${mantraId}`);
                if (timerEl) {
                    timerEl.textContent = `${secondsRemaining}s left`;
                }
                if (secondsRemaining <= 0) {
                    clearInterval(recordingInterval);
                }
            }, 1000);

        } catch (err) {
            console.error("Error accessing microphone:", err);
            currentlyRecordingMantraId = null;
            renderModal('Microphone Error', 'Could not access the microphone. Please ensure you have granted permission in your browser settings.');
        }
    };

    const stopPlayback = () => {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        const oldPlayingId = currentlyPlayingMantraId;
        currentlyPlayingMantraId = null;

        const controls = document.getElementById(`audio-controls-${oldPlayingId}`);
        if(controls) controls.innerHTML = renderAudioInterface(oldPlayingId);
        startSlideshow(); // Resume slideshow
    };

    const playRecording = (mantraId) => {
        stopSlideshow();
        if (currentlyRecordingMantraId) stopRecording();
        if (currentlyPlayingMantraId && currentlyPlayingMantraId !== mantraId) stopPlayback();

        currentlyPlayingMantraId = mantraId;
        
        if (audioPlayer.src !== state.audioRecordings[mantraId]) {
            audioPlayer.src = state.audioRecordings[mantraId];
        }
        audioPlayer.play();
    };

    const pauseRecording = () => {
        audioPlayer.pause();
        stopSlideshow(); // Also pause slideshow
    };

    const deleteRecording = (mantraId) => {
        renderConfirmationModal('Delete Recording?', 'This will permanently remove the voice recording for this mantra.', () => {
            if(currentlyPlayingMantraId === mantraId) stopPlayback();
            performAction({
                type: 'DELETE_RECORDING',
                payload: { mantraId, recording: state.audioRecordings[mantraId] }
            });
        }, {confirmText: 'Delete', confirmVariant: 'destructive'});
    };


    // --- TEMPLATING / RENDERING ---
    const renderButton = (text, { variant = 'primary', additionalClasses = '', attributes = '' } = {}) => {
      const baseClasses = 'px-6 py-3 font-semibold rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-transparent disabled:opacity-50 disabled:cursor-not-allowed';
      const variantClasses = {
        primary: 'bg-white text-deep-purple hover:bg-opacity-90 focus:ring-white',
        secondary: 'bg-white/20 text-white hover:bg-white/30 focus:ring-white',
        ghost: 'bg-transparent text-white hover:bg-white/10 focus:ring-white',
      };
      return `<button class="${baseClasses} ${variantClasses[variant]} ${additionalClasses}" ${attributes}>${text}</button>`;
    }
    
    const renderModal = (title, content, onclose) => {
        const modalHTML = `
            <div id="app-modal" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 animate-fade-in">
                <div class="glass-card w-full max-w-sm rounded-2xl p-6 text-center animate-slide-in-up">
                    <h2 class="text-2xl font-serif mb-4">${title}</h2>
                    <div class="text-white/80 mb-6">${content}</div>
                    ${renderButton('Got it!', { attributes: 'data-action="close-modal"' })}
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        const closeModal = () => {
            document.getElementById('app-modal')?.remove();
            if (onclose) onclose();
        };

        const modalElement = document.getElementById('app-modal');
        modalElement.querySelector('[data-action="close-modal"]').addEventListener('click', closeModal);
        modalElement.addEventListener('click', (e) => { if(e.target === modalElement) closeModal(); });
    };

    const renderLoadingModal = (message) => {
        const modalId = 'app-loading-modal';
        document.getElementById(modalId)?.remove();
        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black/70 z-[110] flex items-center justify-center p-4 animate-fade-in">
                <div class="glass-card w-full max-w-xs rounded-2xl p-6 text-center animate-slide-in-up">
                    <div class="w-8 h-8 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-white/80">${message}</p>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    };

    const closeLoadingModal = () => {
        document.getElementById('app-loading-modal')?.remove();
    };

    const renderConfirmationModal = (title, content, onConfirm, options = {}) => {
        const { confirmText = 'Confirm', confirmVariant = 'primary' } = options;
        const modalId = 'app-confirmation-modal';
        document.getElementById(modalId)?.remove();

        const confirmButtonClasses = {
            primary: '',
            destructive: '!bg-rose-600 hover:!bg-rose-700 focus:ring-rose-500 !text-white'
        };
        const titleClasses = {
            primary: '',
            destructive: 'text-rose-400'
        };

        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 animate-fade-in">
                <div class="glass-card w-full max-w-sm rounded-2xl p-6 text-center animate-slide-in-up">
                    <h2 class="text-2xl font-serif mb-4 ${titleClasses[confirmVariant] || ''}">${title}</h2>
                    <div class="text-white/80 mb-6">${content}</div>
                    <div class="flex gap-4 justify-center">
                        ${renderButton('Cancel', { variant: 'secondary', additionalClasses: 'flex-1', attributes: 'data-action="close-confirm-modal"' })}
                        ${renderButton(confirmText, { variant: 'primary', additionalClasses: `flex-1 ${confirmButtonClasses[confirmVariant] || ''}`, attributes: 'data-action="confirm-modal-action"' })}
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        const modalElement = document.getElementById(modalId);
        
        const closeModal = () => modalElement?.remove();
        const confirmAction = () => {
            if (onConfirm) onConfirm();
            closeModal();
        };

        modalElement.querySelector('[data-action="close-confirm-modal"]').addEventListener('click', closeModal);
        modalElement.querySelector('[data-action="confirm-modal-action"]').addEventListener('click', confirmAction);
        modalElement.addEventListener('click', (e) => { if(e.target === modalElement) closeModal(); });
    };

    const renderToast = (message, hasUndo = false) => {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        clearTimeout(toastTimeout);
        container.innerHTML = ''; // Clear previous toast

        const toast = document.createElement('div');
        toast.className = 'glass-card flex items-center justify-between p-3 rounded-xl shadow-lg animate-toast-in';
        
        const undoButton = hasUndo ? `<button data-action="undo" class="font-bold text-teal ml-4">Undo</button>` : '';
        toast.innerHTML = `<span>${message}</span> ${undoButton}`;
        
        container.appendChild(toast);

        const removeToast = () => {
            toast.classList.remove('animate-toast-in');
            toast.classList.add('animate-toast-out');
            toast.addEventListener('animationend', () => toast.remove());
        };

        toastTimeout = setTimeout(removeToast, 4000);
    };

    // --- CELEBRATION LOGIC ---
    const renderTransitionParticles = () => {
        const container = document.getElementById('swipe-area');
        if (!container) return;

        const colors = ['#f6d365', '#4facfe', '#ffffff'];
        for (let i = 0; i < 8; i++) {
            const particle = document.createElement('div');
            particle.className = 'transition-particle';
            particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            particle.style.left = `${20 + Math.random() * 60}%`;
            particle.style.bottom = `${Math.random() * 20}%`;
            particle.style.animation = `particle-effect ${0.5 + Math.random() * 0.5}s ${Math.random() * 0.2}s ease-out forwards`;
            container.appendChild(particle);
            setTimeout(() => particle.remove(), 1000);
        }
    };

    const renderCelebrationModal = (title, description, icon) => {
        const modalId = 'celebration-modal';
        document.getElementById(modalId)?.remove();

        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black/80 z-[110] flex items-center justify-center p-4 animate-fade-in overflow-hidden">
                <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
                <div class="glass-card w-full max-w-sm rounded-2xl p-6 text-center animate-slide-in-up relative">
                    <div class="text-gold mb-4">${icon}</div>
                    <h2 class="text-3xl font-serif mb-3">${title}</h2>
                    <p class="text-white/80 mb-6">${description}</p>
                    ${renderButton('Awesome!', { attributes: `data-action="close-celebration-modal"` })}
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        const modal = document.getElementById(modalId);
        modal.querySelector('[data-action="close-celebration-modal"]').addEventListener('click', () => modal.remove());

        // Create and animate confetti
        const container = document.getElementById('confetti-container');
        const colors = ['#f6d365', '#4facfe', '#764ba2', '#ffffff'];
        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti-piece';
            confetti.style.left = `${Math.random() * 100}vw`;
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animation = `confetti-fall ${2 + Math.random() * 2}s ${Math.random() * 2}s ease-out forwards`;
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            container.appendChild(confetti);
        }
    };

    const triggerCelebration = (type, value) => {
        playSound(type);
        if (type === 'daily') {
            renderCelebrationModal(
                'Daily Goal Achieved!',
                "You've reviewed all your mantras for today. Incredible focus!",
                ICONS.CheckCircle({ size: 64, className: 'mx-auto' })
            );
            state.lastDailyGoalCelebrated = formatDate(new Date());
        } else if (type === 'streak') {
            renderCelebrationModal(
                `${value}-Day Streak!`,
                "Your consistency is building powerful momentum. Keep it up!",
                ICONS.Trophy({ size: 64, className: 'mx-auto' })
            );
            state.lastStreakMilestoneCelebrated = value;
        }
        saveState();
    };

    const checkForCelebrations = () => {
        const today = formatDate(new Date());

        // Check for daily goal completion
        if (state.lastDailyGoalCelebrated !== today && state.userMantras.length > 0) {
            const allMantrasViewedToday = state.userMantras.every(mantra => {
                return state.progress[mantra.id] && state.progress[mantra.id].lastViewed === today;
            });
            if (allMantrasViewedToday) {
                triggerCelebration('daily');
            }
        }
        
        // Check for streak milestone
        const streak = getStreak();
        if (streak > 0 && streak % 7 === 0 && streak !== state.lastStreakMilestoneCelebrated) {
            triggerCelebration('streak', streak);
        }
    };
    
    const renderAudioInterface = (mantraId) => {
        if (!isAudioSupported) {
            return `
                <div class="flex items-center gap-2 text-sm text-white/60" title="Your browser does not support the MediaRecorder API required for voice recording.">
                    ${ICONS.MicOff({size: 20})}
                    <span class="italic">Recording not supported</span>
                </div>
            `;
        }

        if (!state.settings.voiceFeatures.enabled) return '';
    
        const hasRecording = !!state.audioRecordings[mantraId];
        const isRecordingThis = currentlyRecordingMantraId === mantraId;
        const isPlayingThis = currentlyPlayingMantraId === mantraId && !audioPlayer.paused;
        const isPausedThis = currentlyPlayingMantraId === mantraId && audioPlayer.paused && audioPlayer.currentTime > 0;

        if (isRecordingThis) {
            return `
                <div class="flex flex-col items-center gap-3 w-full max-w-xs">
                    <div class="relative flex items-center justify-center w-20 h-20">
                        <div class="absolute w-full h-full border-2 border-rose-500 rounded-full animate-pulse-ring" style="animation-delay: 0s;"></div>
                        <div class="absolute w-full h-full border-2 border-rose-500 rounded-full animate-pulse-ring" style="animation-delay: 1s;"></div>
                        <button data-action="stop-recording" data-mantra-id="${mantraId}" class="relative z-10 p-4 bg-rose-500 rounded-full flex-shrink-0 shadow-lg" aria-label="Stop recording" title="Stop recording">
                            ${ICONS.StopCircle({size: 24})}
                        </button>
                    </div>
                    <div id="audio-timer-${mantraId}" class="text-lg font-mono text-white/80 font-semibold">${MAX_RECORDING_SECONDS}s left</div>
                </div>
            `;
        }
    
        if (hasRecording) {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
            let playbackControls = '';
            
            const playButton = `<button data-action="play-voice" data-mantra-id="${mantraId}" class="p-2 bg-white/20 hover:bg-white/30 rounded-full" aria-label="Play recording" title="Play recording">${ICONS.Play({size: 20})}</button>`;
            const pauseButton = `<button data-action="pause-voice" data-mantra-id="${mantraId}" class="p-2 bg-white/20 hover:bg-white/30 rounded-full" aria-label="Pause recording" title="Pause recording">${ICONS.Pause({size: 20})}</button>`;
            const stopButton = `<button data-action="stop-voice" data-mantra-id="${mantraId}" class="p-2 bg-white/20 hover:bg-white/30 rounded-full" aria-label="Stop playback" title="Stop playback">${ICONS.StopCircle({size: 20})}</button>`;

            if (isPlayingThis) {
                playbackControls = `${pauseButton}${stopButton}`;
            } else if (isPausedThis) {
                playbackControls = `${playButton}${stopButton}`;
            } else { // Stopped state
                playbackControls = playButton;
            }

            return `
                <div class="flex items-center gap-2 w-full max-w-xs">
                    ${playbackControls}
                    <div class="h-1.5 bg-white/20 rounded-full overflow-hidden flex-grow">
                        <div class="h-full bg-teal audio-progress-bar-inner" data-mantra-id="${mantraId}" style="width: ${isPausedThis || isPlayingThis ? progress : 0}%;"></div>
                    </div>
                    <button data-action="record-voice" data-mantra-id="${mantraId}" class="p-2 bg-white/20 hover:bg-white/30 rounded-full" aria-label="Re-record voice memo" title="Re-record your voice">${ICONS.Microphone({size: 20})}</button>
                    <button data-action="delete-voice" data-mantra-id="${mantraId}" class="p-2 bg-white/20 hover:bg-white/30 rounded-full" aria-label="Delete voice memo" title="Delete recording">${ICONS.Trash2({size: 20})}</button>
                </div>
            `;
        }
    
        return `
            <div class="flex items-center gap-2">
                <button data-action="record-voice" data-mantra-id="${mantraId}" class="p-2 bg-white/20 hover:bg-white/30 rounded-full" aria-label="Record voice memo" title="Record your voice">
                    ${ICONS.Microphone({size: 20})}
                </button>
                <span class="text-sm text-white/60">Add Your Voice</span>
            </div>
        `;
    };

    const renderUndoRedoControls = () => {
        const canUndo = undoHistory.length > 0;
        const canRedo = redoHistory.length > 0;
        return `
            <div class="flex gap-2">
                <button data-action="undo" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors disabled:opacity-40 disabled:cursor-not-allowed" aria-label="Undo" title="Undo (Ctrl+Z)" ${!canUndo ? 'disabled' : ''}>
                    ${ICONS.RotateCcw({ size: 20 })}
                </button>
                <button data-action="redo" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors disabled:opacity-40 disabled:cursor-not-allowed" aria-label="Redo" title="Redo (Ctrl+Y)" ${!canRedo ? 'disabled' : ''}>
                    ${ICONS.RotateCw({ size: 20 })}
                </button>
            </div>
        `;
    };

    const renderPage = (content, { showBackButton = false, showUndoRedo = false } = {}) => {
        const isAppView = !window.location.hash.includes('onboarding');
        const headerContent = (showBackButton || showUndoRedo) ? `
            <header class="flex justify-between items-center mb-4">
                ${showBackButton ? `
                    <button data-action="go-back" class="inline-flex items-center gap-2 p-2 pr-4 rounded-full bg-white/10 hover:bg-white/20 transition-colors" aria-label="Go back" title="Go back">
                        ${ICONS.ArrowLeft({ size: 20 })}
                        <span class="text-sm">Back</span>
                    </button>
                ` : '<div></div>'}
                ${showUndoRedo ? renderUndoRedoControls() : ''}
            </header>
        ` : '';

        const mainAppLayout = `
            <div class="relative min-h-screen ${isAppView ? 'pb-24' : ''} animate-fade-in">
                <main class="p-4 md:p-6">${headerContent}${content}</main>
                ${isAppView ? renderBottomNav() : ''}
            </div>
        `;
        root.innerHTML = mainAppLayout;
    };
    
    // --- ONBOARDING VIEWS ---
    const renderOnboarding = (step) => {
        let content = '';
        const backButton = (path) => `
            <div class="absolute top-4 left-4">
                <button data-action="nav" data-path="${path}" class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition-colors" aria-label="Go back" title="Go back">
                    ${ICONS.ArrowLeft({ size: 24 })}
                </button>
            </div>
        `;
        switch(step) {
            case 'welcome':
                content = `
                    <div class="text-center flex flex-col items-center animate-fade-in">
                        ${ICONS.Zap({ size: 64, className: "mb-4 text-gold" })}
                        <h1 class="text-4xl font-serif mb-4">Welcome to MantraOS</h1>
                        <p class="text-lg text-white/80 mb-8">Your personal space to cultivate positivity, focus, and inner strength.</p>
                        ${renderButton('Begin Your Journey', { attributes: 'data-action="nav" data-path="/onboarding/categories"'})}
                    </div>`;
                break;
            case 'categories':
                 content = `
                    ${backButton('/onboarding/welcome')}
                    <div class="text-center animate-fade-in">
                        ${ICONS.Layers({ size: 48, className: "mx-auto mb-4 text-teal" })}
                        <h2 class="text-3xl font-serif mb-4">Focus Your Intentions</h2>
                        <p class="text-white/80 mb-6">We'll start by selecting from key life areas to personalize your experience.</p>
                        <div class="flex flex-wrap justify-center gap-2 mb-8">${CATEGORIES.filter(c => c !== 'AI Generated').map(cat => `<span class="bg-white/20 px-3 py-1 rounded-full text-sm">${cat}</span>`).join('')}</div>
                        ${renderButton('Choose My Mantras', { attributes: 'data-action="nav" data-path="/onboarding/mantras"'})}
                    </div>`;
                break;
            case 'mantras':
                const selectionCount = state.onboardingTempMantras.length;
                const isNextDisabled = selectionCount < 3;
                let feedbackText;
                let feedbackColorClass = 'text-white/60'; // Default color

                if (selectionCount < 3) {
                    const remaining = 3 - selectionCount;
                    feedbackText = `Please select ${remaining} more mantra${remaining > 1 ? 's' : ''}.`;
                    feedbackColorClass = 'text-yellow-300';
                } else if (selectionCount >= 3 && selectionCount < 5) {
                    const remaining = 5 - selectionCount;
                    feedbackText = `Great! You can select up to ${remaining} more or continue.`;
                    feedbackColorClass = 'text-teal-300';
                } else if (selectionCount === 5) {
                    feedbackText = `Maximum selected. You're ready to proceed!`;
                    feedbackColorClass = 'text-teal-300';
                } else {
                    // This case is currently unreachable due to the click handler logic
                    // but we'll leave it for robustness.
                    feedbackText = 'Select between 3 and 5 mantras.';
                    feedbackColorClass = 'text-red-400';
                }

                content = `
                    ${backButton('/onboarding/categories')}
                    <div class="text-center w-full max-w-md mx-auto animate-fade-in" id="mantra-selection-view">
                        <h2 class="text-3xl font-serif mb-2">Select 3-5 Core Mantras</h2>
                        <p class="text-white/80 mb-6">Choose affirmations that resonate with you.</p>
                        <div class="flex flex-wrap justify-center gap-2 mb-4">
                            ${CATEGORIES.filter(c => c !== 'AI Generated').map(cat => `<button class="px-3 py-1 text-sm rounded-full transition-colors bg-white/20 text-white" data-action="filter-mantras" data-category="${cat}">${cat}</button>`).join('')}
                        </div>
                        <div class="h-64 overflow-y-auto pr-2 space-y-3 mb-6" id="mantra-list"></div>
                        ${renderButton(`Next (${selectionCount} selected)`, { attributes: `data-action="nav" data-path="/onboarding/custom" ${isNextDisabled ? 'disabled' : ''}`})}
                        <p class="text-sm mt-2 font-medium transition-colors ${feedbackColorClass}">${feedbackText}</p>
                    </div>`;
                break;
            case 'custom':
                 content = `
                    ${backButton('/onboarding/mantras')}
                    <div class="text-center max-w-md mx-auto animate-fade-in">
                        ${ICONS.Edit({ size: 48, className: "mx-auto mb-4 text-gold" })}
                        <h2 class="text-3xl font-serif mb-4">Add Your Own Voice</h2>
                        <p class="text-white/80 mb-6">Create mantras that are uniquely meaningful to you.</p>
                        <div class="space-y-4 mb-8">
                            <textarea id="custom-mantra-text" placeholder="e.g., I am a creative powerhouse." class="w-full h-24 p-3 bg-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white"></textarea>
                            <select id="custom-mantra-category" class="w-full p-3 bg-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white">
                                ${CATEGORIES.filter(c => c !== 'AI Generated').map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                            <select id="custom-mantra-priority" class="w-full p-3 bg-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white">
                                <option value="Medium">Medium Priority</option>
                                <option value="High">High Priority</option>
                                <option value="Low">Low Priority</option>
                            </select>
                            ${renderButton('Add Custom Mantra', { variant: 'secondary', attributes: 'data-action="add-custom-onboarding"'})}
                        </div>
                        ${renderButton('Continue', { attributes: 'data-action="nav" data-path="/onboarding/final"'})}
                    </div>`;
                break;
            case 'final':
                content = `
                    ${backButton('/onboarding/custom')}
                    <div class="text-center animate-fade-in">
                        ${ICONS.CheckCircle({ size: 64, className: "mx-auto mb-4 text-teal" })}
                        <h2 class="text-4xl font-serif mb-4">You're All Set!</h2>
                        <p class="text-lg text-white/80 mb-8">Your personalized MantraOS is ready. Begin your journey.</p>
                        ${renderButton('Enter MantraOS', { additionalClasses: 'animate-pulse', attributes: 'data-action="finish-onboarding"'})}
                    </div>`;
                break;
        }
        root.innerHTML = `<div class="min-h-screen w-full flex flex-col items-center justify-center p-4 theme-gradient-1 text-white relative">${content}</div>`;
        if (step === 'mantras') renderMantraSelectionList(CATEGORIES.filter(c => c !== 'AI Generated')[0]);
    };

    function renderMantraSelectionList(category) {
        const container = document.getElementById('mantra-list');
        if (!container) return;
        const mantras = CURATED_MANTRAS.filter(m => m.category === category);
        container.innerHTML = mantras.map(mantra => {
            const isSelected = state.onboardingTempMantras.some(m => m.id === mantra.id);
            return `
                <div class="glass-card text-left p-4 cursor-pointer border-2 ${isSelected ? 'border-teal' : 'border-transparent'}" data-action="toggle-onboarding-mantra" data-mantra-id='${mantra.id}'>
                    <div class="flex items-center justify-between">
                        <p class="pointer-events-none">"${getMantraText(mantra)}"</p>
                        ${isSelected ? ICONS.Check({ className: 'text-teal pointer-events-none', size: 20 }) : ''}
                    </div>
                </div>`;
        }).join('');
        // Highlight active category button
        document.querySelectorAll('[data-action="filter-mantras"]').forEach(btn => {
            btn.classList.toggle('bg-white', btn.dataset.category === category);
            btn.classList.toggle('text-deep-purple', btn.dataset.category === category);
            btn.classList.toggle('font-semibold', btn.dataset.category === category);
            btn.classList.toggle('bg-white/20', btn.dataset.category !== category);
        });
    }

    // --- MAIN APP VIEWS ---
    const renderBottomNav = () => {
        const navItems = [
          { path: '/dashboard', label: 'Home', icon: ICONS.Home },
          { path: '/affirmations', label: 'Affirm', icon: ICONS.Smile },
          { path: '/library', label: 'Library', icon: ICONS.Library },
          { path: '/progress', label: 'Progress', icon: ICONS.BarChart2 },
          { path: '/settings', label: 'Settings', icon: ICONS.Settings },
        ];
        const currentPath = window.location.hash.slice(1) || '/dashboard';
        return `
            <nav class="fixed bottom-0 left-0 right-0 h-20 glass-card rounded-t-3xl shadow-lg z-50">
                <div class="flex justify-around items-center h-full max-w-lg mx-auto">
                ${navItems.map(({ path, label, icon }) => {
                    const isActive = currentPath.startsWith(path);
                    return `
                    <a href="#${path}" aria-label="${label}" title="${label}" class="flex flex-col items-center justify-center w-16 h-16 rounded-2xl transition-all duration-300 ${isActive ? 'bg-white/20 scale-110' : 'text-white/70 hover:bg-white/10'}">
                        ${icon({ size: 24 })}
                        <span class="text-xs mt-1">${label}</span>
                    </a>`
                }).join('')}
                </div>
            </nav>
        `;
    };

    const renderDashboard = () => {
        // --- Daily Affirmation Logic ---
        const checkAndShowAffirmation = () => {
            const { affirmation } = state.settings.notifications;
            if (!affirmation.enabled || state.userAffirmations.length === 0) return;

            const today = new Date().toISOString().split('T')[0];
            
            if (!state.dailyAffirmation || state.dailyAffirmation.date !== today) {
                const randomAffirmation = state.userAffirmations[Math.floor(Math.random() * state.userAffirmations.length)];
                state.dailyAffirmation = { text: randomAffirmation.text, date: today, seen: false };
                saveState();
            }
            
            if (state.dailyAffirmation && !state.dailyAffirmation.seen) {
                const [hour, minute] = affirmation.time.split(':');
                const scheduledTime = new Date();
                scheduledTime.setHours(hour, minute, 0, 0);
                
                if (new Date() >= scheduledTime) {
                    renderModal('Your Daily Affirmation', `<p class="text-xl italic">"${state.dailyAffirmation.text}"</p>`, () => {
                        state.dailyAffirmation.seen = true;
                        saveState();
                        renderDashboard(); // Re-render to show affirmation on dash
                    });
                }
            }
        };
        checkAndShowAffirmation();

        let showAffirmationOnDash = false;
        if (state.dailyAffirmation) {
            const { affirmation } = state.settings.notifications;
            if (affirmation.enabled) {
                if (state.dailyAffirmation.seen) showAffirmationOnDash = true;
            } else {
                showAffirmationOnDash = true;
            }
        }
        
        const dailyAffirmationHtml = (showAffirmationOnDash && state.dailyAffirmation) ? `
            <div class="my-4 text-center animate-slide-in-up">
                <p class="text-sm font-semibold uppercase tracking-wider text-white/70 mb-1">Your Daily Affirmation</p>
                <p class="text-lg italic font-sans">"${state.dailyAffirmation.text}"</p>
            </div>
        ` : '';
        // --- End Affirmation Logic ---
        
        let content;
        if (state.userMantras.length === 0) {
            content = `
                <div class="flex flex-col items-center justify-center h-[calc(100vh-10rem)] text-center">
                    ${dailyAffirmationHtml}
                    <h2 class="text-2xl font-serif mb-4">Your mantra space is empty.</h2>
                    <p class="mb-6 text-white/80">Add some mantras from the library to get started!</p>
                    <a href="#/library" aria-label="Go to Library to add mantras">${renderButton(`${ICONS.PlusCircle({className: 'inline-block mr-2', size: 20})} Go to Library`)}</a>
                </div>
            `;
        } else {
            const currentMantra = state.userMantras[state.currentMantraIndex];
            recordMantraView(currentMantra.id);
            
            const streak = getStreak();
            const streakIcon = streak > 0 ? ICONS.Zap({ size: 16, className: 'inline-block text-gold -mt-1 mr-1' }) : '';
            const priorityColor = PRIORITIES[currentMantra?.priority] || PRIORITIES['Medium'];

            const slideshowProgressBar = state.settings.slideshow.enabled && state.userMantras.length > 1 ? `
                <div class="w-full h-1 bg-white/20 rounded-full overflow-hidden mt-2">
                    <div class="h-full bg-teal" style="animation: slideshow-progress ${state.settings.slideshow.interval}s linear forwards;"></div>
                </div>
            ` : '';
            
            const canRewrite = isAnyAiFeatureEnabled();
            const rephraseButton = canRewrite ? `
                <button data-action="rewrite-mantra" data-mantra-id="${currentMantra?.id}" class="absolute top-2 right-2 p-2 bg-white/10 hover:bg-white/20 rounded-full" aria-label="Rephrase this mantra using AI" title="Rephrase mantra">
                    ${ICONS.Wand2({size: 20})}
                </button>
            ` : '';

            content = `
                <div class="flex flex-col h-[calc(100vh-8rem)] justify-between">
                  <div class="flex justify-around text-center glass-card p-3 rounded-full">
                    <div><p class="text-sm text-white/70">Total Views</p><p class="font-bold text-lg">${getTotalViews()}</p></div>
                    <div><p class="text-sm text-white/70">Current Streak</p><p class="font-bold text-lg">${streakIcon}${streak} days</p></div>
                    <div><p class="text-sm text-white/70">Views Today</p><p class="font-bold text-lg">${state.progress[currentMantra?.id]?.views || 0}</p></div>
                  </div>
                  
                  ${dailyAffirmationHtml}

                  <div id="swipe-area" class="flex-grow flex items-center justify-center relative overflow-hidden">
                    ${rephraseButton}
                    <p id="mantra-text" class="text-4xl md:text-6xl font-serif text-center leading-tight animate-fade-in animate-float">"${getMantraText(currentMantra)}"</p>
                  </div>
                  <div class="text-center">
                    <div id="audio-controls-${currentMantra?.id}" class="flex justify-center mb-4">
                        ${renderAudioInterface(currentMantra?.id)}
                    </div>
                    <p class="bg-white/20 inline-flex items-center px-3 py-1 rounded-full text-sm mb-4">
                        <span class="w-2.5 h-2.5 ${priorityColor} rounded-full mr-2"></span>
                        ${currentMantra?.category}
                    </p>
                    <div class="flex justify-center mt-4 space-x-2" id="dot-indicators">
                        ${state.userMantras.map((_, index) => `<button data-action="set-mantra-index" data-index="${index}" class="w-2 h-2 rounded-full transition-colors ${state.currentMantraIndex === index ? 'bg-white' : 'bg-white/30'}" aria-label="Go to mantra ${index + 1}" title="Go to mantra ${index + 1}"></button>`).join('')}
                    </div>
                    ${slideshowProgressBar}
                  </div>
                </div>`;
        }
        renderPage(content);
        if (state.userMantras.length > 0) {
            setupSwipeListeners();
            startSlideshow();
        }
    };

    const renderAffirmations = () => {
        let content;
        if (state.userAffirmations.length === 0) {
            content = `
                <div class="flex flex-col items-center justify-center h-[calc(100vh-10rem)] text-center">
                    <h2 class="text-2xl font-serif mb-4">No affirmations yet.</h2>
                    <p class="mb-6 text-white/80">Visit the library to add your first daily affirmation.</p>
                    <a href="#/library" aria-label="Go to Library to add affirmations">${renderButton(`${ICONS.PlusCircle({className: 'inline-block mr-2', size: 20})} Add Affirmation`)}</a>
                </div>
            `;
        } else {
            const randomAffirmation = state.userAffirmations[Math.floor(Math.random() * state.userAffirmations.length)];
            content = `
                <div class="flex flex-col h-[calc(100vh-12rem)] items-center justify-center text-center">
                    <h1 class="text-2xl font-serif mb-8 text-white/80">Today's Affirmation</h1>
                    <p class="text-4xl md:text-5xl font-serif leading-tight">"${randomAffirmation.text}"</p>
                </div>
            `;
        }
        renderPage(content, { showBackButton: true, showUndoRedo: true });
    };

    const renderLibrary = () => {
        const content = `
            <div id="library-view">
                <h1 class="text-4xl font-serif text-center mb-6">Library</h1>
                <div class="flex justify-center mb-6 border-b-2 border-white/20">
                    <button data-action="library-tab" data-tab="curated" class="px-4 py-2 transition-colors text-white border-b-2 border-teal">Discover</button>
                    <button data-action="library-tab" data-tab="my-mantras" class="px-4 py-2 transition-colors text-white/60 border-b-2 border-transparent">My Mantras (${state.userMantras.length})</button>
                    <button data-action="library-tab" data-tab="my-affirmations" class="px-4 py-2 transition-colors text-white/60 border-b-2 border-transparent">My Affirmations (${state.userAffirmations.length})</button>
                </div>
                <div id="library-content"></div>
            </div>`;
        renderPage(content, { showBackButton: true, showUndoRedo: true });
        renderLibraryContent('curated');
    };
    
    const renderLibraryContent = (tab, options = {}) => {
        const { category = CATEGORIES[0], searchTerm = '', priorityFilter = 'All' } = options;
        const container = document.getElementById('library-content');
        if (!container) return;
        
        const showAiFeatures = isAnyAiFeatureEnabled();

        let content = '';
        if (tab === 'curated') {
            let mantras = CURATED_MANTRAS.filter(m => m.category === category);
            if (searchTerm.trim()) {
                const lowerSearchTerm = searchTerm.trim().toLowerCase();
                mantras = mantras.filter(m => getMantraText(m).toLowerCase().includes(lowerSearchTerm));
            }
            
            const aiGenerateButton = showAiFeatures ? `
                <div class="my-4 text-center">
                    ${renderButton(`${ICONS.Sparkles({className: 'inline-block mr-2', size: 20})} Generate with AI`, {
                        variant: 'secondary',
                        attributes: 'data-action="open-ai-generate-modal" title="Generate mantras with AI"'
                    })}
                </div>
            ` : '';

            content = `
                ${aiGenerateButton}
                <div class="relative mb-4">
                    <input type="search" id="mantra-search-input" value="${searchTerm}" placeholder="Search in ${category}..." class="w-full bg-white/10 rounded-full py-2 pl-10 pr-4 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-white/50">
                        ${ICONS.Search({ size: 20 })}
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-2 mb-4">
                    ${CATEGORIES.map(cat => `<button data-action="library-filter" data-category="${cat}" class="px-3 py-1 text-sm rounded-full transition-colors ${category === cat ? 'bg-white text-deep-purple font-semibold' : 'bg-white/20 text-white'}" aria-label="Filter by ${cat}" title="Filter by ${cat}">${cat}</button>`).join('')}
                </div>
                <div class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                ${mantras.length > 0 ? mantras.map(mantra => {
                    const isAdded = state.userMantras.some(m => m.id === mantra.id);
                    return `
                    <div class="glass-card p-4 flex justify-between items-center">
                        <p class="flex-grow">"${getMantraText(mantra)}"</p>
                        <button data-action="toggle-library-mantra" data-mantra-id='${mantra.id}' class="ml-4 p-2 rounded-full transition-colors ${isAdded ? 'bg-teal text-white' : 'bg-white/20 hover:bg-white/30'}" aria-label="${isAdded ? 'Remove this mantra from your list' : 'Add this mantra to your list'}" title="${isAdded ? 'Remove from My Mantras' : 'Add to My Mantras'}">
                            ${isAdded ? ICONS.Check({ size: 16 }) : ICONS.Plus({ size: 16 })}
                        </button>
                    </div>`;
                }).join('') : `<div class="text-center p-8"><p class="text-white/80">No mantras found for your search.</p></div>`}
                </div>
            `;
        } else if (tab === 'my-mantras') {
            if (state.userMantras.length === 0) {
                content = `<div class="text-center p-8"><p class="text-white/80">You haven't added any mantras yet. Explore the 'Discover' tab!</p></div>`;
            } else {
                const priorityButtons = ['All', ...PRIORITY_LEVELS].map(p => {
                    const isActive = priorityFilter === p;
                    return `<button data-action="library-priority-filter" data-priority="${p}" class="px-3 py-1 text-sm rounded-full transition-colors ${isActive ? 'bg-white text-deep-purple font-semibold' : 'bg-white/20 text-white'}" aria-label="Filter by ${p} priority" title="Filter by ${p} priority">${p}</button>`;
                }).join('');

                const filteredMantras = priorityFilter === 'All'
                    ? state.userMantras
                    : state.userMantras.filter(m => m.priority === priorityFilter);

                const priorityValues = { 'High': 3, 'Medium': 2, 'Low': 1 };
                const sortedMantras = [...filteredMantras].sort((a, b) => {
                    switch (myMantrasSortOrder) {
                        case 'date-asc':
                            return (a.createdAt || 0) - (b.createdAt || 0);
                        case 'priority-desc':
                            return (priorityValues[b.priority] || 0) - (priorityValues[a.priority] || 0);
                        case 'priority-asc':
                            return (priorityValues[a.priority] || 0) - (priorityValues[b.priority] || 0);
                        case 'date-desc':
                        default:
                            return (b.createdAt || 0) - (a.createdAt || 0);
                    }
                });

                content = `
                    <div class="flex flex-wrap justify-center gap-2 mb-4">
                        ${priorityButtons}
                    </div>
                    <div class="flex justify-center items-center mb-4">
                        <label for="mantra-sort-select" class="text-sm text-white/70 mr-2">Sort by:</label>
                        <select id="mantra-sort-select" data-action="set-mantra-sort" class="bg-white/10 rounded-md py-1 px-2 text-white focus:outline-none focus:ring-2 focus:ring-white">
                            <option value="date-desc" ${myMantrasSortOrder === 'date-desc' ? 'selected' : ''}>Newest First</option>
                            <option value="date-asc" ${myMantrasSortOrder === 'date-asc' ? 'selected' : ''}>Oldest First</option>
                            <option value="priority-desc" ${myMantrasSortOrder === 'priority-desc' ? 'selected' : ''}>Priority (High to Low)</option>
                            <option value="priority-asc" ${myMantrasSortOrder === 'priority-asc' ? 'selected' : ''}>Priority (Low to High)</option>
                        </select>
                    </div>
                    <div class="space-y-3 max-h-[55vh] overflow-y-auto pr-2">
                    ${sortedMantras.length > 0 ? sortedMantras.map(mantra => {
                        const priorityColor = PRIORITIES[mantra.priority] || PRIORITIES['Medium'];
                        const canRewrite = isAnyAiFeatureEnabled();
                        const rephraseButton = canRewrite ? `
                            <button data-action="rewrite-mantra" data-mantra-id="${mantra.id}" class="p-2 rounded-full bg-white/20 hover:bg-white/30 flex-shrink-0" aria-label="Rephrase this mantra using AI" title="Rephrase mantra">
                                ${ICONS.Wand2({ size: 16 })}
                            </button>
                        ` : '';

                        return `
                        <div class="glass-card p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <p class="pr-4 flex-grow">"${getMantraText(mantra)}"</p>
                                <div class="flex gap-2">
                                    ${rephraseButton}
                                    <button data-action="toggle-library-mantra" data-mantra-id='${mantra.id}' class="p-2 rounded-full bg-white/20 hover:bg-white/30 flex-shrink-0" aria-label="Remove this mantra" title="Remove mantra">
                                        ${ICONS.Trash2({ size: 16 })}
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-white/10">
                                <div id="audio-controls-${mantra.id}" class="mb-3">
                                    ${renderAudioInterface(mantra.id)}
                                </div>
                                <div class="flex items-center justify-between">
                                     <div class="flex items-center gap-2">
                                        <span class="text-xs bg-white/10 px-2 py-0.5 rounded-full">${mantra.category}</span>
                                        <span class="text-xs px-2 py-0.5 rounded-full ${priorityColor} font-semibold text-white">${mantra.priority}</span>
                                     </div>
                                    <div class="flex items-center gap-2">
                                        ${PRIORITY_LEVELS.map(p => `
                                            <button data-action="set-mantra-priority" data-mantra-id="${mantra.id}" data-priority="${p}" class="px-2 py-0.5 text-xs rounded-full transition-colors ${mantra.priority === p ? 'bg-white text-deep-purple font-bold' : 'bg-white/20 hover:bg-white/30'}" aria-label="Set priority to ${p}" title="Set priority to ${p}">${p}</button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        `}).join('') : `<div class="text-center p-8"><p class="text-white/80">No mantras found with this priority.</p></div>`}
                    </div>`;
            }
            const canProofread = state.settings.aiFeatures.enabled && (state.aiStatus.proofreader || state.settings.demoMode.enabled);
            const canSuggest = state.settings.aiFeatures.enabled && (state.aiStatus.text || state.settings.demoMode.enabled);
            content += `
                <div class="mt-6 border-t border-white/20 pt-4">
                    <h3 class="text-lg font-semibold text-center mb-3">Create Your Own Mantra</h3>
                    <div class="space-y-3">
                        <textarea id="new-custom-mantra-text" class="w-full p-3 bg-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white resize-none" placeholder="e.g., I am resilient and strong." maxlength="150" rows="3"></textarea>
                        <div id="new-mantra-char-count" class="text-right text-xs text-white/60">0/150</div>
                        <div id="proofread-suggestion" class="hidden text-sm p-2 bg-teal/20 rounded-lg text-left"></div>
                        <div id="ai-suggestion-container" class="space-y-2"></div>
                        <select id="new-custom-mantra-category" class="w-full p-3 bg-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white">
                            ${CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>
                        <select id="new-custom-mantra-priority" class="w-full p-3 bg-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white">
                            <option value="Medium">Medium Priority</option>
                            <option value="High">High Priority</option>
                            <option value="Low">Low Priority</option>
                        </select>
                        <div class="flex gap-2">
                            ${canProofread ? `<button data-action="proofread-mantra" id="proofread-mantra-btn" class="flex-1 p-3 rounded-full bg-white/20 text-white hover:bg-white/30 transition-colors disabled:opacity-50 flex items-center justify-center gap-2" disabled aria-label="Check grammar for the text above" title="Check grammar">${ICONS.CheckCircle({size:20})}<span>Grammar</span></button>` : ''}
                            ${canSuggest ? `<button data-action="suggest-phrasing" id="suggest-phrasing-btn" class="flex-1 p-3 rounded-full bg-white/20 text-white hover:bg-white/30 transition-colors disabled:opacity-50 flex items-center justify-center gap-2" disabled aria-label="Suggest alternative phrasing for the text above" title="Suggest alternative phrasing">${ICONS.Wand2({size:20})}<span>Suggest</span></button>` : ''}
                            <button data-action="add-new-custom-mantra" id="add-custom-mantra-btn" class="flex-1 p-3 font-semibold rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-transparent disabled:opacity-50 disabled:cursor-not-allowed bg-white/20 text-white hover:bg-white/30 focus:ring-white flex items-center justify-center gap-2" disabled aria-label="Add this new mantra to your list" title="Add new mantra">${ICONS.Plus({size: 20})}<span>Add</span></button>
                        </div>
                    </div>
                </div>
            `;
        } else if (tab === 'my-affirmations') {
            const aiGenerateButton = showAiFeatures ? `
                <div class="my-4 text-center">
                    ${renderButton(`${ICONS.Sparkles({className: 'inline-block mr-2', size: 20})} Generate with AI`, {
                        variant: 'secondary',
                        attributes: 'data-action="open-ai-affirmation-modal" title="Generate affirmations with AI"'
                    })}
                </div>
            ` : '';

            content = aiGenerateButton;

             if (state.userAffirmations.length === 0) {
                content += `
                    <div class="text-center p-8">
                        <p class="text-white/80 mb-4">Add your personal affirmations to see them here.</p>
                    </div>
                `;
            } else {
                content += `<div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">${state.userAffirmations.map(affirmation => `
                    <div class="glass-card p-4 flex justify-between items-center">
                        <p>"${affirmation.text}"</p>
                        <button data-action="remove-affirmation" data-affirmation-id='${affirmation.id}' class="ml-4 p-2 rounded-full bg-white/20 hover:bg-white/30" aria-label="Remove this affirmation" title="Remove affirmation">
                           ${ICONS.Trash2({ size: 16 })}
                        </button>
                    </div>`).join('')}</div>`;
            }
            content += `
                <div class="mt-6 border-t border-white/20 pt-4">
                    <h3 class="text-lg font-semibold text-center mb-3">Add a New Affirmation</h3>
                    <div class="space-y-2">
                        <textarea id="new-affirmation-input" class="w-full p-3 bg-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white resize-none" placeholder="e.g., I am confident and capable." maxlength="150" rows="3"></textarea>
                        <div class="flex justify-between items-center">
                            <span id="char-count" class="text-xs text-white/60">0/150</span>
                            ${renderButton('Add Affirmation', { variant: 'secondary', attributes: 'data-action="add-new-affirmation" id="add-affirmation-btn" disabled' })}
                        </div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = content;
        
        // Update active tab style
        document.querySelectorAll('[data-action="library-tab"]').forEach(btn => {
            const isSelected = btn.dataset.tab === tab;
            btn.classList.toggle('border-teal', isSelected);
            btn.classList.toggle('text-white', isSelected);
            btn.classList.toggle('border-transparent', !isSelected);
            btn.classList.toggle('text-white/60', !isSelected);
        });
    };

    const renderProgress = () => {
        const totalViews = getTotalViews();
        const streak = getStreak();
        const longestStreak = getLongestStreak();
        const mostViewedMantra = Object.entries(state.progress).sort(([,a],[,b]) => b.views - a.views)[0];
        let mostViewedText = 'No views yet.';
        if (mostViewedMantra) {
            const mantra = state.userMantras.find(m => m.id === mostViewedMantra[0]) || CURATED_MANTRAS.find(m => m.id === mostViewedMantra[0]);
            if (mantra) mostViewedText = `"${getMantraText(mantra)}" (${mostViewedMantra[1].views} views)`;
        }

        const content = `
            <div>
                <h1 class="text-4xl font-serif text-center mb-6">Your Progress</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="glass-card p-4 rounded-xl text-center"><p class="text-sm text-white/70">Total Views</p><p class="text-2xl font-bold">${totalViews}</p></div>
                    <div class="glass-card p-4 rounded-xl text-center"><p class="text-sm text-white/70">Current Streak</p><p class="text-2xl font-bold">${streak} Days</p></div>
                    <div class="glass-card p-4 rounded-xl text-center"><p class="text-sm text-white/70">Longest Streak</p><p class="text-2xl font-bold">${longestStreak} Days</p></div>
                </div>
                <div class="glass-card p-4 rounded-xl mb-6"><p class="text-sm text-white/70">Most Frequent Mantra</p><p class="font-semibold">${mostViewedText}</p></div>

                <div class="glass-card p-4 rounded-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-center">Achievements (${state.achievements.filter(a=>a.unlocked).length}/${state.achievements.length})</h2>
                    <div class="space-y-3">
                    ${state.achievements.map(a => `
                        <div class="flex items-center gap-4 ${a.unlocked ? '' : 'opacity-50'}">
                            <div class="p-2 rounded-full ${a.unlocked ? 'bg-gold' : 'bg-white/20'}">${ICONS.Award({ color: a.unlocked ? '#fff' : 'currentColor' })}</div>
                            <div>
                                <p class="font-semibold">${a.title}</p>
                                <p class="text-sm text-white/70">${a.description}</p>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>

                <div class="glass-card p-4 rounded-xl">
                    <div id="calendar-container"></div>
                </div>
            </div>
        `;
        renderPage(content, { showBackButton: true });

        // --- Interactive Calendar Rendering ---
        const calendarContainer = document.getElementById('calendar-container');
        
        const renderCalendar = () => {
            const year = calendarViewDate.getFullYear();
            const month = calendarViewDate.getMonth();

            const viewedDates = new Set(Object.values(state.progress).map(p => p.lastViewed));
            const today = new Date();
            const todayStr = formatDate(today);

            const date = new Date(year, month);
            const monthName = date.toLocaleString('default', { month: 'long' });
            const yearNum = date.getFullYear();

            const firstDayOfMonth = new Date(year, month, 1);
            const startingDayOfWeek = firstDayOfMonth.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const daysOfWeekHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(day => 
                `<div class="text-center text-xs text-white/60 font-semibold">${day}</div>`
            ).join('');

            let calendarCells = Array.from({ length: startingDayOfWeek }, () => '<div></div>').join('');

            for (let day = 1; day <= daysInMonth; day++) {
                const cellDate = new Date(year, month, day);
                const dateStr = formatDate(cellDate);
                const isToday = (dateStr === todayStr);
                const wasViewed = viewedDates.has(dateStr);
                
                let cellClasses = 'w-8 h-8 flex items-center justify-center rounded-full text-xs transition-colors ';
                if (isToday) cellClasses += 'ring-2 ring-white ';
                if (wasViewed) cellClasses += 'bg-teal ';
                else cellClasses += 'bg-white/10 ';
                
                calendarCells += `<div class="${cellClasses}">${day}</div>`;
            }

            calendarContainer.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button data-action="prev-month" class="p-2 rounded-full hover:bg-white/20 transition-colors" aria-label="Previous month" title="Previous month">${ICONS.ArrowLeft({size: 20})}</button>
                    <div class="text-center">
                         <h2 class="text-xl font-semibold text-center">${monthName} ${yearNum}</h2>
                         <button data-action="calendar-today" class="text-xs text-teal hover:underline">Go to Today</button>
                    </div>
                    <button data-action="next-month" class="p-2 rounded-full hover:bg-white/20 transition-colors" aria-label="Next month" title="Next month">${ICONS.ArrowRight({size: 20})}</button>
                </div>
                <div class="grid grid-cols-7 gap-y-2 place-items-center mt-2">
                    ${daysOfWeekHeaders}
                    ${calendarCells}
                </div>
            `;
        };
        
        const updateCalendar = (offset) => {
            calendarViewDate.setMonth(calendarViewDate.getMonth() + offset);
            renderCalendar();
        };

        calendarContainer.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;

            if (action === 'prev-month') updateCalendar(-1);
            if (action === 'next-month') updateCalendar(1);
            if (action === 'calendar-today') {
                calendarViewDate = new Date();
                renderCalendar();
            }
        });

        renderCalendar();
    };

    const renderSettings = () => {
        const s = state.settings;
        const n = s.notifications;

        const renderTimeSlot = (period) => {
            const setting = n.mantras[period]; // { enabled: bool, time: 'HH:mm' }
            return `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="notif-${period}-enabled" data-action="set-notification-prop" data-type="mantras" data-period="${period}" data-prop="enabled" ${setting.enabled ? 'checked' : ''} class="accent-teal h-5 w-5 rounded">
                        <label for="notif-${period}-enabled" class="capitalize">${period}</label>
                    </div>
                    <input type="time" value="${setting.time}" data-action="set-notification-prop" data-type="mantras" data-period="${period}" data-prop="time" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm w-24" ${!setting.enabled ? 'disabled' : ''}>
                </div>`;
        };

        const renderAiDefaultParamControls = () => {
            const { creativity, tone, length } = s.aiSettings;
            return `
                 <div class="p-3 bg-black/20 rounded-lg space-y-3">
                    <h3 class="font-semibold mb-2">Default AI Parameters</h3>
                    <div class="flex justify-between items-center text-sm">
                        <label for="ai-default-creativity">Creativity</label>
                        <select id="ai-default-creativity" data-action="set-ai-setting" data-key="creativity" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                            <option value="focused" ${creativity === 'focused' ? 'selected' : ''}>Focused</option>
                            <option value="balanced" ${creativity === 'balanced' ? 'selected' : ''}>Balanced</option>
                            <option value="creative" ${creativity === 'creative' ? 'selected' : ''}>Creative</option>
                        </select>
                    </div>
                     <div class="flex justify-between items-center text-sm">
                        <label for="ai-default-tone">Tone</label>
                        <select id="ai-default-tone" data-action="set-ai-setting" data-key="tone" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                            <option value="inspirational" ${tone === 'inspirational' ? 'selected' : ''}>Inspirational</option>
                            <option value="assertive" ${tone === 'assertive' ? 'selected' : ''}>Assertive</option>
                            <option value="gentle" ${tone === 'gentle' ? 'selected' : ''}>Gentle</option>
                            <option value="calm" ${tone === 'calm' ? 'selected' : ''}>Calm</option>
                        </select>
                    </div>
                     <div class="flex justify-between items-center text-sm">
                        <label for="ai-default-length">Length</label>
                        <select id="ai-default-length" data-action="set-ai-setting" data-key="length" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                            <option value="short" ${length === 'short' ? 'selected' : ''}>Short</option>
                            <option value="medium" ${length === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="long" ${length === 'long' ? 'selected' : ''}>Long</option>
                        </select>
                    </div>
                </div>
            `;
        }

        const AIStatusPanel = `
            <div class="glass-card p-4 rounded-xl mb-4">
              <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                ${ICONS.Cpu({size: 20})}
                On-Device AI System
                ${!state.aiStatus.supported ? `<span class="px-2 py-1 text-xs rounded-full bg-rose-500 text-white">Unavailable</span>` : ''}
              </h3>
              
              <div class="space-y-3 text-sm">
                ${Object.entries({
                    '🤖 AI Mantra Generation': state.aiStatus.text,
                    '🌍 Real-time Translation': state.aiStatus.translator,
                    '✨ Smart Rephrasing': state.aiStatus.rewriter,
                    '✍️ Grammar Check': state.aiStatus.proofreader,
                    '🎤 Multimodal Audio Input': state.aiStatus.assistant,
                }).map(([label, isAvailable]) => `
                <div class="flex justify-between items-center">
                  <span>${label}</span>
                  <span class="px-2 py-1 rounded-full ${isAvailable ? 'bg-teal' : 'bg-gray-500'} text-white text-xs">${isAvailable ? 'Available' : 'Unavailable'}</span>
                </div>
                `).join('')}
              </div>

              <div class="mt-3 p-3 bg-blue-500/20 rounded-lg">
                <p class="text-xs text-white/80">
                  <strong>Status:</strong> ${state.aiStatus.supported ? 'On-device AI detected.' : 'On-device AI not detected in your browser.'}
                  ${!state.aiStatus.supported ? ' Enable demo mode to simulate these features.' : ''}
                </p>
              </div>
            </div>
        `;
        
        const aiFeaturesSection = `
            <div class="glass-card p-4 rounded-xl mb-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center gap-2">${ICONS.Sparkles({size: 20})} AI & Demo Mode</h2>
                    <button data-action="toggle-ai-features" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${s.aiFeatures.enabled ? 'bg-teal' : 'bg-white/20'}">
                        <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${s.aiFeatures.enabled ? 'translate-x-6' : 'translate-x-0'}"></span>
                    </button>
                </div>
                
                ${s.aiFeatures.enabled ? `
                <div class="mt-3 pt-3 border-t border-white/20 space-y-3">
                    ${AIStatusPanel}

                    ${renderAiDefaultParamControls()}

                    <div class="flex justify-between items-center">
                        <label for="language-select" class="flex items-center gap-2 text-sm">${ICONS.Languages({size: 16})} Language</label>
                        <select id="language-select" data-action="set-language" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                            ${Object.entries(SUPPORTED_LANGUAGES).map(([code, name]) => `<option value="${code}" ${s.language === code ? 'selected' : ''}>${name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="flex justify-between items-center pt-3 border-t border-white/20">
                        <div class="text-sm">
                            <p class="font-semibold">Demo Mode</p>
                            <p class="text-white/70 text-xs">Simulate AI features if unavailable.</p>
                        </div>
                        <button data-action="toggle-demo-mode" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${s.demoMode.enabled ? 'bg-teal' : 'bg-white/20'}">
                            <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${s.demoMode.enabled ? 'translate-x-6' : 'translate-x-0'}"></span>
                        </button>
                    </div>
                    
                    <div class="text-xs text-white/60 p-2 bg-black/20 rounded-lg">
                        <p class="font-bold">Browser Info:</p>
                        <p class="break-all">${navigator.userAgent}</p>
                    </div>
                </div>
                ` : `
                <p class="text-sm text-white/70 mt-2">Enable to use on-device AI for generation, translation, and more.</p>
                `}
            </div>
        `;

        const content = `
            <div class="max-w-lg mx-auto">
                <h1 class="text-4xl font-serif text-center mb-6">Settings</h1>
                
                ${aiFeaturesSection}

                <div class="glass-card p-4 rounded-xl mb-4">
                    <h2 class="text-lg font-semibold mb-3">Theme</h2>
                    <div class="grid grid-cols-2 gap-3">
                        ${THEME_OPTIONS.map(theme => `
                            <button data-action="set-theme" data-theme="${theme.id}" class="w-full h-16 rounded-lg border-2 ${s.theme === theme.id ? 'border-white' : 'border-transparent'}" style="background-image: ${theme.gradient};" aria-label="Set theme to ${theme.name}" title="Set theme to ${theme.name}">
                                <span class="sr-only">${theme.name}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div class="glass-card p-4 rounded-xl mb-4">
                    <h2 class="text-lg font-semibold mb-3">Font Style</h2>
                     <div class="flex gap-3">
                        ${FONT_OPTIONS.map(font => `<button data-action="set-font" data-font="${font.id}" class="flex-1 p-3 rounded-lg text-center ${s.font === font.id ? 'bg-white text-deep-purple' : 'bg-white/20'}" aria-label="Set font to ${font.name}" title="Set font to ${font.name}">${font.name}</button>`).join('')}
                    </div>
                </div>
                
                <div class="glass-card p-4 rounded-xl mb-4 flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Dark Mode</h2>
                    <button data-action="toggle-dark-mode" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${s.isDarkMode ? 'bg-teal' : 'bg-white/20'}" aria-label="Toggle dark mode" title="Toggle dark mode">
                        <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${s.isDarkMode ? 'translate-x-6' : 'translate-x-0'}"></span>
                    </button>
                </div>

                 <div class="glass-card p-4 rounded-xl mb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold flex items-center gap-2">${ICONS.Timer({size: 20})} Slideshow</h2>
                        <button data-action="toggle-slideshow" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${s.slideshow.enabled ? 'bg-teal' : 'bg-white/20'}" aria-label="Toggle slideshow mode" title="Toggle slideshow mode">
                            <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${s.slideshow.enabled ? 'translate-x-6' : 'translate-x-0'}"></span>
                        </button>
                    </div>
                     ${s.slideshow.enabled ? `
                    <div class="text-sm mt-3 pt-3 border-t border-white/20">
                         <div class="flex justify-between items-center">
                            <label for="slideshow-interval">Display each mantra for</label>
                            <select id="slideshow-interval" data-action="set-slideshow-interval" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                                <option value="5" ${s.slideshow.interval === 5 ? 'selected' : ''}>5 seconds</option>
                                <option value="6" ${s.slideshow.interval === 6 ? 'selected' : ''}>6 seconds</option>
                                <option value="7" ${s.slideshow.interval === 7 ? 'selected' : ''}>7 seconds</option>
                                <option value="10" ${s.slideshow.interval === 10 ? 'selected' : ''}>10 seconds</option>
                                <option value="15" ${s.slideshow.interval === 15 ? 'selected' : ''}>15 seconds</option>
                                <option value="30" ${s.slideshow.interval === 30 ? 'selected' : ''}>30 seconds</option>
                            </select>
                        </div>
                    </div>` : '<p class="text-sm text-white/70 mt-2">Enable to automatically cycle through your mantras on the dashboard.</p>'}
                </div>

                <div class="glass-card p-4 rounded-xl mb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold flex items-center gap-2">${ICONS.Microphone({size: 20})} Voice Features</h2>
                        <button data-action="toggle-voice-features" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${s.voiceFeatures.enabled ? 'bg-teal' : 'bg-white/20'}" ${!isAudioSupported ? 'disabled' : ''} aria-label="Toggle voice recording features" title="Toggle voice recording features">
                            <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${s.voiceFeatures.enabled ? 'translate-x-6' : 'translate-x-0'}"></span>
                        </button>
                    </div>
                    ${!isAudioSupported ? '<p class="text-sm text-yellow-300 mt-2">Your browser does not support audio recording.</p>' : ''}
                </div>
                
                <div class="glass-card p-4 rounded-xl mb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold flex items-center gap-2">${ICONS.Music4({size: 20})} Celebration Sounds</h2>
                        <button data-action="toggle-celebration-sounds" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${s.celebrationSounds.enabled ? 'bg-teal' : 'bg-white/20'}" aria-label="Toggle celebration sounds" title="Toggle celebration sounds">
                            <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${s.celebrationSounds.enabled ? 'translate-x-6' : 'translate-x-0'}"></span>
                        </button>
                    </div>
                </div>

                <div class="glass-card p-4 rounded-xl mb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold flex items-center gap-2">${ICONS.Vibrate({size: 20})} Haptic Feedback</h2>
                        <button data-action="toggle-haptics" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${s.haptics.enabled ? 'bg-teal' : 'bg-white/20'}" aria-label="Toggle haptic feedback" title="Toggle haptic feedback">
                            <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${s.haptics.enabled ? 'translate-x-6' : 'translate-x-0'}"></span>
                        </button>
                    </div>
                     <p class="text-sm text-white/70 mt-2">Enable subtle vibrations for actions like swiping and button presses.</p>
                </div>

                <div class="glass-card p-4 rounded-xl mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold flex items-center gap-2">${ICONS.Bell({size: 20})} Mantra Reminders</h2>
                        <button data-action="set-notification-prop" data-type="mantras" data-prop="enabled" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${n.mantras.enabled ? 'bg-teal' : 'bg-white/20'}" aria-label="Toggle mantra reminders" title="Toggle mantra reminders">
                            <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${n.mantras.enabled ? 'translate-x-6' : 'translate-x-0'}"></span>
                        </button>
                    </div>
                    ${n.mantras.enabled ? `
                    <div class="text-sm space-y-3 pt-2 border-t border-white/20">
                        ${renderTimeSlot('morning')}
                        ${renderTimeSlot('afternoon')}
                        ${renderTimeSlot('evening')}
                    </div>` : '<p class="text-sm text-white/70">Enable to get motivational mantra reminders.</p>'}
                </div>

                <div class="glass-card p-4 rounded-xl mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold flex items-center gap-2">${ICONS.Smile({size: 20})} Daily Affirmation Reminder</h2>
                        <button data-action="set-notification-prop" data-type="affirmation" data-prop="enabled" class="w-14 h-8 flex items-center rounded-full p-1 transition-colors ${n.affirmation.enabled ? 'bg-teal' : 'bg-white/20'}" aria-label="Toggle daily affirmation reminder" title="Toggle daily affirmation reminder">
                            <span class="w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${n.affirmation.enabled ? 'translate-x-6' : 'translate-x-0'}"></span>
                        </button>
                    </div>
                    ${n.affirmation.enabled ? `
                    <div class="text-sm pt-2 border-t border-white/20">
                        <div class="flex justify-between items-center">
                            <label for="notif-affirmation-time">Reminder time</label>
                            <input type="time" id="notif-affirmation-time" value="${n.affirmation.time}" data-action="set-notification-prop" data-type="affirmation" data-prop="time" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm w-24">
                        </div>
                    </div>` : '<p class="text-sm text-white/70">Enable to get a daily affirmation reminder.</p>'}
                </div>

                 ${deferredInstallPrompt ? `
                    <div class="mt-6 text-center">
                        ${renderButton('Install App', { attributes: 'data-action="install-pwa" title="Install MantraOS to your device"'})}
                    </div>` : ''}

                 <div class="glass-card p-4 rounded-xl mb-4">
                    <h2 class="text-lg font-semibold mb-3">Data Management</h2>
                    <div class="flex justify-between items-baseline mb-4 p-3 rounded-lg bg-black/10">
                        <span class="text-sm text-white/80">Voice Recordings Storage Used:</span>
                        <span class="text-lg font-bold text-teal">${getAudioStorageUsage()}</span>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button data-action="export-data" class="flex-1 p-3 rounded-lg bg-white/20 text-white hover:bg-white/30 transition-colors flex items-center justify-center gap-2" title="Export all your data to a JSON file">
                            ${ICONS.Download({size: 20})} Export Data
                        </button>
                        <button data-action="import-data" class="flex-1 p-3 rounded-lg bg-white/20 text-white hover:bg-white/30 transition-colors flex items-center justify-center gap-2" title="Import data from a JSON backup file">
                            ${ICONS.Upload({size: 20})} Import Data
                        </button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                     <div class="mt-3">
                        <button data-action="delete-all-recordings" class="w-full p-3 rounded-lg bg-rose-600/50 text-white hover:bg-rose-600/70 transition-colors flex items-center justify-center gap-2" title="Permanently delete all voice recordings">
                            ${ICONS.Trash2({size: 20})} Delete All Recordings
                        </button>
                     </div>
                </div>

                 <div class="mt-6 text-center">
                     <button data-action="reset-app" class="text-red-400 hover:text-red-300 transition-colors" title="Delete all data and reset the app">Reset Application Data</button>
                 </div>
            </div>
        `;
        renderPage(content, { showBackButton: true, showUndoRedo: true });
    };
    
    // --- SWIPE LOGIC ---
    function setupSwipeListeners() {
        const swipeArea = document.getElementById('swipe-area');
        if (!swipeArea) return;
        let startX = 0;
        let isSwiping = false;

        const handleSwipe = (diff) => {
            if (Math.abs(diff) > 50) { // Threshold
                resetSlideshowTimer();
                renderTransitionParticles();
                if(!audioPlayer.paused) stopPlayback();
                if(currentlyRecordingMantraId) stopRecording();

                let newIndex = state.currentMantraIndex;
                if (diff > 0) { // Swipe Right
                    newIndex = (state.currentMantraIndex - 1 + state.userMantras.length) % state.userMantras.length;
                } else { // Swipe Left
                    newIndex = (state.currentMantraIndex + 1) % state.userMantras.length;
                }
                if (newIndex !== state.currentMantraIndex) {
                    state.currentMantraIndex = newIndex;
                    hapticFeedback();
                    // Animate text out, then render, then animate in
                    const mantraText = document.getElementById('mantra-text');
                    mantraText.style.opacity = '0';
                    setTimeout(() => {
                        renderDashboard(); // Re-render to update text and dots
                    }, 150);
                }
            }
        };
        
        swipeArea.addEventListener('touchstart', (e) => {
            stopSlideshow();
            startX = e.touches[0].clientX;
            isSwiping = true;
        }, { passive: true });
        
        swipeArea.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            const currentX = e.touches[0].clientX;
            const diff = currentX - startX;
            const mantraText = document.getElementById('mantra-text');
            if (!mantraText) return;
            mantraText.style.transform = `translateX(${diff}px)`;
            mantraText.style.opacity = `${1 - Math.abs(diff) / (window.innerWidth / 2)}`;
        }, { passive: true });

        swipeArea.addEventListener('touchend', (e) => {
            if (!isSwiping) return;
            isSwiping = false;
            const endX = e.changedTouches[0].clientX;
            handleSwipe(endX - startX);
            // Reset style if not swiped enough
            const mantraText = document.getElementById('mantra-text');
            if (mantraText) {
              mantraText.style.transform = 'translateX(0)';
              mantraText.style.opacity = '1';
            }
        });
        
        // Pause slideshow on hover for desktop users
        swipeArea.addEventListener('mouseenter', stopSlideshow);
        swipeArea.addEventListener('mouseleave', startSlideshow);
    }

    // --- UNDO/REDO ---
    const getActionDescription = (action) => {
        switch (action.type) {
            case 'ADD_MANTRA': return 'Mantra added.';
            case 'REMOVE_MANTRA': return 'Mantra removed.';
            case 'UPDATE_MANTRA_PRIORITY': return 'Priority updated.';
            case 'UPDATE_MANTRA_TEXT': return 'Mantra updated.';
            case 'ADD_AFFIRMATION': return 'Affirmation added.';
            case 'REMOVE_AFFIRMATION': return 'Affirmation removed.';
            case 'UPDATE_SETTING': return `Setting updated.`;
            case 'SET_RECORDING': return 'Recording saved.';
            case 'DELETE_RECORDING': return 'Recording deleted.';
            default: return 'Action performed.';
        }
    };

    const performAction = (action) => {
        executeAction(action);
        undoHistory.push(action);
        redoHistory = [];
        saveState();
        router(); // Re-render current page
        renderToast(getActionDescription(action), true);
    };

    const undo = () => {
        if (undoHistory.length === 0) return;
        const action = undoHistory.pop();
        reverseAction(action);
        redoHistory.push(action);
        saveState();
        router();
        renderToast('Action undone.', false);
    };

    const redo = () => {
        if (redoHistory.length === 0) return;
        const action = redoHistory.pop();
        executeAction(action);
        undoHistory.push(action);
        saveState();
        router();
        renderToast('Action redone.', false);
    };
    
    const executeAction = (action) => {
        const { type, payload } = action;
        const mantraToUpdate = type === 'UPDATE_MANTRA_PRIORITY' || type === 'UPDATE_MANTRA_TEXT'
            ? state.userMantras.find(m => m.id === payload.mantraId)
            : null;

        switch (type) {
            case 'ADD_MANTRA':
                state.userMantras.push(payload.mantra);
                break;
            case 'REMOVE_MANTRA':
                state.userMantras = state.userMantras.filter(m => m.id !== payload.mantra.id);
                if (state.audioRecordings[payload.mantra.id]) {
                    delete state.audioRecordings[payload.mantra.id];
                }
                break;
            case 'UPDATE_MANTRA_PRIORITY':
                if (mantraToUpdate) mantraToUpdate.priority = payload.newPriority;
                break;
            case 'UPDATE_MANTRA_TEXT':
                if (mantraToUpdate) mantraToUpdate.text = payload.newText;
                break;
            case 'ADD_AFFIRMATION':
                state.userAffirmations.push(payload.affirmation);
                break;
            case 'REMOVE_AFFIRMATION':
                state.userAffirmations = state.userAffirmations.filter(a => a.id !== payload.affirmation.id);
                break;
            case 'UPDATE_SETTING':
                setNestedValue(state.settings, payload.key, payload.newValue);
                applySettings();
                break;
            case 'SET_RECORDING':
                state.audioRecordings[payload.mantraId] = payload.newRecording;
                break;
            case 'DELETE_RECORDING':
                delete state.audioRecordings[payload.mantraId];
                break;
        }
    };

    const reverseAction = (action) => {
        const { type, payload } = action;
        const mantraToUpdate = type === 'UPDATE_MANTRA_PRIORITY' || type === 'UPDATE_MANTRA_TEXT'
            ? state.userMantras.find(m => m.id === payload.mantraId)
            : null;

        switch (type) {
            case 'ADD_MANTRA': // Undo adding is removing
                state.userMantras = state.userMantras.filter(m => m.id !== payload.mantra.id);
                break;
            case 'REMOVE_MANTRA': // Undo removing is adding back
                state.userMantras.splice(payload.index, 0, payload.mantra);
                if (payload.recording) {
                    state.audioRecordings[payload.mantra.id] = payload.recording;
                }
                break;
            case 'UPDATE_MANTRA_PRIORITY':
                if (mantraToUpdate) mantraToUpdate.priority = payload.oldPriority;
                break;
            case 'UPDATE_MANTRA_TEXT':
                if (mantraToUpdate) mantraToUpdate.text = payload.oldText;
                break;
            case 'ADD_AFFIRMATION':
                state.userAffirmations = state.userAffirmations.filter(a => a.id !== payload.affirmation.id);
                break;
            case 'REMOVE_AFFIRMATION':
                state.userAffirmations.splice(payload.index, 0, payload.affirmation);
                break;
            case 'UPDATE_SETTING':
                setNestedValue(state.settings, payload.key, payload.oldValue);
                applySettings();
                break;
            case 'SET_RECORDING':
                if (payload.oldRecording) {
                    state.audioRecordings[payload.mantraId] = payload.oldRecording;
                } else {
                    delete state.audioRecordings[payload.mantraId];
                }
                break;
            case 'DELETE_RECORDING':
                state.audioRecordings[payload.mantraId] = payload.recording;
                break;
        }
    };


    // --- ROUTER ---
    const router = () => {
        const path = window.location.hash.slice(1) || '/';
        
        if (!state.isOnboardingComplete && !path.startsWith('/onboarding')) {
            window.location.hash = '/onboarding/welcome';
            return;
        }

        if (path.startsWith('/onboarding')) {
            renderOnboarding(path.split('/')[2] || 'welcome');
        } else {
            applySettings();
            switch (path) {
                case '/library': renderLibrary(); break;
                case '/progress': renderProgress(); break;
                case '/settings': renderSettings(); break;
                case '/affirmations': renderAffirmations(); break;
                case '/dashboard': renderDashboard(); break;
                default:
                    window.location.hash = '/dashboard';
            }
        }
    };
    
    // --- EVENT LISTENERS ---
    document.addEventListener('input', e => {
        const target = e.target;
        const action = target.dataset.action;

        if (action === 'set-notification-prop' && target.type === 'time') {
            const type = target.dataset.type;
            const period = target.dataset.period;
            const prop = target.dataset.prop;
            const value = target.value;
            
            if (type === 'affirmation') {
                state.settings.notifications.affirmation[prop] = value;
            } else if (type === 'mantras' && period) {
                state.settings.notifications.mantras[period][prop] = value;
            }
            saveState();
        } else if (target.id === 'new-affirmation-input') {
            const charCount = document.getElementById('char-count');
            const addBtn = document.getElementById('add-affirmation-btn');
            if (charCount && addBtn) {
                const count = target.value.length;
                charCount.textContent = `${count}/150`;
                addBtn.disabled = target.value.trim().length === 0;
            }
        } else if (target.id === 'new-custom-mantra-text') {
            const charCountEl = document.getElementById('new-mantra-char-count');
            const addBtn = document.getElementById('add-custom-mantra-btn');
            const proofreadBtn = document.getElementById('proofread-mantra-btn');
            const suggestBtn = document.getElementById('suggest-phrasing-btn');
            if (charCountEl) {
                const count = target.value.length;
                charCountEl.textContent = `${count}/150`;
                const hasText = target.value.trim().length > 0;
                if(addBtn) addBtn.disabled = !hasText;
                if(proofreadBtn) proofreadBtn.disabled = !hasText;
                if(suggestBtn) suggestBtn.disabled = !hasText;
            }
        } else if (target.id === 'mantra-search-input') {
            const searchTerm = target.value;
            const activeCategoryButton = document.querySelector('[data-action="library-filter"][class*="bg-white"]');
            const category = activeCategoryButton ? activeCategoryButton.dataset.category : CATEGORIES[0];
            renderLibraryContent('curated', { category, searchTerm });
        }
    });

    document.addEventListener('change', e => {
        const target = e.target;
        const action = target.dataset.action;
        
        if (target.id === 'import-file-input' && target.files.length > 0) {
            const file = target.files[0];
            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    // Basic validation
                    const requiredKeys = ['userMantras', 'settings', 'progress', 'isOnboardingComplete'];
                    const hasRequiredKeys = requiredKeys.every(key => key in importedData);
                    
                    if (!hasRequiredKeys) {
                        throw new Error('Invalid or corrupted backup file.');
                    }

                    renderConfirmationModal(
                        'Confirm Import',
                        'Importing will overwrite all current data. Are you sure you want to continue?',
                        () => {
                            // Overwrite state with imported data, providing defaults for any missing keys
                            state = { ...state, ...importedData, settings: { ...defaultSettings, ...importedData.settings }};
                            saveState();
                            applySettings();
                            alert('Data imported successfully! The app will now reload.');
                            window.location.reload();
                        },
                        { confirmText: 'Import & Overwrite', confirmVariant: 'destructive' }
                    );
                } catch (error) {
                    console.error('Failed to import data:', error);
                    alert(`Import failed: ${error.message}`);
                } finally {
                    target.value = '';
                }
            };

            reader.onerror = () => {
                alert('Failed to read the selected file.');
                target.value = '';
            };

            reader.readAsText(file);
        }

        if (action === 'set-mantra-sort') {
            myMantrasSortOrder = target.value;
            const activeFilterBtn = document.querySelector('[data-action="library-priority-filter"][class*="bg-white"]');
            const priorityFilter = activeFilterBtn ? activeFilterBtn.dataset.priority : 'All';
            renderLibraryContent('my-mantras', { priorityFilter });
        }

        if (action === 'set-slideshow-interval') {
             performAction({
                type: 'UPDATE_SETTING',
                payload: { key: 'slideshow.interval', oldValue: state.settings.slideshow.interval, newValue: parseInt(target.value, 10) }
            });
        }

        if (action === 'set-language') {
            handleLanguageChange(target.value);
        }
        
        if (action === 'set-ai-setting') {
            const key = `aiSettings.${target.dataset.key}`;
            const oldValue = getNestedValue(state.settings, key);
            const newValue = target.value;
            performAction({ type: 'UPDATE_SETTING', payload: { key, oldValue, newValue } });
        }
    });

    document.addEventListener('click', async e => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        
        const action = target.dataset.action;
        const mantraId = target.dataset.mantraId;
        
        hapticFeedback();

        switch (action) {
            case 'nav': window.location.hash = target.dataset.path; break;
            case 'go-back': window.history.back(); break;
            case 'undo': undo(); break;
            case 'redo': redo(); break;
            case 'filter-mantras': renderMantraSelectionList(target.dataset.category); break;
            case 'library-filter': {
                const searchTerm = document.getElementById('mantra-search-input')?.value || '';
                renderLibraryContent('curated', { category: target.dataset.category, searchTerm });
                break;
            }
            case 'library-priority-filter': {
                const activeTab = document.querySelector('[data-action="library-tab"][class*="border-teal"]').dataset.tab;
                renderLibraryContent(activeTab, { priorityFilter: target.dataset.priority });
                break;
            }
            case 'toggle-onboarding-mantra': {
                const mantra = CURATED_MANTRAS.find(m => m.id === mantraId);
                const newMantra = { ...mantra, text: { original: mantra.text.original, translated: null } };
                if (state.onboardingTempMantras.some(m => m.id === mantraId)) {
                    state.onboardingTempMantras = state.onboardingTempMantras.filter(m => m.id !== mantraId);
                } else {
                    if (state.onboardingTempMantras.length >= 5) {
                        renderModal('Limit Reached', 'You can select a maximum of 5 mantras.');
                        return;
                    }
                    state.onboardingTempMantras.push(newMantra);
                }
                saveState();
                renderOnboarding('mantras');
                break;
            }
            case 'add-custom-onboarding': {
                const textEl = document.getElementById('custom-mantra-text');
                const catEl = document.getElementById('custom-mantra-category');
                const prioEl = document.getElementById('custom-mantra-priority');
                if (textEl.value.trim()) {
                    const newMantra = { 
                        id: `c-${Date.now()}`, 
                        text: { original: textEl.value.trim(), translated: null },
                        category: catEl.value, 
                        priority: prioEl.value,
                        createdAt: Date.now() 
                    };
                    state.onboardingTempMantras.push(newMantra);
                    saveState();
                    textEl.value = '';
                    alert('Custom mantra added!');
                }
                break;
            }
            case 'finish-onboarding':
                state.userMantras = state.onboardingTempMantras.map(m => ({ 
                    ...m, 
                    priority: m.priority || 'Medium',
                    createdAt: m.createdAt || Date.now()
                }));
                state.isOnboardingComplete = true;
                if (state.userMantras.length >= 3) unlockAchievement('3_mantras');
                if (state.userMantras.some(m => m.id.startsWith('c-'))) unlockAchievement('custom_mantra');
                state.onboardingTempMantras = [];
                saveState();
                window.location.hash = '/dashboard';
                break;
            case 'set-mantra-index': {
                 const newIndex = parseInt(target.dataset.index, 10);
                 if (newIndex === state.currentMantraIndex) break;
                 
                 resetSlideshowTimer();

                 if(!audioPlayer.paused) stopPlayback();
                 if(currentlyRecordingMantraId) stopRecording();

                 state.currentMantraIndex = newIndex;
                 const mantraText = document.getElementById('mantra-text');
                 if (mantraText) {
                     mantraText.style.opacity = '0';
                     setTimeout(() => {
                         renderDashboard();
                     }, 150);
                 } else {
                     renderDashboard();
                 }
                 break;
            }
            case 'library-tab': 
                undoHistory = []; redoHistory = []; // Clear history on tab change
                renderLibraryContent(target.dataset.tab); 
                break;
            case 'toggle-library-mantra': {
                 const isAdded = state.userMantras.some(m => m.id === mantraId);
                 if (isAdded) {
                     const mantraToRemove = state.userMantras.find(m => m.id === mantraId);
                     const index = state.userMantras.findIndex(m => m.id === mantraId);
                     const recording = state.audioRecordings[mantraId];
                     performAction({ type: 'REMOVE_MANTRA', payload: { mantra: mantraToRemove, index, recording } });
                 } else {
                     const libMantra = CURATED_MANTRAS.find(m => m.id === mantraId);
                     const mantraToAdd = { ...libMantra, text: { original: libMantra.text.original, translated: null }, priority: 'Medium', createdAt: Date.now() };
                     performAction({ type: 'ADD_MANTRA', payload: { mantra: mantraToAdd } });
                 }
                 break;
             }
            case 'set-mantra-priority': {
                const mantraToUpdate = state.userMantras.find(m => m.id === mantraId);
                if (mantraToUpdate) {
                    performAction({
                        type: 'UPDATE_MANTRA_PRIORITY',
                        payload: { mantraId, oldPriority: mantraToUpdate.priority, newPriority: target.dataset.priority }
                    });
                }
                break;
            }
            case 'add-new-affirmation': {
                const input = document.getElementById('new-affirmation-input');
                if (input && input.value.trim()) {
                    const newAffirmation = { id: `affirm-${Date.now()}`, text: input.value.trim() };
                    performAction({ type: 'ADD_AFFIRMATION', payload: { affirmation: newAffirmation }});
                }
                break;
            }
            case 'remove-affirmation': {
                const affirmationToRemove = state.userAffirmations.find(a => a.id === target.dataset.affirmationId);
                const index = state.userAffirmations.findIndex(a => a.id === target.dataset.affirmationId);
                if(affirmationToRemove) {
                    performAction({ type: 'REMOVE_AFFIRMATION', payload: { affirmation: affirmationToRemove, index }});
                }
                break;
            }
            case 'add-new-custom-mantra': {
                const textInput = document.getElementById('new-custom-mantra-text');
                const categoryInput = document.getElementById('new-custom-mantra-category');
                const priorityInput = document.getElementById('new-custom-mantra-priority');
                if (textInput && textInput.value.trim()) {
                    const newMantra = { id: `c-${Date.now()}`, text: { original: textInput.value.trim(), translated: null }, category: categoryInput.value, priority: priorityInput.value, createdAt: Date.now() };
                    performAction({ type: 'ADD_MANTRA', payload: { mantra: newMantra } });
                    unlockAchievement('custom_mantra');
                }
                break;
            }
            case 'set-theme':
                performAction({
                    type: 'UPDATE_SETTING',
                    payload: { key: 'theme', oldValue: state.settings.theme, newValue: target.dataset.theme }
                });
                break;
            case 'set-font':
                performAction({
                    type: 'UPDATE_SETTING',
                    payload: { key: 'font', oldValue: state.settings.font, newValue: target.dataset.font }
                });
                break;
            case 'toggle-dark-mode':
                performAction({
                    type: 'UPDATE_SETTING',
                    payload: { key: 'isDarkMode', oldValue: state.settings.isDarkMode, newValue: !state.settings.isDarkMode }
                });
                break;
            case 'toggle-celebration-sounds':
                performAction({
                    type: 'UPDATE_SETTING',
                    payload: { key: 'celebrationSounds.enabled', oldValue: state.settings.celebrationSounds.enabled, newValue: !state.settings.celebrationSounds.enabled }
                });
                break;
            case 'toggle-haptics':
                performAction({
                    type: 'UPDATE_SETTING',
                    payload: { key: 'haptics.enabled', oldValue: state.settings.haptics.enabled, newValue: !state.settings.haptics.enabled }
                });
                break;
            case 'toggle-slideshow':
                 performAction({
                    type: 'UPDATE_SETTING',
                    payload: { key: 'slideshow.enabled', oldValue: state.settings.slideshow.enabled, newValue: !state.settings.slideshow.enabled }
                });
                break;
            case 'toggle-voice-features': 
                 performAction({
                    type: 'UPDATE_SETTING',
                    payload: { key: 'voiceFeatures.enabled', oldValue: state.settings.voiceFeatures.enabled, newValue: !state.settings.voiceFeatures.enabled }
                });
                break;
            case 'set-notification-prop': {
                const type = target.dataset.type;
                const period = target.dataset.period;
                const prop = target.dataset.prop;
                const path = type === 'affirmation' 
                    ? `notifications.affirmation.${prop}` 
                    : `notifications.mantras${period ? `.${period}` : ''}.${prop}`;
                
                const oldValue = getNestedValue(state.settings, path);
                let newValue;

                if (target.tagName.toLowerCase() === 'button') {
                    newValue = !oldValue;
                } else if (target.type === 'checkbox') {
                    newValue = target.checked;
                } else {
                    newValue = target.value;
                }

                if(oldValue !== newValue) {
                     performAction({ type: 'UPDATE_SETTING', payload: { key: path, oldValue, newValue } });
                }
                break;
            }
            case 'install-pwa':
                if (deferredInstallPrompt) {
                    deferredInstallPrompt.prompt();
                    deferredInstallPrompt.userChoice.then(() => {
                        deferredInstallPrompt = null;
                        renderSettings();
                    });
                }
                break;
            case 'export-data': exportUserData(); break;
            case 'import-data': document.getElementById('import-file-input')?.click(); break;
            case 'reset-app':
                renderConfirmationModal(
                    'Confirm Reset',
                    'Are you sure you want to delete all your data? This action is permanent and cannot be undone.',
                    () => {
                        Object.values(storageKeys).forEach(key => localStorage.removeItem(key));
                        state = { userMantras: [], userAffirmations: [], settings: JSON.parse(JSON.stringify(defaultSettings)), progress: {}, isOnboardingComplete: false, achievements: INITIAL_ACHIEVEMENTS, currentMantraIndex: 0, onboardingTempMantras: [], dailyAffirmation: null, audioRecordings: {}, lastDailyGoalCelebrated: null, lastStreakMilestoneCelebrated: 0 };
                        window.location.hash = '';
                        window.location.reload();
                    },
                    { confirmText: 'Reset', confirmVariant: 'destructive' }
                );
                break;
            // --- Audio Actions ---
            case 'record-voice': startRecording(mantraId); break;
            case 'stop-recording': stopRecording(); break;
            case 'play-voice': playRecording(mantraId); break;
            case 'pause-voice': pauseRecording(); break;
            case 'stop-voice': stopPlayback(); break;
            case 'delete-voice': deleteRecording(mantraId); break;
            case 'delete-all-recordings':
                renderConfirmationModal(
                    'Delete All Recordings?',
                    'This will permanently remove all of your voice recordings. This action cannot be undone.',
                    () => {
                        state.audioRecordings = {};
                        saveState();
                        renderSettings();
                    },
                    { confirmText: 'Delete All', confirmVariant: 'destructive' }
                );
                break;
            // --- AI Actions ---
            case 'toggle-ai-features':
                performAction({
                    type: 'UPDATE_SETTING',
                    payload: { key: 'aiFeatures.enabled', oldValue: state.settings.aiFeatures.enabled, newValue: !state.settings.aiFeatures.enabled }
                });
                break;
             case 'toggle-demo-mode':
                performAction({
                    type: 'UPDATE_SETTING',
                    payload: { key: 'demoMode.enabled', oldValue: state.settings.demoMode.enabled, newValue: !state.settings.demoMode.enabled }
                });
                break;
            case 'recheck-ai':
                renderLoadingModal("Re-checking AI status...");
                await checkAiStatus();
                closeLoadingModal();
                renderSettings(); // Re-render the settings page with new status
                break;
            case 'test-ai':
                renderLoadingModal("Testing AI...");
                try {
                    const session = await window.ai.createTextSession();
                    const result = await session.prompt("Say 'hello'", { outputLanguage: 'en' });
                    closeLoadingModal();
                    if (result.toLowerCase().includes('hello')) {
                        renderModal("AI Test Successful", "The on-device AI is working correctly.");
                    } else {
                        throw new Error("Unexpected response from AI.");
                    }
                } catch (e) {
                    closeLoadingModal();
                    console.error("AI Test Failed:", e);
                    renderModal("AI Test Failed", `Could not get a valid response from the AI. Error: ${e.message}`);
                }
                break;
            case 'open-ai-generate-modal': handleAiGenerate(); break;
            case 'open-ai-affirmation-modal': handleAiAffirmationGenerate(); break;
            case 'rewrite-mantra': handleAiRewrite(mantraId); break;
            case 'proofread-mantra': handleAiProofread(); break;
            case 'suggest-phrasing': handleAiSuggestPhrasing(); break;
            case 'accept-proofread': {
                const textInput = document.getElementById('new-custom-mantra-text');
                textInput.value = target.dataset.suggestion;
                document.getElementById('proofread-suggestion').classList.add('hidden');
                // Trigger input event to re-validate buttons
                textInput.dispatchEvent(new Event('input', { bubbles: true }));
                break;
            }
            case 'select-suggestion': {
                const textInput = document.getElementById('new-custom-mantra-text');
                textInput.value = target.dataset.text;
                document.getElementById('ai-suggestion-container').innerHTML = '';
                // Trigger input event to re-validate buttons and char count
                textInput.dispatchEvent(new Event('input', { bubbles: true }));
                break;
            }
            case 'add-ai-affirmation': {
                const newAffirmation = { id: `affirm-${Date.now()}`, text: target.dataset.text };
                performAction({ type: 'ADD_AFFIRMATION', payload: { affirmation: newAffirmation }});
                target.innerHTML = ICONS.Check({size: 16});
                target.disabled = true;
                break;
            }
        }
    });

    // --- AUDIO PLAYER GLOBAL LISTENERS ---
    audioPlayer.addEventListener('play', () => {
        const controls = document.getElementById(`audio-controls-${currentlyPlayingMantraId}`);
        if(controls) controls.innerHTML = renderAudioInterface(currentlyPlayingMantraId);
    });
    audioPlayer.addEventListener('pause', () => {
        const controls = document.getElementById(`audio-controls-${currentlyPlayingMantraId}`);
        if(controls) controls.innerHTML = renderAudioInterface(currentlyPlayingMantraId);
        startSlideshow();
    });
    audioPlayer.addEventListener('ended', () => {
        stopPlayback();
    });
    audioPlayer.addEventListener('timeupdate', () => {
        const progressEl = document.querySelector(`.audio-progress-bar-inner[data-mantra-id="${currentlyPlayingMantraId}"]`);
        if (progressEl) {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
            progressEl.style.width = `${progress}%`;
        }
    });

    // --- KEYBOARD SHORTCUTS ---
    document.addEventListener('keydown', e => {
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'z') {
                e.preventDefault();
                undo();
            } else if (e.key === 'y') {
                e.preventDefault();
                redo();
            }
        }
    });
    
    // --- FAKE AI (DEMO MODE) HANDLERS ---
    const handleFakeAiGenerate = (topic, options) => {
        return new Promise(resolve => {
            setTimeout(() => {
                const fakeMantras = [
                    `[${options.tone}] A ${options.length} mantra about ${topic}. (Simulated)`,
                    `[${options.tone}] Another ${options.length} mantra for ${topic}. (Simulated)`,
                    `[${options.tone}] This is a ${options.length} ${topic} mantra. (Simulated)`,
                    `[${options.tone}] My final ${options.length} mantra on ${topic}. (Simulated)`,
                    `[${options.tone}] Your creative ${options.length} ${topic} mantra. (Simulated)`
                ].map(m => m.replace('creative', options.creativity));
                resolve(JSON.stringify(fakeMantras));
            }, 800);
        });
    };

    const handleFakeAiAffirmationGenerate = (topic, options) => {
        return new Promise(resolve => {
            setTimeout(() => {
                const fakeAffirmations = [
                    `I am a master of ${topic} and success flows to me. (Simulated)`,
                    `My ${topic} grows stronger every single day. (Simulated)`,
                    `I am confident in my ability to achieve great ${topic}. (Simulated)`,
                    `I am worthy of all the good things that come from my ${topic}. (Simulated)`,
                    `I attract positive outcomes in my ${topic}. (Simulated)`
                ];
                resolve(JSON.stringify(fakeAffirmations));
            }, 800);
        });
    };

    const handleFakeAiRewrite = (originalText, options) => {
        return new Promise(resolve => {
            setTimeout(() => {
                const variants = [
                    `[${options.tone}] Rephrased with ${options.creativity} creativity: ${originalText} (Simulated)`,
                    `[${options.tone}] Alternative take using ${options.creativity}: ${originalText} (Simulated)`,
                    `[${options.tone}] A final ${options.creativity} version: ${originalText} (Simulated)`
                ];
                resolve(JSON.stringify(variants));
            }, 800);
        });
    };

    const handleFakeAiSuggestPhrasing = (text) => {
        return new Promise(resolve => {
            setTimeout(() => {
                const suggestions = [
                    `First suggestion for: ${text} (Simulated)`,
                    `Second suggestion for: ${text} (Simulated)`,
                    `A third way to say: ${text} (Simulated)`,
                ];
                resolve(JSON.stringify(suggestions));
            }, 800);
        });
    };

    const handleFakeAiProofread = (text) => {
        return new Promise(resolve => {
            setTimeout(() => {
                let corrected = text.trim();
                if (corrected.length > 0) {
                    corrected = corrected.charAt(0).toUpperCase() + corrected.slice(1);
                    if (!['.', '!', '?'].includes(corrected.slice(-1))) {
                        corrected += '.';
                    }
                }
                resolve({ correctedText: `${corrected} (Simulated)` });
            }, 500);
        });
    };

    const handleFakeLanguageChange = async (newLang) => {
        const allMantras = [...state.userMantras, ...CURATED_MANTRAS];
        allMantras.forEach(mantra => {
            if (mantra.text && mantra.text.original) {
                mantra.text.translated = `[${newLang}] ${mantra.text.original} (Simulated)`;
            }
        });
        saveState();
    };

    // --- AI FEATURE LOGIC ---
    async function getAiTextSession() {
        if (aiTextSession) return aiTextSession;
        try {
            aiTextSession = await window.ai.createTextSession();
            return aiTextSession;
        } catch (e) {
            console.error("Failed to create AI text session:", e);
            renderModal("AI Error", "Could not initialize the AI text session. Please try again later.");
            return null;
        }
    }

    const stopAiTopicRecording = () => {
        if (aiTopicRecorder && aiTopicRecorder.state === 'recording') {
            aiTopicRecorder.stop();
        }
        clearTimeout(aiTopicRecordingTimer);
        clearInterval(aiTopicRecordingInterval);
    };

    const processAiAudio = async (audioBlob) => {
        const contentContainer = document.getElementById('ai-generate-content');
        if (!contentContainer) return;

        contentContainer.innerHTML = `
            <div class="w-8 h-8 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white/80">Analyzing audio and generating mantras...</p>`;

        const isDemo = state.settings.demoMode.enabled && !state.aiStatus.assistant;
        
        try {
            let result;
            if (isDemo) {
                result = await handleFakeAiGenerate("a spoken topic", state.settings.aiSettings);
            } else {
                const promptResult = await window.ai.assistant.prompt([
                    { text: 'Transcribe this audio and generate 5 positive affirmations about the spoken topic. The topic might be abstract. The output must be only a valid JSON array of strings, with no other text or markdown.' },
                    { audio: audioBlob }
                ]);
                result = promptResult.text();
            }
            displayGeneratedMantras(result, isDemo);
        } catch (error) {
            console.error("AI Audio Processing failed:", error);
            displayGeneratedMantras(null, isDemo, true); // Pass error flag
        }
    };

    const startAiTopicRecording = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            const contentContainer = document.getElementById('ai-generate-content');
            if (!contentContainer) { // Modal was closed
                stream.getTracks().forEach(track => track.stop());
                return;
            }

            contentContainer.innerHTML = `
                <h2 class="text-2xl font-serif mb-4">Recording Topic...</h2>
                <div class="flex flex-col items-center gap-3 w-full max-w-xs mx-auto">
                    <div class="relative flex items-center justify-center w-20 h-20">
                        <div class="absolute w-full h-full border-2 border-rose-500 rounded-full animate-pulse-ring" style="animation-delay: 0s;"></div>
                        <div class="absolute w-full h-full border-2 border-rose-500 rounded-full animate-pulse-ring" style="animation-delay: 1s;"></div>
                        <button id="ai-stop-recording-btn" class="relative z-10 p-4 bg-rose-500 rounded-full flex-shrink-0 shadow-lg" aria-label="Stop recording">
                            ${ICONS.StopCircle({size: 24})}
                        </button>
                    </div>
                    <div id="ai-audio-timer" class="text-lg font-mono text-white/80 font-semibold">${MAX_AI_RECORDING_SECONDS}s left</div>
                </div>
            `;
            document.getElementById('ai-stop-recording-btn').addEventListener('click', stopAiTopicRecording);

            aiTopicChunks = [];
            aiTopicRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
            
            aiTopicRecorder.ondataavailable = event => aiTopicChunks.push(event.data);
            aiTopicRecorder.onstop = () => {
                const audioBlob = new Blob(aiTopicChunks, { type: 'audio/webm;codecs=opus' });
                processAiAudio(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };
            
            aiTopicRecorder.start();

            aiTopicRecordingTimer = setTimeout(stopAiTopicRecording, MAX_AI_RECORDING_SECONDS * 1000);
            
            let secondsRemaining = MAX_AI_RECORDING_SECONDS;
            const timerEl = document.getElementById(`ai-audio-timer`);
            if(timerEl) timerEl.textContent = `${secondsRemaining}s left`;

            aiTopicRecordingInterval = setInterval(() => {
                secondsRemaining--;
                const timerEl = document.getElementById(`ai-audio-timer`);
                if (timerEl) timerEl.textContent = `${secondsRemaining}s left`;
                if (secondsRemaining <= 0) clearInterval(aiTopicRecordingInterval);
            }, 1000);

        } catch (err) {
            console.error("Error accessing microphone for AI topic:", err);
            const contentContainer = document.getElementById('ai-generate-content');
            if (contentContainer) {
                contentContainer.innerHTML = `
                    <h2 class="text-2xl font-serif mb-4 text-rose-400">Microphone Error</h2>
                    <p class="text-white/80 mb-6">Could not access the microphone. Please grant permission and try again.</p>
                    ${renderButton('Close', { attributes: 'data-action="close-ai-generate"' })}`;
                const modalElement = document.getElementById('ai-generate-modal');
                const closeModal = () => modalElement?.remove();
                contentContainer.querySelector('[data-action="close-ai-generate"]').addEventListener('click', closeModal);
            }
        }
    };
    
    function displayGeneratedMantras(jsonResult, isDemo, hasError = false) {
        const contentContainer = document.getElementById('ai-generate-content');
        if(!contentContainer) return;
        const modalElement = document.getElementById('ai-generate-modal');
        const closeModal = () => modalElement?.remove();

        if (hasError) {
             contentContainer.innerHTML = `
                <h2 class="text-2xl font-serif mb-4 text-rose-400">Generation Failed</h2>
                <p class="text-white/80 mb-6">The AI could not process the request. Please try again later.</p>
                ${renderButton('Close', { attributes: 'data-action="close-ai-generate"' })}`;
            contentContainer.querySelector('[data-action="close-ai-generate"]').addEventListener('click', closeModal);
            return;
        }

        try {
            const mantras = JSON.parse(jsonResult);
            const modalTitle = isDemo 
                ? `Generated Mantras <span class="text-sm text-teal-300">(Simulated)</span>` 
                : 'Generated Mantras';
            
            contentContainer.innerHTML = `
                <h2 class="text-2xl font-serif mb-4">${modalTitle}</h2>
                <div class="space-y-2 max-h-64 overflow-y-auto text-left mb-4">
                ${mantras.map((mantra) => `
                    <div class="glass-card p-3 flex justify-between items-center">
                        <p>"${mantra}"</p>
                        <button data-action="add-ai-mantra" data-text="${String(mantra).replace(/ \(Simulated\)$/, '')}" class="ml-2 p-2 rounded-full bg-white/20 hover:bg-white/30" aria-label="Add this mantra" title="Add to My Mantras">${ICONS.Plus({size: 16})}</button>
                    </div>`).join('')}
                </div>
                ${renderButton('Done', { attributes: 'data-action="close-ai-generate"' })}`;

            contentContainer.querySelector('[data-action="close-ai-generate"]').addEventListener('click', closeModal);
            contentContainer.querySelectorAll('[data-action="add-ai-mantra"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const newMantra = { id: `c-${Date.now()}`, text: { original: e.currentTarget.dataset.text, translated: null }, category: 'AI Generated', priority: 'Medium', createdAt: Date.now() };
                    performAction({ type: 'ADD_MANTRA', payload: { mantra: newMantra }});
                    e.currentTarget.innerHTML = ICONS.Check({size: 16});
                    e.currentTarget.disabled = true;
                });
            });
        } catch (error) {
            console.error("AI Generation failed (parsing result):", error);
            contentContainer.innerHTML = `
                <h2 class="text-2xl font-serif mb-4 text-rose-400">Generation Failed</h2>
                <p class="text-white/80 mb-6">The AI returned an invalid response. Please try a different topic or try again later.</p>
                ${renderButton('Close', { attributes: 'data-action="close-ai-generate"' })}`;
            contentContainer.querySelector('[data-action="close-ai-generate"]').addEventListener('click', closeModal);
        }
    }


    async function handleAiGenerate() {
        const modalId = 'ai-generate-modal';
        const { creativity, tone, length } = state.settings.aiSettings;
        const canRecord = state.aiStatus.assistant || (state.settings.demoMode.enabled && !state.aiStatus.assistant);

        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 animate-fade-in">
                <div class="glass-card w-full max-w-md rounded-2xl p-6 animate-slide-in-up" id="ai-generate-content">
                    <h2 class="text-2xl font-serif mb-4 text-center">Generate Mantras</h2>
                    <p class="text-white/80 mb-4 text-center">What area of your life would you like to focus on?</p>
                    <input type="text" id="ai-topic-input" placeholder="e.g., confidence, health, wealth" class="w-full p-3 bg-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white">
                    
                    <div class="my-4 flex items-center gap-2">
                        <hr class="flex-grow border-white/20">
                        <span class="text-xs text-white/60">OR</span>
                        <hr class="flex-grow border-white/20">
                    </div>
                    <button id="ai-record-topic" ${!canRecord ? 'disabled' : ''} class="w-full flex items-center justify-center gap-2 p-3 rounded-full bg-white/20 text-white hover:bg-white/30 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        ${ICONS.Microphone({size: 20})}
                        <span>Record Topic</span>
                    </button>
                    ${!canRecord ? '<p class="text-xs text-center text-yellow-300 mt-2">Multimodal audio input is not available in your browser.</p>' : ''}

                    <details class="text-left mt-6">
                        <summary class="cursor-pointer text-sm font-semibold text-white/80">Advanced Options</summary>
                        <div class="mt-3 p-3 bg-black/20 rounded-lg space-y-3">
                             <div class="flex justify-between items-center text-sm">
                                <label for="ai-generate-creativity">Creativity</label>
                                <select id="ai-generate-creativity" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                                    <option value="focused" ${creativity === 'focused' ? 'selected' : ''}>Focused</option>
                                    <option value="balanced" ${creativity === 'balanced' ? 'selected' : ''}>Balanced</option>
                                    <option value="creative" ${creativity === 'creative' ? 'selected' : ''}>Creative</option>
                                </select>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <label for="ai-generate-tone">Tone</label>
                                <select id="ai-generate-tone" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                                    <option value="inspirational" ${tone === 'inspirational' ? 'selected' : ''}>Inspirational</option>
                                    <option value="assertive" ${tone === 'assertive' ? 'selected' : ''}>Assertive</option>
                                    <option value="gentle" ${tone === 'gentle' ? 'selected' : ''}>Gentle</option>
                                    <option value="calm" ${tone === 'calm' ? 'selected' : ''}>Calm</option>
                                </select>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <label for="ai-generate-length">Length</label>
                                <select id="ai-generate-length" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                                    <option value="short" ${length === 'short' ? 'selected' : ''}>Short</option>
                                    <option value="medium" ${length === 'medium' ? 'selected' : ''}>Medium</option>
                                    <option value="long" ${length === 'long' ? 'selected' : ''}>Long</option>
                                </select>
                            </div>
                        </div>
                    </details>
                    <div class="mt-6 text-center">
                        ${renderButton('Generate from Text', { attributes: 'id="ai-generate-submit"' })}
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        const modalElement = document.getElementById(modalId);
        const submitBtn = document.getElementById('ai-generate-submit');
        const recordBtn = document.getElementById('ai-record-topic');
        
        const closeModal = () => modalElement?.remove();
        modalElement.addEventListener('click', (e) => { if(e.target === modalElement) closeModal(); });

        recordBtn.addEventListener('click', startAiTopicRecording);

        submitBtn.addEventListener('click', async () => {
            const topic = document.getElementById('ai-topic-input').value.trim();
            if (!topic) return;
            
            const newCreativity = document.getElementById('ai-generate-creativity').value;
            const newTone = document.getElementById('ai-generate-tone').value;
            const newLength = document.getElementById('ai-generate-length').value;

            state.settings.aiSettings = { creativity: newCreativity, tone: newTone, length: newLength };
            saveState();

            const contentContainer = document.getElementById('ai-generate-content');
            contentContainer.innerHTML = `
                <div class="w-8 h-8 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-white/80">Generating mantras about ${topic}...</p>`;

            const isDemo = state.settings.demoMode.enabled && !state.aiStatus.text;
            
            try {
                const creativityMap = { focused: 0.2, balanced: 0.7, creative: 1.0 };
                const temperature = creativityMap[newCreativity] || 0.7;
                
                const prompt = `Generate 5 positive affirmations about "${topic}". They should have a ${newTone} tone and be ${newLength}. Return the result as a JSON array of strings.`;
                
                const result = isDemo 
                    ? await handleFakeAiGenerate(topic, { creativity: newCreativity, tone: newTone, length: newLength }) 
                    : await (await getAiTextSession()).prompt(prompt, { temperature, outputLanguage: 'en' });
                
                displayGeneratedMantras(result, isDemo);

            } catch (error) {
                console.error("AI Generation failed:", error);
                displayGeneratedMantras(null, isDemo, true);
            }
        });
    }

    async function handleAiAffirmationGenerate() {
        const modalId = 'ai-affirmation-generate-modal';
        const { creativity, tone, length } = state.settings.aiSettings;

        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 animate-fade-in">
                <div class="glass-card w-full max-w-md rounded-2xl p-6 text-center animate-slide-in-up" id="ai-affirmation-generate-content">
                    <h2 class="text-2xl font-serif mb-4">Generate Affirmations</h2>
                    <p class="text-white/80 mb-6">What personal theme would you like to focus on?</p>
                    <input type="text" id="ai-topic-input" placeholder="e.g., self-love, career success" class="w-full p-3 bg-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white mb-4">
                    
                    <details class="text-left mb-4">
                        <summary class="cursor-pointer text-sm font-semibold text-white/80">Advanced Options</summary>
                        <div class="mt-3 p-3 bg-black/20 rounded-lg space-y-3">
                             <div class="flex justify-between items-center text-sm">
                                <label for="ai-generate-creativity">Creativity</label>
                                <select id="ai-generate-creativity" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                                    <option value="focused" ${creativity === 'focused' ? 'selected' : ''}>Focused</option>
                                    <option value="balanced" ${creativity === 'balanced' ? 'selected' : ''}>Balanced</option>
                                    <option value="creative" ${creativity === 'creative' ? 'selected' : ''}>Creative</option>
                                </select>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <label for="ai-generate-tone">Tone</label>
                                <select id="ai-generate-tone" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                                    <option value="inspirational" ${tone === 'inspirational' ? 'selected' : ''}>Inspirational</option>
                                    <option value="assertive" ${tone === 'assertive' ? 'selected' : ''}>Assertive</option>
                                </select>
                            </div>
                        </div>
                    </details>

                    ${renderButton('Generate', { attributes: 'id="ai-affirmation-generate-submit"' })}
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        const modalElement = document.getElementById(modalId);
        const submitBtn = document.getElementById('ai-affirmation-generate-submit');
        
        const closeModal = () => modalElement?.remove();
        modalElement.addEventListener('click', (e) => { if(e.target === modalElement) closeModal(); });

        submitBtn.addEventListener('click', async () => {
            const topic = document.getElementById('ai-topic-input').value.trim();
            if (!topic) return;
            
            const newCreativity = document.getElementById('ai-generate-creativity').value;
            const newTone = document.getElementById('ai-generate-tone').value;

            state.settings.aiSettings.creativity = newCreativity;
            state.settings.aiSettings.tone = newTone;
            saveState();

            const contentContainer = document.getElementById('ai-affirmation-generate-content');
            contentContainer.innerHTML = `
                <div class="w-8 h-8 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-white/80">Generating affirmations about ${topic}...</p>`;

            const isDemo = state.settings.demoMode.enabled && !state.aiStatus.text;
            
            try {
                const creativityMap = { focused: 0.2, balanced: 0.7, creative: 1.0 };
                const temperature = creativityMap[newCreativity] || 0.7;
                
                const prompt = `Generate 5 positive personal affirmations about "${topic}". Make them empowering, present-tense, and personal. Return the result as a JSON array of strings.`;
                
                const result = isDemo 
                    ? await handleFakeAiAffirmationGenerate(topic) 
                    : await (await getAiTextSession()).prompt(prompt, { temperature, outputLanguage: 'en' });
                
                const affirmations = JSON.parse(result);
                
                const modalTitle = isDemo 
                    ? `Generated Affirmations <span class="text-sm text-teal-300">(Simulated)</span>` 
                    : 'Generated Affirmations';
                
                contentContainer.innerHTML = `
                    <h2 class="text-2xl font-serif mb-4">${modalTitle}</h2>
                    <div class="space-y-2 max-h-64 overflow-y-auto text-left mb-4">
                    ${affirmations.map((affirm, index) => `
                        <div class="glass-card p-3 flex justify-between items-center">
                            <p>"${affirm}"</p>
                            <button data-action="add-ai-affirmation" data-text="${String(affirm).replace(' (Simulated)', '')}" class="ml-2 p-2 rounded-full bg-white/20 hover:bg-white/30" aria-label="Add this affirmation" title="Add to My Affirmations">${ICONS.Plus({size: 16})}</button>
                        </div>`).join('')}
                    </div>
                    ${renderButton('Done', { attributes: 'data-action="close-ai-affirmation-modal-final"' })}`;

                contentContainer.querySelector('[data-action="close-ai-affirmation-modal-final"]').addEventListener('click', closeModal);
                contentContainer.querySelectorAll('[data-action="add-ai-affirmation"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const newAffirmation = { id: `affirm-${Date.now()}`, text: e.currentTarget.dataset.text };
                        performAction({ type: 'ADD_AFFIRMATION', payload: { affirmation: newAffirmation }});
                        e.currentTarget.innerHTML = ICONS.Check({size: 16});
                        e.currentTarget.disabled = true;
                    });
                });
            } catch (error) {
                console.error("AI Affirmation Generation failed:", error);
                contentContainer.innerHTML = `
                    <h2 class="text-2xl font-serif mb-4 text-rose-400">Generation Failed</h2>
                    <p class="text-white/80 mb-6">The AI could not generate affirmations for this topic. Please try again.</p>
                    ${renderButton('Close', { attributes: 'data-action="close-ai-affirmation-modal-final"' })}`;
                contentContainer.querySelector('[data-action="close-ai-affirmation-modal-final"]').addEventListener('click', closeModal);
            }
        });
    }

    async function handleAiRewrite(mantraId) {
        const mantra = state.userMantras.find(m => m.id === mantraId);
        if (!mantra) return;

        const isDemo = state.settings.demoMode.enabled && !state.aiStatus.text;
        const modalId = 'ai-rewrite-modal';
        const { creativity, tone } = state.settings.aiSettings;

        const modalTitle = isDemo 
            ? `Rephrase Mantra <span class="text-sm text-teal-300">(Simulated)</span>` 
            : 'Rephrase Mantra';

        const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 animate-fade-in">
                <div class="glass-card w-full max-w-sm rounded-2xl p-6 text-center animate-slide-in-up" id="ai-rewrite-content">
                    <h2 class="text-2xl font-serif mb-4">${modalTitle}</h2>
                    <p class="text-white/70 italic mb-4">"${mantra.text.original}"</p>
                    <div class="text-left mb-4 p-3 bg-black/20 rounded-lg space-y-3">
                         <div class="flex justify-between items-center text-sm">
                            <label for="ai-rewrite-creativity">Creativity</label>
                            <select id="ai-rewrite-creativity" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                                <option value="focused" ${creativity === 'focused' ? 'selected' : ''}>Focused</option>
                                <option value="balanced" ${creativity === 'balanced' ? 'selected' : ''}>Balanced</option>
                                <option value="creative" ${creativity === 'creative' ? 'selected' : ''}>Creative</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <label for="ai-rewrite-tone">Tone</label>
                            <select id="ai-rewrite-tone" class="bg-white/10 border border-white/20 rounded-md p-1 text-sm">
                                <option value="inspirational" ${tone === 'inspirational' ? 'selected' : ''}>Inspirational</option>
                                <option value="assertive" ${tone === 'assertive' ? 'selected' : ''}>Assertive</option>
                                <option value="gentle" ${tone === 'gentle' ? 'selected' : ''}>Gentle</option>
                                <option value="calm" ${tone === 'calm' ? 'selected' : ''}>Calm</option>
                            </select>
                        </div>
                    </div>
                    ${renderButton('Rephrase', { attributes: 'id="ai-rewrite-submit"'})}
                    <button class="text-white/70 block w-full text-center mt-3" data-action="close-rewrite-modal">Cancel</button>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        const modal = document.getElementById(modalId);
        const closeModal = () => modal?.remove();
        modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
        modal.querySelector('[data-action="close-rewrite-modal"]').addEventListener('click', closeModal);
        
        modal.querySelector('#ai-rewrite-submit').addEventListener('click', async () => {
            const contentContainer = document.getElementById('ai-rewrite-content');
            contentContainer.innerHTML = `
                <div class="w-8 h-8 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-white/80">Rephrasing your mantra...</p>`;

            const newCreativity = document.getElementById('ai-rewrite-creativity').value;
            const newTone = document.getElementById('ai-rewrite-tone').value;

            // Save for next time
            state.settings.aiSettings.creativity = newCreativity;
            state.settings.aiSettings.tone = newTone;
            saveState();

            try {
                const creativityMap = { focused: 0.2, balanced: 0.7, creative: 1.0 };
                const temperature = creativityMap[newCreativity] || 0.7;

                const prompt = `Rephrase the following mantra in 3 different ways with a ${newTone} tone: "${mantra.text.original}". Return the result as a JSON array of strings.`;
                
                const result = isDemo
                    ? await handleFakeAiRewrite(mantra.text.original, { creativity: newCreativity, tone: newTone })
                    : await (await getAiTextSession()).prompt(prompt, { temperature, outputLanguage: 'en' });
                
                const options = JSON.parse(result);

                contentContainer.innerHTML = `
                    <h2 class="text-2xl font-serif mb-4">Choose a New Phrasing</h2>
                    <div class="space-y-3 mb-6">
                        ${options.map(opt => `<button class="w-full text-left p-3 bg-white/10 hover:bg-white/20 rounded-lg" data-action="select-rewrite" data-text="${String(opt).replace(' (Simulated)', '')}">"${opt}"</button>`).join('')}
                    </div>
                    <button class="text-white/70" data-action="close-rewrite-modal">Cancel</button>`;
                
                contentContainer.querySelector('[data-action="close-rewrite-modal"]').addEventListener('click', closeModal);
                contentContainer.querySelectorAll('[data-action="select-rewrite"]').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const newText = { original: e.currentTarget.dataset.text, translated: null };
                        performAction({ type: 'UPDATE_MANTRA_TEXT', payload: { mantraId: mantra.id, oldText: mantra.text, newText } });
                        
                        if (state.settings.language !== 'en') {
                            await translateSingleMantra(mantra.id, state.settings.language);
                            saveState();
                            router();
                        }
                        closeModal();
                    });
                });

            } catch (error) {
                console.error("AI Rewrite failed:", error);
                contentContainer.innerHTML = `
                    <h2 class="text-2xl font-serif mb-4 text-rose-400">Rewrite Failed</h2>
                    <p class="text-white/80 mb-6">The AI could not rewrite this mantra. Please try again later.</p>
                    ${renderButton('Close', { attributes: 'data-action="close-rewrite-modal"' })}`;
                contentContainer.querySelector('[data-action="close-rewrite-modal"]').addEventListener('click', closeModal);
            }
        });
    }

    async function handleAiProofread() {
        const textInput = document.getElementById('new-custom-mantra-text');
        const text = textInput.value.trim();
        if (!text) return;

        const proofreadBtn = document.getElementById('proofread-mantra-btn');
        proofreadBtn.disabled = true;
        proofreadBtn.innerHTML = `<span class="w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin inline-block"></span>`;
        const isDemo = state.settings.demoMode.enabled && !state.aiStatus.proofreader;

        try {
            const { correctedText } = isDemo
                ? await handleFakeAiProofread(text)
                : await (await window.ai.proofreader.create()).proofread(text);
            
            const suggestionContainer = document.getElementById('proofread-suggestion');
            const originalText = correctedText.replace(' (Simulated)', '');

            if (originalText.trim() !== text) {
                suggestionContainer.innerHTML = `
                    <span>Suggestion: <i class="font-semibold">"${correctedText}"</i></span>
                    <button data-action="accept-proofread" data-suggestion="${originalText}" class="ml-2 px-2 py-0.5 text-xs rounded-full bg-teal text-white">Accept</button>`;
                suggestionContainer.classList.remove('hidden');
            } else {
                suggestionContainer.innerHTML = `<span>${ICONS.Check({size: 16, className: 'inline'})} Looks good! ${isDemo ? '(Simulated)' : ''}</span>`;
                suggestionContainer.classList.remove('hidden');
                setTimeout(() => suggestionContainer.classList.add('hidden'), 2000);
            }

        } catch (error) {
            console.error("AI Proofread failed:", error);
            renderToast("Proofread failed. Please try again.", false);
        } finally {
            proofreadBtn.disabled = false;
            proofreadBtn.innerHTML = `${ICONS.CheckCircle({size:20, className:'inline-block mr-2'})}Grammar`;
        }
    }

    async function handleAiSuggestPhrasing() {
        const textInput = document.getElementById('new-custom-mantra-text');
        const text = textInput.value.trim();
        if (!text) return;

        const suggestBtn = document.getElementById('suggest-phrasing-btn');
        const suggestionContainer = document.getElementById('ai-suggestion-container');
        
        suggestBtn.disabled = true;
        suggestBtn.innerHTML = `<span class="w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin inline-block"></span>`;
        suggestionContainer.innerHTML = ''; // Clear previous suggestions

        const isDemo = state.settings.demoMode.enabled && !state.aiStatus.text;

        try {
            const prompt = `Generate 3 alternative phrasings for the positive affirmation: "${text}". Keep them concise and empowering. Return the result as a JSON array of strings.`;
            const result = isDemo
                ? await handleFakeAiSuggestPhrasing(text)
                : await (await getAiTextSession()).prompt(prompt, { outputLanguage: 'en' });

            const suggestions = JSON.parse(result);
            
            if (suggestions && suggestions.length > 0) {
                const suggestionHTML = suggestions.map(s => {
                    const cleanText = String(s).replace(' (Simulated)', '');
                    return `<button class="w-full text-left p-3 bg-white/10 hover:bg-white/20 rounded-lg text-sm" data-action="select-suggestion" data-text="${cleanText}">"${s}"</button>`;
                }).join('');
                
                suggestionContainer.innerHTML = `
                    <h4 class="text-sm font-semibold text-white/80">Suggestions${isDemo ? ' (Simulated)' : ''}:</h4>
                    ${suggestionHTML}
                `;
            } else {
                suggestionContainer.innerHTML = `<p class="text-sm text-white/60">No suggestions found. Try a different phrasing.</p>`;
            }

        } catch (error) {
            console.error("AI Suggestion failed:", error);
            suggestionContainer.innerHTML = `<p class="text-sm text-rose-400">Could not get suggestions at this time.</p>`;
        } finally {
            suggestBtn.disabled = false;
            suggestBtn.innerHTML = `${ICONS.Wand2({size:20, className:'inline-block mr-2'})}Suggest`;
        }
    }
    
    async function translateSingleMantra(mantraId, targetLang) {
        const isDemo = state.settings.demoMode.enabled && !state.aiStatus.translator;
        const mantra = state.userMantras.find(m => m.id === mantraId) || CURATED_MANTRAS.find(m => m.id === mantraId);
        if (!mantra) return;

        if (isDemo) {
            mantra.text.translated = `[${targetLang}] ${mantra.text.original} (Simulated)`;
            return;
        }
        
        if (state.aiStatus.translator) {
            try {
                if (!aiTranslator) aiTranslator = await window.ai.translator.create();
                const result = await aiTranslator.translate(mantra.text.original, targetLang);
                mantra.text.translated = result.translatedText;
            } catch (e) {
                console.error(`Failed to translate mantra ${mantraId}:`, e);
            }
        }
    }

    async function handleLanguageChange(newLang) {
        const oldLang = state.settings.language;
        if (oldLang === newLang) return;

        performAction({ type: 'UPDATE_SETTING', payload: { key: 'language', oldValue: oldLang, newValue: newLang } });
        
        if (newLang === 'en') {
            router();
            return;
        }
        
        const isDemo = state.settings.demoMode.enabled && !state.aiStatus.translator;
        if (isDemo) {
            renderLoadingModal(`Simulating translation to ${SUPPORTED_LANGUAGES[newLang]}...`);
            await handleFakeLanguageChange(newLang);
            closeLoadingModal();
            router();
            return;
        }

        renderLoadingModal(`Translating to ${SUPPORTED_LANGUAGES[newLang]}...`);
        
        try {
            if (!aiTranslator) {
                aiTranslator = await window.ai.translator.create();
            }

            const allMantras = [...state.userMantras, ...CURATED_MANTRAS];
            const promises = allMantras.map(async (mantra) => {
                if (!mantra.text.original) return;
                try {
                    const { translatedText } = await aiTranslator.translate(mantra.text.original, newLang);
                    mantra.text.translated = translatedText;
                } catch(e) {
                    console.warn(`Could not translate: "${mantra.text.original}"`, e);
                    mantra.text.translated = mantra.text.original + ' (translation unavailable)';
                }
            });

            await Promise.all(promises);
            saveState();

        } catch (e) {
            console.error("Translation failed:", e);
            renderModal("Translation Failed", "Could not translate mantras. Please try again.");
        } finally {
            closeLoadingModal();
            router();
        }
    }

    async function initAiFeatures() {
        await checkAiStatus();
        
        if (state.settings.language === 'auto') {
            const lang = navigator.language.split('-')[0];
            if (SUPPORTED_LANGUAGES[lang]) {
                state.settings.language = lang;
            } else {
                state.settings.language = 'en';
            }
        }

        if (state.settings.language !== 'en' && state.settings.aiFeatures.enabled) {
            const needsTranslation = CURATED_MANTRAS.some(m => !m.text.translated) || state.userMantras.some(m => !m.text.translated && m.text.original);
            if(needsTranslation) {
                const newLang = state.settings.language;
                const isDemo = state.settings.demoMode.enabled && !state.aiStatus.translator;
                if(isDemo) {
                    await handleFakeLanguageChange(newLang);
                } else if (state.aiStatus.translator) {
                     try {
                        if (!aiTranslator) aiTranslator = await window.ai.translator.create();
                        const allMantras = [...state.userMantras, ...CURATED_MANTRAS];
                        const promises = allMantras.map(async (mantra) => {
                            if (mantra.text.original && !mantra.text.translated) {
                                try {
                                    const { translatedText } = await aiTranslator.translate(mantra.text.original, newLang);
                                    mantra.text.translated = translatedText;
                                } catch(e) { console.warn(`Could not translate: "${mantra.text.original}"`, e); }
                            }
                        });
                        await Promise.all(promises);
                        saveState();
                     } catch(e) { console.error("Initial translation failed", e); }
                }
            }
        }
    }


    // --- INITIALIZATION ---
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        if (window.location.hash.slice(1) === '/settings') {
            renderSettings();
        }
    });

    window.addEventListener('hashchange', () => {
      stopSlideshow();
      if (!audioPlayer.paused) stopPlayback();
      if (currentlyRecordingMantraId) stopRecording();
      undoHistory = []; // Clear history on page navigation
      redoHistory = [];
      router();
    });

    document.addEventListener('DOMContentLoaded', () => {
        // ServiceWorker registration removed to prevent cross-origin errors in hosted environments.
        // Offline capability is handled via localStorage.
        loadState();
        if(!isAudioSupported) {
          state.settings.aiFeatures.enabled = false;
        }
        if (!isAudioSupported) {
            state.settings.voiceFeatures.enabled = false;
        }
        initAiFeatures().then(() => {
            router();
        });
    });

  </script>
</body>
</html>